<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Empire - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ò–º–ø–µ—Ä–∏—è</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        html, body { overflow-x: hidden; max-width: 100vw; }
        .telegram-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .glow { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #3d84a8; } to { box-shadow: 0 0 20px #3d84a8, 0 0 30px #3d84a8; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .mini-notif { 
            animation: miniNotifIn 0.3s ease-out; 
            pointer-events: auto;
            backdrop-filter: blur(8px);
        }
        @keyframes miniNotifIn { 
            from { opacity: 0; transform: translateY(-10px) scale(0.9); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        .mini-notif.fade-out {
            animation: miniNotifOut 0.3s ease-in forwards;
        }
        @keyframes miniNotifOut { 
            from { opacity: 1; transform: translateY(0) scale(1); } 
            to { opacity: 0; transform: translateY(-10px) scale(0.9); } 
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #3d84a8; border-radius: 3px; }
        .modal-overlay { backdrop-filter: blur(5px); }
        .component-card:hover { transform: scale(1.02); }
        .component-card { transition: all 0.2s; }
        input[type="range"] { -webkit-appearance: none; background: #374151; border-radius: 5px; height: 8px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .repair-progress { transition: width 0.1s linear; }
        .device-tab { transition: all 0.2s; }
        .device-tab.active { background: #3b82f6 !important; }
        .notif-panel { max-height: 400px; overflow-y: auto; }
        .notif-badge { 
            position: absolute; top: -5px; right: -5px; 
            min-width: 18px; height: 18px; 
            font-size: 10px; 
        }
        .tab-btn {
            transition: background-color 0.2s ease, transform 0.2s ease, width 0.3s ease, box-shadow 0.3s ease;
            width: 44px;
            justify-content: center;
            gap: 0.35rem;
            flex: 0 0 auto;
        }
        .tab-btn .tab-icon {
            transition: transform 0.2s ease, filter 0.3s ease;
        }
        .tab-btn .tab-label {
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            white-space: nowrap;
            transition: max-width 0.3s ease, opacity 0.3s ease;
        }
        .tab-btn.active-tab {
            width: 148px;
            justify-content: flex-start;
        }
        .tab-btn.active-tab .tab-icon {
            transform: scale(1.05);
        }
        .tab-btn.active-tab .tab-label {
            max-width: 110px;
            opacity: 1;
        }
        .tab-btn.btn-action:hover {
            transform: none;
        }
        .tab-bar {
            overflow-x: auto;
            overflow-y: visible;
            padding-top: 4px;
        }
        .comp-select-btn { transition: background-color 0.2s ease; }
        .comp-select-btn:hover { background-color: rgba(55, 65, 81, 0.9); }
        .comp-menu { max-width: 100%; }
        .comp-option { display: block; }
        .build-select-btn,
        .factory-select-btn {
            transition: background-color 0.2s ease;
        }
        .build-select-btn:hover,
        .factory-select-btn:hover {
            background-color: rgba(55, 65, 81, 0.9);
        }
        .build-select-wrapper,
        .factory-select-wrapper { position: relative; }
        .build-select-menu,
        .factory-select-menu {
            max-height: 220px;
            overflow-y: auto;
        }
        #notifPanel {
            transition: opacity 0.2s ease, transform 0.2s ease;
            opacity: 0;
            transform: translateY(-6px) scale(0.98);
            pointer-events: none;
        }
        #notifPanel.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        
        /* Card System (Drop Cards) */
        :root{
            --tier1:#cbd5e1;
            --tier2:#22c55e;
            --tier3:#38bdf8;
            --tier4:#c084fc;
            --tier5:#fbbf24;
        }

        .line-clamp-3{
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-item{
            position:relative;
            overflow:hidden;
            transform-style:preserve-3d;
            transition: transform 0.22s ease, box-shadow 0.22s ease, filter 0.22s ease;
            will-change: transform;
            isolation:isolate;
        }

        .card-item:hover{
            transform: translateY(-4px) rotateX(3deg);
            box-shadow: 0 18px 46px rgba(0,0,0,0.45);
            filter: saturate(1.10) contrast(1.02);
        }

        /* bright shine */
        .card-item::before{
            content:'';
            position:absolute;
            inset:-2px;
            background: linear-gradient(120deg, rgba(255,255,255,0) 25%, rgba(255,255,255,0.22) 42%, rgba(255,255,255,0) 58%);
            transform: translateX(-120%) skewX(-12deg);
            opacity:0;
            pointer-events:none;
            z-index:1;
        }
        .card-item:hover::before{
            opacity:1;
            animation: cardSweep 0.85s ease;
        }
        @keyframes cardSweep{
            0%{ transform: translateX(-120%) skewX(-12deg); opacity:0; }
            15%{ opacity:1; }
            100%{ transform: translateX(120%) skewX(-12deg); opacity:0.0; }
        }

        /* inner border */
        .card-item::after{
            content:'';
            position:absolute;
            inset:0;
            border-radius:inherit;
            pointer-events:none;
            opacity:0.0;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.10) inset;
            transition: opacity 0.22s ease;
            z-index:2;
        }
        .card-item:hover::after{ opacity:1; }

        /* more vivid rarity backgrounds */
        .card-tier-1{ border-color: rgba(203,213,225,0.65); background: radial-gradient(600px 260px at 20% 0%, rgba(255,255,255,0.12), transparent 55%), linear-gradient(135deg, rgba(100,116,139,0.92) 0%, rgba(15,23,42,0.95) 100%); }
        .card-tier-2{ border-color: rgba(34,197,94,0.70); background: radial-gradient(600px 260px at 20% 0%, rgba(34,197,94,0.22), transparent 55%), linear-gradient(135deg, rgba(34,197,94,0.45) 0%, rgba(5,46,22,0.96) 100%); }
        .card-tier-3{ border-color: rgba(56,189,248,0.78); background: radial-gradient(600px 260px at 20% 0%, rgba(56,189,248,0.24), transparent 55%), linear-gradient(135deg, rgba(56,189,248,0.42) 0%, rgba(7,89,133,0.96) 100%); }
        .card-tier-4{ border-color: rgba(192,132,252,0.78); background: radial-gradient(600px 260px at 20% 0%, rgba(192,132,252,0.26), transparent 55%), linear-gradient(135deg, rgba(192,132,252,0.42) 0%, rgba(59,7,100,0.96) 100%); }
        .card-tier-5{ border-color: rgba(251,191,36,0.86); background: radial-gradient(600px 260px at 20% 0%, rgba(251,191,36,0.30), transparent 55%), linear-gradient(135deg, rgba(251,191,36,0.50) 0%, rgba(120,53,15,0.96) 100%); }

        /* appear animation (snappier + smoother) */
        .card-new{ animation: cardPop 0.62s cubic-bezier(.16,.9,.18,1) both; }
        @keyframes cardPop{
            0%{ opacity:0; transform: translateY(22px) scale(0.90) rotateX(18deg); filter: blur(3px); }
            60%{ opacity:1; transform: translateY(-2px) scale(1.02) rotateX(0deg); filter: blur(0px); }
            100%{ opacity:1; transform: translateY(0px) scale(1) rotateX(0deg); }
        }

        /* chips */
        .rarity-chip{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:2px 8px;
            border-radius:999px;
            font-size:11px;
            font-weight:900;
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.16);
            color: rgba(255,255,255,0.92);
            backdrop-filter: blur(10px);
        }
        .qty-chip{
            display:inline-flex;
            align-items:center;
            padding:2px 8px;
            border-radius:999px;
            font-size:11px;
            font-weight:800;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.14);
            color: rgba(255,255,255,0.92);
            backdrop-filter: blur(10px);
        }
        .comp-chip{
            display:inline-flex;
            width: fit-content;
            max-width: 100%;
            align-items:center;
            padding:2px 8px;
            border-radius:999px;
            font-size:10px;
            font-weight:800;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.88);
            white-space: normal;
            overflow: hidden;
            overflow-wrap: anywhere;
        }

        .stat-pill{
            background: rgba(0,0,0,0.20);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            padding: 6px 8px;
            min-width: 0;
            overflow: hidden;
        }

        .comp-chip{
            display:-webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            align-items:center;
            padding:2px 8px;
            border-radius:999px;
            font-size:10px;
            font-weight:800;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.88);
            max-width: 52%;
            overflow: hidden;
            white-space: normal;
        }

        /* Light theme tweaks for drop cards */
        .light-theme .card-tier-1{ border-color: rgba(148,163,184,0.55); background: radial-gradient(600px 260px at 20% 0%, rgba(59,130,246,0.10), transparent 58%), linear-gradient(135deg, rgba(241,245,249,0.98) 0%, rgba(226,232,240,0.98) 100%); }
        .light-theme .card-tier-2{ border-color: rgba(34,197,94,0.55); background: radial-gradient(600px 260px at 20% 0%, rgba(34,197,94,0.10), transparent 58%), linear-gradient(135deg, rgba(220,252,231,0.98) 0%, rgba(187,247,208,0.98) 100%); }
        .light-theme .card-tier-3{ border-color: rgba(56,189,248,0.60); background: radial-gradient(600px 260px at 20% 0%, rgba(56,189,248,0.12), transparent 58%), linear-gradient(135deg, rgba(224,242,254,0.98) 0%, rgba(186,230,253,0.98) 100%); }
        .light-theme .card-tier-4{ border-color: rgba(192,132,252,0.60); background: radial-gradient(600px 260px at 20% 0%, rgba(192,132,252,0.12), transparent 58%), linear-gradient(135deg, rgba(243,232,255,0.98) 0%, rgba(233,213,255,0.98) 100%); }
        .light-theme .card-tier-5{ border-color: rgba(251,191,36,0.65); background: radial-gradient(600px 260px at 20% 0%, rgba(251,191,36,0.14), transparent 58%), linear-gradient(135deg, rgba(255,251,235,0.99) 0%, rgba(254,243,199,0.99) 100%); }
        .light-theme .rarity-chip,
        .light-theme .qty-chip,
        .light-theme .comp-chip{ background: rgba(255,255,255,0.78); border-color: rgba(2,6,23,0.10); color: rgba(15,23,42,0.90); }
        .light-theme .stat-pill{ background: rgba(255,255,255,0.78); border-color: rgba(2,6,23,0.10); }
        .light-theme .stat-pill{ background: rgba(255,255,255,0.78); border-color: rgba(2,6,23,0.10); }

        /* Unique / Exclusive marker */
        .unique-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 800;
            background: rgba(251, 191, 36, 0.22);
            border: 1px solid rgba(251, 191, 36, 0.45);
            color: rgba(254, 243, 199, 0.98);
        }
        .card-exclusive {
            box-shadow: 0 0 0 1px rgba(251,191,36,0.30) inset, 0 16px 44px rgba(251,191,36,0.12);
        }
        .card-exclusive:hover{
            box-shadow: 0 0 0 1px rgba(251,191,36,0.45) inset, 0 20px 54px rgba(251,191,36,0.20);
        }

        /* Horizontal drop rows (compact + no overflow) */
        .drop-row{
            position:relative;
            overflow:hidden;
            border-radius: 16px;
            border: 1px solid var(--rowBorder, rgba(255,255,255,0.12));
            background: var(--rowBg, rgba(17,24,39,0.55));
            backdrop-filter: blur(10px);

            /* title row spans full width, details row has left + price */
            display:grid;
            grid-template-columns: minmax(0, 1fr) 112px;
            grid-template-rows: auto auto;
            gap: 8px;
            padding: 10px;

            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, filter 0.18s ease;
            box-shadow: 0 14px 32px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.05) inset;
        }

        .drop-row .left-col{ max-width: calc(100% - 0px); }

        .drop-row .left-col{
            min-width:0;
            position:relative;
            z-index:2;
            display:flex;
            flex-direction:column;
            gap:6px;
            grid-column: 1 / 2;
            grid-row: 2 / 3;
        }

        .drop-row .titleline{
            display:flex;
            flex-wrap: nowrap;
            align-items:center;
            gap:8px;
            min-width:0;
            grid-column: 1 / -1;
            grid-row: 1 / 2;
            overflow-x: auto;
        }
        .drop-row .titleline::-webkit-scrollbar{ height: 0; }

        .drop-row::before{
            content:'';
            position:absolute;
            inset:-2px;
            background: radial-gradient(600px 260px at 20% 10%, rgba(255,255,255,0.18), transparent 55%);
            opacity: 0.55;
            pointer-events:none;
        }
        .drop-row:hover{
            transform: translateY(-2px);
            box-shadow: 0 18px 44px rgba(0,0,0,0.42), 0 0 0 1px rgba(255,255,255,0.08) inset, var(--rowGlow, 0 0 0 rgba(0,0,0,0));
            filter: saturate(1.08) contrast(1.02);
        }

        .drop-row .tier-strip{ display:none; }

        .drop-row .value-box{
            width: 104px;
            max-width: 104px;
            justify-self: end;

            text-align: center;
            padding: 8px 8px;
            border-radius: 12px;
            background: rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.14);
            position: relative;
            z-index: 2;
            align-self: center;
            margin-top: 0;

            display:flex;
            flex-direction:column;
            gap: 6px;
            grid-column: 2 / 3;
            grid-row: 2 / 3;
        }
        .drop-row .comp-chip{
            max-width: 100%;
            -webkit-line-clamp: 2;
        }

        .drop-row .value-price{
            font-weight: 950;
            font-size: 12.5px;
            line-height: 1.1;
            color: rgba(253, 224, 71, 0.95);
            text-shadow: 0 8px 20px rgba(0,0,0,0.35);
        }

        .drop-row .value-sub{
            font-size: 10px;
            color: rgba(255,255,255,0.75);
        }

        .drop-row .sell-btn{
            width: 100%;
            font-size: 11px;
            font-weight: 950;
            padding: 6px 8px;
            border-radius: 10px;
        }

        .drop-row .title{
            flex: 1 1 auto;
            min-width: 0;
            max-width: 100%;
            font-weight: 900;
            font-size: 12px;
            line-height: 1.2;
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            text-overflow: unset;
        }
        .drop-row .title::-webkit-scrollbar{ height: 0; }

        .drop-row .chips{
            display:flex;
            flex-wrap:wrap;
            gap: 5px;
            min-width: 0;
        }
        .drop-row .chips > *{ min-width: 0; }

        .drop-row .stats{
            display:flex;
            flex-wrap:wrap;
            gap: 6px;
            min-width: 0;
            font-size: 11px;
        }
        .drop-row .stat{
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(0,0,0,0.20);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.92);
            min-width: 0;
        }
        .drop-row .stat span:first-child{ color: rgba(255,255,255,0.72); }
        .drop-row .stat span:last-child{ font-weight: 900; }

        .drop-row .stat-row{
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .drop-row .stat-pill{
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(0,0,0,0.20);
            border: 1px solid rgba(255,255,255,0.12);
            align-self: flex-start;
            width: fit-content;
        }


        @media (max-width: 520px){
            .drop-row{
                grid-template-columns: minmax(0, 1fr) 112px;
                grid-template-rows: auto auto;
                gap: 8px;
            }
            .drop-row .value-box{
                justify-self: end;
                width: 112px;
                max-width: 112px;
                grid-row: 2 / 3;
            }
        }

        /* Make the whole row bright by rarity (reuse the old vivid palette) */
        .drop-tier-1{ 
            --tierColor: var(--tier1);
            --rowBorder: rgba(203,213,225,0.45);
            --rowGlow: 0 0 28px rgba(203,213,225,0.10);
            --rowBg: radial-gradient(900px 360px at 18% 0%, rgba(255,255,255,0.10), transparent 55%),
                     linear-gradient(135deg, rgba(100,116,139,0.85) 0%, rgba(15,23,42,0.96) 100%);
        }
        .drop-tier-2{ 
            --tierColor: var(--tier2);
            --rowBorder: rgba(34,197,94,0.55);
            --rowGlow: 0 0 34px rgba(34,197,94,0.18);
            --rowBg: radial-gradient(900px 360px at 18% 0%, rgba(34,197,94,0.20), transparent 55%),
                     linear-gradient(135deg, rgba(34,197,94,0.42) 0%, rgba(5,46,22,0.96) 100%);
        }
        .drop-tier-3{ 
            --tierColor: var(--tier3);
            --rowBorder: rgba(56,189,248,0.60);
            --rowGlow: 0 0 38px rgba(56,189,248,0.20);
            --rowBg: radial-gradient(900px 360px at 18% 0%, rgba(56,189,248,0.22), transparent 55%),
                     linear-gradient(135deg, rgba(56,189,248,0.38) 0%, rgba(7,89,133,0.96) 100%);
        }
        .drop-tier-4{ 
            --tierColor: var(--tier4);
            --rowBorder: rgba(192,132,252,0.62);
            --rowGlow: 0 0 42px rgba(192,132,252,0.22);
            --rowBg: radial-gradient(900px 360px at 18% 0%, rgba(192,132,252,0.22), transparent 55%),
                     linear-gradient(135deg, rgba(192,132,252,0.40) 0%, rgba(59,7,100,0.96) 100%);
        }
        .drop-tier-5{ 
            --tierColor: var(--tier5);
            --rowBorder: rgba(251,191,36,0.70);
            --rowGlow: 0 0 54px rgba(251,191,36,0.22);
            --rowBg: radial-gradient(900px 360px at 18% 0%, rgba(251,191,36,0.26), transparent 55%),
                     linear-gradient(135deg, rgba(251,191,36,0.44) 0%, rgba(120,53,15,0.96) 100%);
        }

        .drop-row-exclusive{
            border-color: rgba(251,191,36,0.75);
            box-shadow: 0 18px 44px rgba(0,0,0,0.42), 0 0 0 1px rgba(251,191,36,0.22) inset, 0 0 58px rgba(251,191,36,0.18);
        }

        .drop-row-new{ animation: dropRowIn 0.45s cubic-bezier(.16,.9,.18,1) both; }
        @keyframes dropRowIn{
            0%{ opacity:0; transform: translateY(10px); filter: blur(2px); }
            100%{ opacity:1; transform: translateY(0px); filter: blur(0px); }
        }

        .light-theme .drop-row{
            background: rgba(255,255,255,0.92);
            border-color: rgba(2,6,23,0.10);
            box-shadow: 0 12px 30px rgba(2,6,23,0.10);
        }
        .light-theme .drop-row .value-box{
            background: rgba(2,6,23,0.04);
            border-color: rgba(2,6,23,0.10);
        }

        /* Home hero card */
        .home-hero {
            border: 1px solid rgba(255,255,255,0.10);
        }

        .category-btn {
            transition: all 0.2s ease;
        }
        .category-btn.selected {
            ring: 2px;
            ring-color: #3b82f6;
            transform: scale(1.05);
        }

        /* Theme */
        .light-theme {
            /* –º—è–≥–∫–∏–π, ‚Äú—á–∏—Å—Ç—ã–π‚Äù —Ñ–æ–Ω —Å –ª—ë–≥–∫–∏–º –≥–æ–ª—É–±—ã–º –æ—Ç—Ç–µ–Ω–∫–æ–º */
            background: radial-gradient(1200px 600px at 20% 0%, rgba(59,130,246,0.14), transparent 55%),
                        radial-gradient(900px 500px at 100% 10%, rgba(168,85,247,0.12), transparent 60%),
                        linear-gradient(135deg, #f8fafc 0%, #eff6ff 45%, #ecfeff 100%) !important;
            color: #0f172a;
        }

        /* –±–∞–∑–æ–≤—ã–µ ‚Äú–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏‚Äù */
        .light-theme .surface {
            background: rgba(255,255,255,0.92) !important;
            border: 1px solid rgba(2, 6, 23, 0.10);
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.10);
        }

        /* —Ç–µ–∫—Å—Ç */
        .light-theme .text-white { color: #0f172a !important; }
        .light-theme .text-gray-400 { color: rgba(15, 23, 42, 0.68) !important; }
        .light-theme .text-gray-500 { color: rgba(15, 23, 42, 0.58) !important; }
        .light-theme .text-gray-300 { color: rgba(15, 23, 42, 0.78) !important; }
        .light-theme .text-blue-300 { color: rgba(37, 99, 235, 0.80) !important; }

        /* –∑–∞–º–µ–Ω—ã ‚Äú—Å–µ—Ä—ã—Ö‚Äù –±–ª–æ–∫–æ–≤ Tailwind –Ω–∞ —Å–≤–µ—Ç–ª—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .light-theme .bg-gray-700\/50 {
            background-color: rgba(255, 255, 255, 0.70) !important;
            border: 1px solid rgba(2, 6, 23, 0.08);
        }
        .light-theme .bg-gray-800\/50 {
            background-color: rgba(255, 255, 255, 0.78) !important;
            border: 1px solid rgba(2, 6, 23, 0.08);
        }
        .light-theme .bg-gray-700 {
            background-color: rgba(2, 6, 23, 0.06) !important;
        }
        .light-theme .bg-gray-800 {
            background-color: rgba(255, 255, 255, 0.88) !important;
            border: 1px solid rgba(2, 6, 23, 0.10);
        }
        .light-theme .bg-gray-900 {
            background-color: rgba(255, 255, 255, 0.96) !important;
            border: 1px solid rgba(2, 6, 23, 0.10);
        }
        .light-theme .bg-gray-900\/95 {
            background-color: rgba(255, 255, 255, 0.96) !important;
        }

        .light-theme .border-gray-700\/50 { border-color: rgba(2, 6, 23, 0.12) !important; }
        .light-theme .border-gray-700 { border-color: rgba(2, 6, 23, 0.14) !important; }

        /* –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é (–∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã) */
        .light-theme .comp-menu,
        .light-theme .build-select-menu,
        .light-theme .factory-select-menu {
            background: rgba(255,255,255,0.98) !important;
            border-color: rgba(2, 6, 23, 0.12) !important;
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.14);
        }
        .light-theme .comp-option:hover,
        .light-theme .build-select-menu button:hover,
        .light-theme .factory-select-menu button:hover {
            background: rgba(37, 99, 235, 0.08) !important;
        }

        /* –∏–Ω–ø—É—Ç—ã */
        .light-theme input,
        .light-theme textarea {
            color: #0f172a;
        }
        .light-theme input::placeholder,
        .light-theme textarea::placeholder {
            color: rgba(15, 23, 42, 0.45);
        }

        /* range */
        .light-theme input[type="range"] { background: rgba(2, 6, 23, 0.12); }
        .light-theme input[type="range"]::-webkit-slider-thumb { background: #2563eb; }

        /* —Å–∫—Ä–æ–ª–ª */
        .light-theme ::-webkit-scrollbar-track { background: rgba(2, 6, 23, 0.06); }
        .light-theme ::-webkit-scrollbar-thumb { background: rgba(37, 99, 235, 0.70); }

        /* tier-–∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ ‚Äî –±–æ–ª–µ–µ –º—è–≥–∫–∏–µ */
        .light-theme .card-tier-1 { border-color: #94a3b8; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); }
        .light-theme .card-tier-2 { border-color: #22c55e; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); }
        .light-theme .card-tier-3 { border-color: #3b82f6; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .light-theme .card-tier-4 { border-color: #a855f7; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); }
        .light-theme .card-tier-5 { border-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }

        /* —á—Ç–æ–±—ã ‚Äú—Å–∏–Ω–∏–µ/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ‚Äù –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —á–∏—Ç–∞–ª–∏—Å—å */
        .light-theme .btn-action { box-shadow: none; }
        .light-theme .btn-action:hover { box-shadow: 0 10px 24px rgba(2,6,23,0.12); }
    </style>
</head>
<body class="telegram-bg min-h-screen text-white">
    <!-- Mini Notifications (toast) -->
    <div id="toastContainer" class="fixed top-16 right-4 z-50 space-y-1 pointer-events-none" style="max-width: 280px;"></div>

    <!-- Notification Panel (attached to header) -->
    <div id="notifPanel" class="hidden fixed top-16 right-4 z-50 w-80 bg-gray-900/95 backdrop-blur-md rounded-xl shadow-2xl border border-gray-700/50 overflow-hidden">
        <div class="flex justify-between items-center p-3 border-b border-gray-700/50">
            <span class="font-bold text-sm">üìã –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            <div class="flex items-center gap-2">
                <button onclick="clearAllNotifs()" class="text-xs text-gray-400 hover:text-red-400">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <span class="w-px h-4 bg-gray-700/70"></span>
                <button onclick="toggleNotifPanel()" class="text-xs text-gray-400 hover:text-white" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            </div>
        </div>
        <div id="notifList" class="notif-panel p-2 space-y-1">
            <p class="text-gray-500 text-center text-xs py-4">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
        </div>
    </div>

    <div class="container mx-auto max-w-6xl p-4 overflow-x-hidden">
        <!-- Header -->
        <header class="bg-gray-900/80 surface rounded-2xl p-3 mb-4 flex flex-col gap-2">
            <div class="flex items-center justify-between gap-2 min-w-0">
                <div class="flex items-center gap-2 min-w-0">
                    <div id="appLogo" class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-xl glow flex-shrink-0 cursor-pointer select-none" title="Tech Empire">üè≠</div>
                    <div class="min-w-0">
                        <h1 class="text-lg font-bold whitespace-nowrap">Tech Empire</h1>
                        <p class="text-gray-400 text-xs truncate max-w-[160px]" id="companyName">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é</p>
                    </div>
                </div>

                <!-- Money / Day (returned to header) -->
                <div id="headerStats" class="hidden text-right flex-shrink-0">
                    <div class="text-green-400 font-bold text-sm" id="moneyDisplay">$0</div>
                    <div class="text-gray-400 text-[11px]">–î–µ–Ω—å: <span class="font-bold" id="dayDisplay">1</span></div>
                </div>
            </div>
            <div id="headerActions" class="hidden flex items-center justify-between gap-2">
                <button onclick="nextDay()" id="nextDayBtn" class="btn-action bg-gradient-to-r from-orange-500 to-red-600 px-3 py-1.5 rounded-lg font-bold text-sm whitespace-nowrap">
                    ‚è≠Ô∏è –°–ª–µ–¥. –¥–µ–Ω—å
                </button>
                <button id="notifBtn" onclick="toggleNotifPanel()" class="relative btn-action bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg transition-all">
                    <span class="text-sm">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    <span id="notifBadge" class="notif-badge hidden bg-red-500 text-white rounded-full flex items-center justify-center font-bold">0</span>
                </button>
            </div>
        </header>

        <!-- Stats Bar moved to Home tab -->

        <!-- Main Content -->
        <div class="bg-gray-900/60 surface rounded-2xl p-4 min-h-[500px]" id="mainContent">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="text-center py-10">
                <div class="text-6xl mb-4">üöÄ</div>
                <h2 class="text-3xl font-bold mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Tech Empire!</h2>
                <p class="text-gray-400 mb-6">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –∏–º–ø–µ—Ä–∏—é</p>
                <button onclick="showCreateCompany()" class="btn-action bg-gradient-to-r from-blue-500 to-purple-600 px-8 py-3 rounded-xl font-bold text-lg mb-3">
                    üè¢ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
                </button>
            </div>

            <!-- Create Company Screen -->
            <div id="createCompanyScreen" class="hidden slide-in">
                <h2 class="text-2xl font-bold mb-6 text-center">üè¢ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</h2>
                <div class="max-w-md mx-auto space-y-4">
                    <div>
                        <label class="block text-gray-400 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                        <input type="text" id="companyNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: TechFlow" 
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                    </div>
                    <button onclick="createCompany()" class="btn-action w-full bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-3 rounded-xl font-bold">
                        ‚úÖ –û—Å–Ω–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
                    </button>
                </div>
            </div>

            <!-- Main Game Screen -->
            <div id="gameScreen" class="hidden">
                <div class="tab-bar flex flex-nowrap gap-1.5 mb-4 border-b border-gray-700 pb-3">
                    <button onclick="showTab('home')" class="tab-btn btn-action bg-blue-600 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="home" data-label="–ì–ª–∞–≤–Ω–∞—è"><span class="tab-icon">üè†</span><span class="tab-label">–ì–ª–∞–≤–Ω–∞—è</span></button>
                    <button onclick="showTab('production')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="production" data-label="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ"><span class="tab-icon">üè≠</span><span class="tab-label">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</span></button>
                    <button onclick="showTab('components')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="components" data-label="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã"><span class="tab-icon">üß©</span><span class="tab-label">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</span></button>
                    <button onclick="showTab('factory')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="factory" data-label="–§–∞–±—Ä–∏–∫–∞"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">–§–∞–±—Ä–∏–∫–∞</span></button>
                    <button onclick="showTab('repair')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="repair" data-label="–†–µ–º–æ–Ω—Ç"><span class="tab-icon">üîß</span><span class="tab-label">–†–µ–º–æ–Ω—Ç</span></button>
                    <button onclick="showTab('contracts')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="contracts" data-label="–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã"><span class="tab-icon">üìú</span><span class="tab-label">–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</span></button>
                    <button onclick="showTab('rnd')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="rnd" data-label="–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"><span class="tab-icon">üî¨</span><span class="tab-label">–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</span></button>
                    <button onclick="showTab('marketing')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="marketing" data-label="–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥"><span class="tab-icon">üì¢</span><span class="tab-label">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</span></button>
                    <button onclick="showTab('staff')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="staff" data-label="–ü–µ—Ä—Å–æ–Ω–∞–ª"><span class="tab-icon">üë•</span><span class="tab-label">–ü–µ—Ä—Å–æ–Ω–∞–ª</span></button>
                    <button onclick="showTab('market')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="market" data-label="–ü—Ä–æ–¥–∞–∂–∏"><span class="tab-icon">üõí</span><span class="tab-label">–ü—Ä–æ–¥–∞–∂–∏</span></button>
                    <button onclick="showTab('warehouse')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="warehouse" data-label="–°–∫–ª–∞–¥"><span class="tab-icon">üì¶</span><span class="tab-label">–°–∫–ª–∞–¥</span></button>
                    <button onclick="showTab('meta')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="meta" data-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"><span class="tab-icon">üìà</span><span class="tab-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></button>
                    <button onclick="showTab('buyouts')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="buyouts" data-label="–í—ã–∫—É–ø"><span class="tab-icon">ü§ù</span><span class="tab-label">–í—ã–∫—É–ø</span></button>
                    <button onclick="showTab('settings')" class="tab-btn btn-action bg-gray-700 px-2 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap flex items-center" data-tab="settings" data-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
                </div>
                <div id="tabContent" class="slide-in"></div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/70 modal-overlay z-40 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 slide-in">
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // ==================== SAVE SYSTEM ====================
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length));
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        }

        // ==================== GAME STATE ====================
        let gameState = {
            companyName: '',
            money: 100000,
            day: 1,
            reputation: 50,
            level: 1,
            experience: 0,
            products: [],
            inventory: {},
            customComponents: [],
            brokenDevices: [],
            repairingDevices: [],
            repairedDevices: [],
            sellingProducts: [],
            employees: { engineers: 0, marketers: 0, repairmen: 0, researchers: 0 },
            activeContracts: [],
            availableContracts: [],
            researchedTech: [],
            currentResearch: null,
            researchProgress: 0,
            activeResearch: [],
            marketingCampaigns: [],
            brandAwareness: 10,
            factoryLevel: 1,
            productionCapacity: 10000,
            totalSales: 0,
            totalProduced: 0,
            totalRepaired: 0,
            // Card System
            lastCardClaim: 0,
            cardCollection: [],
            selectedCardCategory: 'smartphone',
            // Dev / Settings
            devMenuUnlocked: false,
            devSkipCardCooldown: false,
            darkTheme: true,

            // Meta systems: quests/achievements/market/reviews/events
            unlockedAchievements: [],
            dailyQuests: [],
            weeklyQuests: [],
            lastQuestDay: 0,
            lastQuestWeek: 0,
            reviews: [],
            avgRating: 3.5,
            reviewCount: 0,
            newsLog: [],
            priceModifiers: [], // active effects/events (daysLeft-based)
            cardsReceivedTotal: 0,
            totalUnitsSold: 0,
            investorDeal: null,
            market: {
                yourShare: 10,
                competitors: []
            }
        };

        // ==================== DEV MENU (LOGO CLICKS) ====================
        let __devClickCount = 0;
        let __devClickTimer = null;
        function initDevLogo() {
            const logo = document.getElementById('appLogo');
            if (!logo) return;
            logo.addEventListener('click', () => {
                __devClickCount++;
                clearTimeout(__devClickTimer);
                __devClickTimer = setTimeout(() => { __devClickCount = 0; }, 1600);

                if (__devClickCount >= 10) {
                    __devClickCount = 0;
                    if (!gameState.devMenuUnlocked) {
                        gameState.devMenuUnlocked = true;
                        saveGame();
                        notify('üõ†Ô∏è –ú–µ–Ω—é —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–≤–∫–ª–∞–¥–∫–∞ ¬´–ì–ª–∞–≤–Ω–∞—è¬ª)!', 'success');
                        const activeTab = document.querySelector('.tab-btn.bg-blue-600');
                        if (activeTab?.dataset.tab === 'home') renderHome();
                    } else {
                        notify('üõ†Ô∏è –ú–µ–Ω—é —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —É–∂–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ', 'info');
                    }
                }
            });
        }

        function devGrantMoney(amount = 1000000) {
            const add = Number(amount || 0);
            if (!Number.isFinite(add) || add <= 0) return;
            gameState.money += add;
            updateUI();
            notify(`üß™ Dev: +${formatMoney(add)}`, 'success');
        }

        function devToggleSkipCardCooldown(isOn) {
            gameState.devSkipCardCooldown = !!isOn;
            saveGame();
            updateCardUI();
            notify(`üß™ Dev: –ø—Ä–æ–ø—É—Å–∫ –æ–∂–∏–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ ${gameState.devSkipCardCooldown ? '–í–ö–õ' : '–í–´–ö–õ'}`, 'info');
        }
        
        // ==================== CARD DROP SYSTEM ====================
        const CARD_DROP_INTERVAL = 60 * 60 * 1000; // 1 hour in milliseconds
        const CARDS_PER_DROP = 3;
        
        const CARD_CATEGORIES = {
            smartphone: { name: 'üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã', icon: 'üì±', components: ['processor_mobile', 'display_mobile', 'battery_mobile', 'camera_main', 'camera_ultra', 'camera_tele', 'camera_front', 'memory_mobile', 'body_mobile', 'sensors', 'modem'] },
            tablet: { name: 'üì≤ –ü–ª–∞–Ω—à–µ—Ç—ã', icon: 'üì≤', components: ['processor_mobile', 'display_tablet', 'battery_tablet', 'camera_main', 'camera_ultra', 'camera_front', 'memory_mobile', 'body_tablet', 'sensors', 'speakers'] },
            laptop: { name: 'üíª –ù–æ—É—Ç–±—É–∫–∏', icon: 'üíª', components: ['processor_desktop', 'gpu', 'display_laptop', 'battery_laptop', 'memory_desktop', 'storage', 'body_laptop', 'keyboard', 'touchpad', 'webcam'] },
            desktop: { name: 'üñ•Ô∏è –ü–ö', icon: 'üñ•Ô∏è', components: ['processor_desktop', 'gpu', 'motherboard', 'memory_desktop', 'storage', 'psu', 'cooling', 'case'] },
            smartwatch: { name: '‚åö –ß–∞—Å—ã', icon: '‚åö', components: ['processor_wearable', 'display_watch', 'battery_watch', 'sensors_watch', 'body_watch', 'strap'] },
            headphones: { name: 'üéß –ù–∞—É—à–Ω–∏–∫–∏', icon: 'üéß', components: ['drivers', 'battery_headphones', 'bluetooth', 'body_headphones', 'cushions', 'microphone'] },
            tv: { name: 'üì∫ –¢–í', icon: 'üì∫', components: ['display_tv', 'processor_tv', 'speakers_tv', 'smart_module', 'body_tv', 'stand'] },
            console: { name: 'üéÆ –ö–æ–Ω—Å–æ–ª–∏', icon: 'üéÆ', components: ['processor_console', 'gpu_console', 'memory_console', 'storage_console', 'body_console', 'cooling_console', 'controller'] },
            refrigerator: { name: 'üßä –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏', icon: 'üßä', components: ['compressor', 'motor', 'controls_appliance', 'body_appliance', 'insulation', 'shelves'] },
            washer: { name: 'üß∫ –°—Ç–∏—Ä–∞–ª–∫–∏', icon: 'üß∫', components: ['motor_washer', 'drum', 'controls_appliance', 'body_appliance', 'pump', 'heater'] },
            aircon: { name: '‚ùÑÔ∏è –ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã', icon: '‚ùÑÔ∏è', components: ['compressor_ac', 'fan', 'controls_appliance', 'body_appliance', 'filter', 'refrigerant'] },
            vacuum: { name: 'üßπ –ü—ã–ª–µ—Å–æ—Å—ã', icon: 'üßπ', components: ['motor_vacuum', 'battery_vacuum', 'filter_vacuum', 'body_vacuum', 'brush', 'sensors_vacuum'] }
        };
        
        function getTierName(tier) {
            const names = { 1: '–û–±—ã—á–Ω—ã–π', 2: '–ù–µ–æ–±—ã—á–Ω—ã–π', 3: '–†–µ–¥–∫–∏–π', 4: '–≠–ø–∏—á–µ—Å–∫–∏–π', 5: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' };
            return names[Number(tier) || 1] || '–û–±—ã—á–Ω—ã–π';
        }

        function stripTierPrefix(name) {
            // Remove legacy rarity prefixes if they exist in a string.
            return String(name || '').replace(/^(Common|Uncommon|Rare|Epic|Legendary|–û–±—ã—á–Ω—ã–π|–ù–µ–æ–±—ã—á–Ω—ã–π|–†–µ–¥–∫–∏–π|–≠–ø–∏—á–µ—Å–∫–∏–π|–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π)\s+/i, '');
        }
        
        function getTierColor(tier) {
            const colors = { 1: 'gray', 2: 'green', 3: 'blue', 4: 'purple', 5: 'yellow' };
            return colors[tier] || 'gray';
        }
        
        function canClaimCards() {
            if (gameState.devSkipCardCooldown) return true;
            const now = Date.now();
            const lastClaim = gameState.lastCardClaim || 0;
            return (now - lastClaim) >= CARD_DROP_INTERVAL;
        }
        
        function getTimeUntilNextClaim() {
            if (gameState.devSkipCardCooldown) return 0;
            const now = Date.now();
            const lastClaim = gameState.lastCardClaim || 0;
            const timeSinceClaim = now - lastClaim;
            const timeRemaining = CARD_DROP_INTERVAL - timeSinceClaim;
            return Math.max(0, timeRemaining);
        }
        
        function formatTimeRemaining(ms) {
            if (ms <= 0) return '–î–æ—Å—Ç—É–ø–Ω–æ!';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}–º ${seconds}—Å`;
        }
        
        function generateRandomCard(category) {
            const cat = CARD_CATEGORIES[category];
            if (!cat) return null;
            
            // Pick random component type from category
            const compType = cat.components[Math.floor(Math.random() * cat.components.length)];
            const compData = COMPONENTS[compType];
            if (!compData || !compData.items) return null;
            
            // Limit card tier by unlocked tech tier
            const maxAllowedTier = Math.max(1, Math.min(5, getMaxTier()));
            const tierWeights = { 1: 0.45, 2: 0.30, 3: 0.15, 4: 0.07, 5: 0.03 };
            const allowedTiers = [];
            let totalW = 0;
            for (let t = 1; t <= maxAllowedTier; t++) { allowedTiers.push(t); totalW += (tierWeights[t] || 0); }

            let roll = Math.random() * totalW;
            let tier = allowedTiers[0] || 1;
            for (const t of allowedTiers) {
                roll -= (tierWeights[t] || 0);
                if (roll <= 0) { tier = t; break; }
            }
            
            // Get items of this tier
            const tierItems = compData.items.filter(item => item.tier === tier);
            if (tierItems.length === 0) {
                // Fallback to any available item
                const item = compData.items[Math.floor(Math.random() * compData.items.length)];
                return createCard(compType, item);
            }
            
            const item = tierItems[Math.floor(Math.random() * tierItems.length)];
            return createCard(compType, item, { allowExclusive: true });
        }
        
        function rollCardQty(tier) {
            const t = Number(tier || 1);
            const min = 100;
            const maxByTier = { 1: 1200, 2: 900, 3: 650, 4: 420, 5: 260 };
            const powByTier = { 1: 0.85, 2: 1.15, 3: 1.8, 4: 2.6, 5: 3.4 };
            const max = maxByTier[t] || 600;
            const pow = powByTier[t] || 1.6;

            // –ß–µ–º –≤—ã—à–µ tier, —Ç–µ–º –±–æ–ª—å—à–µ —Å—Ç–µ–ø–µ–Ω—å => —Ç–µ–º –±–ª–∏–∂–µ r –∫ 0 => —Ç–µ–º –º–µ–Ω—å—à–µ –ø–∞—Ä—Ç–∏—è –≤ —Å—Ä–µ–¥–Ω–µ–º.
            const r = Math.pow(Math.random(), pow);
            const raw = min + Math.round((max - min) * r);

            // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —É–¥–æ–±–Ω—ã—Ö —á–∏—Å–µ–ª
            const step = t >= 4 ? 5 : 10;
            return Math.max(min, Math.round(raw / step) * step);
        }

        function randomSerial() {
            const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            const a = letters[Math.floor(Math.random() * letters.length)];
            const b = letters[Math.floor(Math.random() * letters.length)];
            const n = Math.floor(100 + Math.random() * 900);
            return `${a}${b}-${n}`;
        }

        function generateExclusiveComponentName(compType, item, tier) {
            const groups = {
                processor_mobile: { a: ['Orion', 'Astra', 'Nova', 'Quantum', 'Neuro', 'Hyper'], b: ['Core', 'SoC', 'Silicon', 'Engine'], c: ['X', 'Pro', 'Ultra', 'Max'] },
                processor_desktop: { a: ['Titan', 'Vortex', 'Astra', 'Neutron', 'Forge'], b: ['Core', 'Compute', 'Die', 'Chiplet'], c: ['Z', 'X', 'Prime', 'Extreme'] },
                gpu: { a: ['Photon', 'Nebula', 'Spectra', 'Apex'], b: ['Graphics', 'Render', 'Vision'], c: ['GT', 'RTX', 'VX', 'Nova'] },
                display_mobile: { a: ['Crystal', 'Infinity', 'Aurora', 'Prism'], b: ['Panel', 'Vision', 'Display'], c: ['Pro', 'Plus', 'XDR', 'Edge'] },
                display_tablet: { a: ['Nova', 'Aurora', 'Lumen', 'Vivid'], b: ['Panel', 'Screen', 'Display'], c: ['Pro', 'Plus', 'XDR', 'Edge'] },
                display_laptop: { a: ['Quantum', 'Zen', 'Spectra', 'Infinity'], b: ['Panel', 'Vision', 'Display'], c: ['Pro', 'Ultra', 'Max'] },
                display_tv: { a: ['Cine', 'Crystal', 'Lumina', 'Vivid'], b: ['Panel', 'Screen', 'Vision'], c: ['Pro', 'Max', 'XDR'] },
                display_watch: { a: ['Nano', 'Pulse', 'Vivid', 'Aurora'], b: ['Display', 'Panel', 'Screen'], c: ['Pro', 'Edge', 'X'] },
                battery_mobile: { a: ['PowerCell', 'Volt', 'Energy', 'Ion'], b: ['Pack', 'Stack', 'Core'], c: ['Ultra', 'Max', 'Prime'] },
                battery_tablet: { a: ['Volt', 'Energy', 'Core', 'Nova'], b: ['Pack', 'Cell', 'Stack'], c: ['Plus', 'Max', 'Prime'] },
                battery_laptop: { a: ['Power', 'Ion', 'Quantum', 'Atlas'], b: ['Pack', 'Battery', 'Core'], c: ['Pro', 'Ultra', 'Max'] },
                battery_watch: { a: ['Pulse', 'Nano', 'Ion', 'Spark'], b: ['Cell', 'Pack', 'Core'], c: ['Mini', 'Pro', 'X'] },
                battery_headphones: { a: ['Echo', 'Volt', 'Pulse', 'Ion'], b: ['Cell', 'Pack', 'Core'], c: ['Pro', 'Max', 'X'] },
                battery_vacuum: { a: ['Turbo', 'Volt', 'Drive', 'Ion'], b: ['Pack', 'Core', 'Cell'], c: ['Pro', 'Ultra', 'Max'] },
                camera_main: { a: ['Opti', 'Photon', 'Ultra', 'Neo'], b: ['Lens', 'Sensor', 'Vision'], c: ['Pro', 'Elite', 'Master'] },
                camera_ultra: { a: ['Wide', 'Ultra', 'Aero', 'Neo'], b: ['Lens', 'Sensor', 'Vision'], c: ['Pro', 'X', 'Edge'] },
                camera_tele: { a: ['Zoom', 'Tele', 'Apex', 'Neo'], b: ['Lens', 'Sensor', 'Vision'], c: ['Pro', 'X', 'Prime'] },
                camera_front: { a: ['Selfie', 'Neo', 'Aura', 'View'], b: ['Lens', 'Sensor', 'Vision'], c: ['Pro', 'X', 'Plus'] },
                sensors: { a: ['Sense', 'Vita', 'Pulse', 'Core'], b: ['Hub', 'Suite', 'Pack'], c: ['Pro', 'X', 'Plus'] },
                modem: { a: ['Link', 'Wave', 'Connect', 'Aero'], b: ['Modem', 'Radio', 'Core'], c: ['Pro', 'X', 'Plus'] },
                memory_mobile: { a: ['Turbo', 'Speed', 'Flash', 'Quantum'], b: ['Mem', 'RAM', 'Vault'], c: ['X', 'Pro', 'Ultra'] },
                memory_desktop: { a: ['Ultra', 'Titan', 'Speed', 'Quantum'], b: ['RAM', 'Mem', 'Vault'], c: ['X', 'Pro', 'Max'] },
                memory_console: { a: ['Giga', 'Speed', 'Rapid', 'Neo'], b: ['RAM', 'Mem', 'Core'], c: ['Pro', 'X', 'Plus'] },
                storage: { a: ['Flash', 'Data', 'Quantum', 'Hyper'], b: ['SSD', 'Drive', 'Vault'], c: ['Pro', 'X', 'Ultra'] },
                motherboard: { a: ['Prime', 'Apex', 'Core', 'Fusion'], b: ['Board', 'Base', 'Hub'], c: ['X', 'Pro', 'Max'] },
                psu: { a: ['Power', 'Titan', 'Volt', 'Core'], b: ['Unit', 'Supply', 'Core'], c: ['Gold', 'Pro', 'Max'] },
                cooling: { a: ['Frost', 'Chill', 'Glacier', 'Aero'], b: ['Cooler', 'Loop', 'Core'], c: ['Pro', 'X', 'Max'] },
                case: { a: ['Steel', 'Titan', 'Nova', 'Apex'], b: ['Case', 'Tower', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_mobile: { a: ['Neo', 'Aero', 'Edge', 'Prime'], b: ['Body', 'Frame', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_tablet: { a: ['Neo', 'Edge', 'Prime', 'Aura'], b: ['Body', 'Frame', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_laptop: { a: ['Nova', 'Edge', 'Prime', 'Aero'], b: ['Body', 'Frame', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_watch: { a: ['Nano', 'Edge', 'Prime', 'Aura'], b: ['Body', 'Frame', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_headphones: { a: ['Echo', 'Aero', 'Prime', 'Aura'], b: ['Body', 'Shell', 'Frame'], c: ['Pro', 'X', 'Max'] },
                body_tv: { a: ['Cine', 'Edge', 'Prime', 'Aura'], b: ['Body', 'Frame', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_console: { a: ['Neo', 'Edge', 'Prime', 'Apex'], b: ['Body', 'Shell', 'Frame'], c: ['Pro', 'X', 'Max'] },
                body_appliance: { a: ['Steel', 'Prime', 'Aura', 'Core'], b: ['Body', 'Frame', 'Shell'], c: ['Pro', 'X', 'Max'] },
                body_vacuum: { a: ['Nova', 'Prime', 'Aura', 'Core'], b: ['Body', 'Shell', 'Frame'], c: ['Pro', 'X', 'Max'] },
                processor_console: { a: ['Orion', 'Apex', 'Nova', 'Core'], b: ['SoC', 'Engine', 'Chip'], c: ['Pro', 'X', 'Max'] },
                gpu_console: { a: ['Photon', 'Apex', 'Nova', 'Spectra'], b: ['GPU', 'Core', 'Render'], c: ['Pro', 'X', 'Max'] },
                processor_tv: { a: ['Vision', 'Neuro', 'Apex', 'Core'], b: ['Chip', 'Core', 'Engine'], c: ['Pro', 'X', 'Max'] },
                processor_wearable: { a: ['Pulse', 'Nano', 'Apex', 'Core'], b: ['SoC', 'Core', 'Engine'], c: ['Pro', 'X', 'Max'] },
                smart_module: { a: ['Smart', 'Neo', 'Aero', 'Prime'], b: ['Module', 'Core', 'Hub'], c: ['Pro', 'X', 'Max'] },
                speakers_tv: { a: ['Sonic', 'Audio', 'Echo', 'Prime'], b: ['Sound', 'Speaker', 'Audio'], c: ['Pro', 'X', 'Max'] },
                drivers: { a: ['Echo', 'Sonic', 'Pulse', 'Prime'], b: ['Driver', 'Speaker', 'Audio'], c: ['Pro', 'X', 'Max'] },
                bluetooth: { a: ['Wave', 'Link', 'Pulse', 'Prime'], b: ['BT', 'Module', 'Core'], c: ['Pro', 'X', 'Max'] },
                controller: { a: ['Nova', 'Pulse', 'Prime', 'Edge'], b: ['Pad', 'Controller', 'Core'], c: ['Pro', 'X', 'Max'] },
                cooling_console: { a: ['Frost', 'Chill', 'Aero', 'Core'], b: ['Cooler', 'Loop', 'Core'], c: ['Pro', 'X', 'Max'] },
                compressor: { a: ['Cool', 'Frost', 'Prime', 'Core'], b: ['Compressor', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                motor: { a: ['Drive', 'Prime', 'Core', 'Aero'], b: ['Motor', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                controls_appliance: { a: ['Control', 'Smart', 'Prime', 'Core'], b: ['Panel', 'Module', 'Core'], c: ['Pro', 'X', 'Max'] },
                insulation: { a: ['Thermo', 'Prime', 'Core', 'Aura'], b: ['Layer', 'Pack', 'Core'], c: ['Pro', 'X', 'Max'] },
                shelves: { a: ['Clear', 'Prime', 'Aura', 'Core'], b: ['Shelf', 'Rack', 'Core'], c: ['Pro', 'X', 'Max'] },
                motor_washer: { a: ['Spin', 'Prime', 'Core', 'Drive'], b: ['Motor', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                drum: { a: ['Spin', 'Prime', 'Core', 'Steel'], b: ['Drum', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                pump: { a: ['Flow', 'Prime', 'Core', 'Aqua'], b: ['Pump', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                heater: { a: ['Heat', 'Prime', 'Core', 'Thermo'], b: ['Heater', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                compressor_ac: { a: ['Cool', 'Prime', 'Core', 'Aero'], b: ['Compressor', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                fan: { a: ['Aero', 'Prime', 'Core', 'Wind'], b: ['Fan', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                filter: { a: ['Pure', 'Prime', 'Core', 'Air'], b: ['Filter', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                refrigerant: { a: ['Cool', 'Prime', 'Core', 'R'], b: ['Gas', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                motor_vacuum: { a: ['Turbo', 'Prime', 'Core', 'Drive'], b: ['Motor', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                filter_vacuum: { a: ['Pure', 'Prime', 'Core', 'HEPA'], b: ['Filter', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                brush: { a: ['Clean', 'Prime', 'Core', 'Sweep'], b: ['Brush', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                sensors_vacuum: { a: ['Sense', 'Prime', 'Core', 'Scan'], b: ['Sensor', 'Unit', 'Core'], c: ['Pro', 'X', 'Max'] },
                strap: { a: ['Strap', 'Prime', 'Core', 'Band'], b: ['Band', 'Loop', 'Core'], c: ['Pro', 'X', 'Max'] },
                webcam: { a: ['Vision', 'Prime', 'Core', 'Cam'], b: ['Cam', 'Lens', 'Core'], c: ['Pro', 'X', 'Max'] },
                keyboard: { a: ['Key', 'Prime', 'Core', 'Type'], b: ['Board', 'Keys', 'Core'], c: ['Pro', 'X', 'Max'] },
                touchpad: { a: ['Touch', 'Prime', 'Core', 'Pad'], b: ['Pad', 'Surface', 'Core'], c: ['Pro', 'X', 'Max'] },
                speakers: { a: ['Audio', 'Prime', 'Core', 'Sound'], b: ['Speaker', 'Audio', 'Core'], c: ['Pro', 'X', 'Max'] },
                body_console: { a: ['Neo', 'Prime', 'Core', 'Shell'], b: ['Body', 'Shell', 'Core'], c: ['Pro', 'X', 'Max'] }
            };
            const g = groups[compType] || { a: ['Custom', 'Exclusive', 'Limited'], b: ['Module', 'Unit', 'Part'], c: ['X', 'Pro', 'Ultra'] };
            const A = g.a[Math.floor(Math.random() * g.a.length)];
            const B = g.b[Math.floor(Math.random() * g.b.length)];
            const C = g.c[Math.floor(Math.random() * g.c.length)];
            const t = Number(tier || item?.tier || 1);
            const serial = randomSerial();
            // No tier words in the name; tier is shown on the card UI separately.
            return `${A} ${B} ${C}${t} (${serial})`;
        }

        function shouldDropExclusiveCard(tier) {
            // Exclusive parts (unique cards) should drop noticeably more often, but still feel special.
            // Slightly more likely on higher tiers.
            const t = Number(tier || 1);
            const base = 0.08; // 8%
            const extra = t >= 4 ? 0.07 : t === 3 ? 0.04 : t === 2 ? 0.02 : 0;
            return Math.random() < (base + extra);
        }

        function isMarketComponentName(compType, name) {
            const items = COMPONENTS[compType]?.items || [];
            const target = normalizeCompName(name);
            return items.some(it => normalizeCompName(it.name) === target);
        }

        function createCard(compType, item, opts = {}) {
            const tier = Number(item?.tier || 1);
            const qty = rollCardQty(tier);

            const forceExclusive = !!opts.forceExclusive;
            const exclusiveAllowed = opts.allowExclusive !== false;
            const exclusive = (forceExclusive || shouldDropExclusiveCard(tier)) && exclusiveAllowed;

            let name = item.name;
            let quality = Number(item.quality || 0);
            let unitPrice = Math.max(1, Math.round(Number(item.price || 0)));

            if (exclusive) {
                name = generateExclusiveComponentName(compType, item, tier);
                // Make exclusives slightly better than their base item.
                quality = Math.round(quality + 2 + tier * 2 + Math.random() * 4);
                const rarityMult = { 1: 1.15, 2: 1.35, 3: 1.6, 4: 2.0, 5: 2.6 }[tier] || 1.2;
                unitPrice = Math.max(1, Math.round(Number(item.price || 0) * rarityMult));
            }

            const value = Math.max(1, Math.round(unitPrice * qty));

            return {
                id: Date.now() + Math.random(),
                compType,
                name,
                baseName: item.name,
                unitPrice,
                qty,
                value,
                quality,
                tier,
                exclusive,
                claimedAt: Date.now(),
                source: 'card'
            };
        }
        
        function claimCards() {
            if (!canClaimCards()) {
                notify('‚è∞ –ö–∞—Ä—Ç–æ—á–∫–∏ –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã!', 'warning');
                return;
            }
            
            const category = gameState.selectedCardCategory || 'smartphone';
            const newCards = [];
            
            for (let i = 0; i < CARDS_PER_DROP; i++) {
                const card = generateRandomCard(category);
                if (card) {
                    newCards.push(card);

                    // Auto-send parts to warehouse (strip tier prefix for storage name)
                    addInventory(card.compType, stripTierPrefix(card.name), Number(card.qty || 1));

                    // Register as a custom component so it appears in selectors.
                    // Only exclusives should become separate selectable SKUs. Otherwise we'd duplicate market items.
                    if (!gameState.customComponents) gameState.customComponents = [];
                    if (card.exclusive) {
                        gameState.customComponents.push({
                            id: Date.now() + Math.random(),
                            compType: card.compType,
                            // keep unique card name as-is, but without tier words
                            name: stripTierPrefix(card.name),
                            price: Math.max(1, Math.round(Number(card.unitPrice || card.price || 1) * 0.95)),
                            quality: card.quality,
                            tier: card.tier,
                            custom: true,
                            internal: true,
                            source: 'card_exclusive'
                        });
                    }
                }
            }

            // Track total cards received (for achievements)
            gameState.cardsReceivedTotal = Number(gameState.cardsReceivedTotal || 0) + newCards.length;
            
            // Only set cooldown if not skipping
            if (!gameState.devSkipCardCooldown) {
                gameState.lastCardClaim = Date.now();
            }
            saveGame();
            
            // Show results
            displayDroppedCards(newCards);
            updateCardUI();
            
            notify(`üé¥ –ü–æ–ª—É—á–µ–Ω–æ ${newCards.length} –∫–∞—Ä—Ç–æ—á–µ–∫!`, 'success');
        }
        
        function displayDroppedCards(cards) {
            const resultsDiv = document.getElementById('cardDropResults');
            const grid = document.getElementById('droppedCardsGrid');
            if (!resultsDiv || !grid) return;

            resultsDiv.classList.remove('hidden');

            grid.innerHTML = cards.map((card, i) => {
                const compLabel = COMPONENTS[card.compType]?.name || card.compType;
                const qty = Number(card.qty || 1);
                const unit = Number(card.unitPrice || card.price || 0);
                const value = Number(card.value || Math.round(unit * qty) || 0);
                const stockName = stripTierPrefix(card.name);

                return `
                <div class="drop-row drop-tier-${card.tier} ${card.exclusive ? 'drop-row-exclusive' : ''} drop-row-new" style="animation-delay:${i * 0.08}s">
                    <div class="tier-strip" aria-hidden="true"></div>

                    <div class="titleline" title="${escapeAttr(card.name)}">
                        <div class="title">${escapeHtml(card.name)}</div>
                        <span class="rarity-chip flex-shrink-0">${escapeHtml(getTierName(card.tier))}</span>
                    </div>

                    <div class="left-col">
                        <div class="stat-row">
                            <span class="qty-chip">x${qty.toLocaleString()}</span>
                            <span class="stat-pill"><span class="text-gray-400">Q</span> <span class="font-bold">${Number(card.quality || 0)}</span></span>
                            ${card.exclusive ? '<span class="unique-pill">‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π</span>' : ''}
                        </div>

                        <span class="comp-chip" title="${escapeAttr(compLabel)}">${escapeHtml(compLabel)}</span>

                        <span class="stat-pill">
                            <span class="text-gray-400">–¶–µ–Ω–∞/—à—Ç</span>
                            <span class="font-bold">${formatMoney(Math.max(0, Math.round(unit)))}</span>
                        </span>
                    </div>

                    <div class="value-box">
                        <div class="value-sub">–ü–∞—Ä—Ç–∏—è</div>
                        <div class="value-price">${formatMoney(value)}</div>
                        <button type="button"
                            data-comp-type="${escapeAttr(card.compType)}"
                            data-name="${escapeAttr(stockName)}"
                            data-qty="${qty}"
                            data-unit="${Math.max(0, Math.round(unit))}"
                            onclick="sellDroppedBatchFromEl(this)"
                            class="btn-action sell-btn bg-red-600/85 hover:bg-red-600">
                            –ü—Ä–æ–¥–∞—Ç—å
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function updateCardUI() {
            updateCardTimer();
            updateCategoryGrid();
            updateClaimButton();
        }
        
        function updateCardTimer() {
            const timerDiv = document.getElementById('cardDropTimer');
            if (!timerDiv) return;
            
            const timeRemaining = getTimeUntilNextClaim();
            if (timeRemaining <= 0) {
                timerDiv.innerHTML = '<span class="text-green-400 font-bold">‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã!</span>';
            } else {
                timerDiv.innerHTML = `<span class="text-yellow-400">‚è∞ –°–ª–µ–¥—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑: <span class="font-bold">${formatTimeRemaining(timeRemaining)}</span></span>`;
            }
        }
        
        function updateCategoryGrid() {
            const grid = document.getElementById('cardCategoryGrid');
            if (!grid) return;
            
            grid.innerHTML = Object.entries(CARD_CATEGORIES).map(([key, cat]) => {
                const isSelected = gameState.selectedCardCategory === key;
                return `
                    <button onclick="selectCardCategory('${key}')" 
                        class="category-btn ${isSelected ? 'ring-2 ring-blue-500 bg-blue-600/30' : 'bg-gray-700/50'} 
                        p-2 rounded-lg text-center hover:bg-gray-600/50 transition-all">
                        <div class="text-2xl mb-1">${cat.icon}</div>
                        <div class="text-[10px] truncate">${cat.name.split(' ')[1] || cat.name}</div>
                    </button>
                `;
            }).join('');
        }
        
        function selectCardCategory(category) {
            gameState.selectedCardCategory = category;
            saveGame();
            updateCategoryGrid();
        }
        
        // Cards no longer have a collection UI: they are auto-sent to warehouse.
        function updateCollectionDisplay() { /* no-op */ }
        
        function updateClaimButton() {
            const btn = document.getElementById('claimCardsBtn');
            if (!btn) return;
            
            const canClaim = canClaimCards();
            btn.disabled = !canClaim;
            btn.classList.toggle('opacity-50', !canClaim);
            btn.classList.toggle('cursor-not-allowed', !canClaim);
        }
        
        // Start card timer update loop
        let cardTimerInterval = null;
        function startCardTimer() {
            if (cardTimerInterval) clearInterval(cardTimerInterval);
            cardTimerInterval = setInterval(() => {
                updateCardTimer();
                updateClaimButton();
            }, 1000);
        }

        // ==================== CARD ACTIONS (USE / SELL) ====================
        // Cards are auto-sent to warehouse now.
        function findCardIndexById(cardId) {
            const idNum = Number(cardId);
            return (gameState.cardCollection || []).findIndex(c => Number(c.id) === idNum);
        }

        // Deprecated (kept for backward compatibility)
        function useCard(cardId) {
            notify('üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥.', 'info');
        }

        // Deprecated (kept for backward compatibility)
        function sellCard(cardId) {
            notify('üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥.', 'info');
        }

        const STAFF_LIMITS = {
            engineers: 12,
            marketers: 10,
            repairmen: 10,
            researchers: 8
        };

        // ==================== DEVICE TYPES ====================
        const DEVICE_TYPES = {
            smartphone: { name: '–°–º–∞—Ä—Ç—Ñ–æ–Ω', icon: 'üì±', components: ['processor_mobile', 'display_mobile', 'battery_mobile', 'camera_main', 'camera_ultra', 'camera_tele', 'camera_front', 'memory_mobile', 'body_mobile', 'sensors', 'modem'] },
            tablet: { name: '–ü–ª–∞–Ω—à–µ—Ç', icon: 'üì≤', components: ['processor_mobile', 'display_tablet', 'battery_tablet', 'camera_main', 'camera_ultra', 'camera_front', 'memory_mobile', 'body_tablet', 'sensors', 'speakers'] },
            laptop: { name: '–ù–æ—É—Ç–±—É–∫', icon: 'üíª', components: ['processor_desktop', 'gpu', 'display_laptop', 'battery_laptop', 'memory_desktop', 'storage', 'body_laptop', 'keyboard', 'touchpad', 'webcam'] },
            desktop: { name: '–ü–ö', icon: 'üñ•Ô∏è', components: ['processor_desktop', 'gpu', 'motherboard', 'memory_desktop', 'storage', 'psu', 'case', 'cooling'] },
            smartwatch: { name: '–°–º–∞—Ä—Ç-—á–∞—Å—ã', icon: '‚åö', components: ['processor_wearable', 'display_watch', 'battery_watch', 'sensors_watch', 'body_watch', 'strap'] },
            headphones: { name: '–ù–∞—É—à–Ω–∏–∫–∏', icon: 'üéß', components: ['drivers', 'battery_headphones', 'bluetooth', 'body_headphones', 'cushions', 'microphone'] },
            tv: { name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä', icon: 'üì∫', components: ['display_tv', 'processor_tv', 'speakers_tv', 'smart_module', 'body_tv', 'stand'] },
            console: { name: '–ò–≥—Ä–æ–≤–∞—è –∫–æ–Ω—Å–æ–ª—å', icon: 'üéÆ', components: ['processor_console', 'gpu_console', 'memory_console', 'storage_console', 'body_console', 'cooling_console', 'controller'] },
            refrigerator: { name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫', icon: 'üßä', components: ['compressor', 'motor', 'controls_appliance', 'body_appliance', 'insulation', 'shelves'] },
            washer: { name: '–°—Ç–∏—Ä–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞', icon: 'üß∫', components: ['motor_washer', 'drum', 'controls_appliance', 'body_appliance', 'pump', 'heater'] },
            aircon: { name: '–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä', icon: '‚ùÑÔ∏è', components: ['compressor_ac', 'fan', 'controls_appliance', 'body_appliance', 'filter', 'refrigerant'] },
            vacuum: { name: '–ü—ã–ª–µ—Å–æ—Å', icon: 'üßπ', components: ['motor_vacuum', 'battery_vacuum', 'filter_vacuum', 'body_vacuum', 'brush', 'sensors_vacuum'] }
        };

        // ==================== COMPONENTS DATABASE ====================
        const COMPONENTS = {
            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–Ω–∞—Ü–µ–Ω–∫–∞ –¥–æ –ø—Ä–æ–∫–∞—á–∫–∏ —Ñ–∞–±—Ä–∏–∫–∏)
            COMPONENT_FACTORY_BASE_COST: 22,
            COMPONENT_FACTORY_COST_PER_QUALITY: 0.06,
            COMPONENT_FACTORY_COST_REDUCTION_PER_LEVEL: 0.22,
            COMPONENT_FACTORY_MIN_COST_MULTIPLIER: 0.3,
            COMPONENT_FACTORY_MARKUP_MULTIPLIER: 1.0,
            COMPONENT_FACTORY_MAX_QUALITY_BASE: 5,
            COMPONENT_FACTORY_QUALITY_PER_LEVEL: 8,
            COMPONENT_FACTORY_QUALITY_EXTRA_COST: 0.9,
            COMPONENT_FACTORY_QUALITY_EXTRA_STEP: 1,
            COMPONENT_FACTORY_QUALITY_SUPER_COST: 0.8,
            COMPONENT_FACTORY_QUALITY_SUPER_STEP: 1,
            COMPONENT_FACTORY_QUALITY_LIMITS: {
                processor_mobile: 20,
                display_mobile: 15,
                battery_mobile: 14,
                camera_main: 18,
                camera_ultra: 12,
                camera_tele: 16,
                camera_front: 12,
                memory_mobile: 18,
                modem: 14,
                sensors: 12,
                processor_desktop: 22,
                gpu: 20,
                memory_desktop: 18,
                storage: 18,
                motherboard: 16,
                psu: 14,
                cooling: 16,
                case: 14
            },

            // Mobile Processors
            processor_mobile: {
                name: '–ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä',
                category: 'smartphone',
                items: [
                    // Tier 1 - Budget
                    { name: 'MediaTek Helio A22', price: 5, quality: 8, tier: 1 },
                    { name: 'Unisoc SC9863A', price: 6, quality: 10, tier: 1 },
                    { name: 'MediaTek Helio G35', price: 8, quality: 15, tier: 1 },
                    { name: 'Qualcomm Snapdragon 439', price: 9, quality: 18, tier: 1 },
                    { name: 'MediaTek Helio G85', price: 12, quality: 25, tier: 1 },
                    { name: 'Qualcomm Snapdragon 460', price: 15, quality: 30, tier: 1 },
                    // Tier 2 - Entry Mid
                    { name: 'Qualcomm Snapdragon 480', price: 18, quality: 35, tier: 2 },
                    { name: 'MediaTek Helio G96', price: 20, quality: 38, tier: 2 },
                    { name: 'Qualcomm Snapdragon 680', price: 22, quality: 42, tier: 2 },
                    { name: 'Samsung Exynos 1280', price: 25, quality: 45, tier: 2 },
                    { name: 'Qualcomm Snapdragon 695', price: 28, quality: 48, tier: 2 },
                    { name: 'MediaTek Dimensity 700', price: 32, quality: 52, tier: 2 },
                    // Tier 3 - Mid Range
                    { name: 'MediaTek Dimensity 800U', price: 35, quality: 55, tier: 3 },
                    { name: 'Qualcomm Snapdragon 750G', price: 38, quality: 58, tier: 3 },
                    { name: 'Qualcomm Snapdragon 778G', price: 42, quality: 62, tier: 3 },
                    { name: 'MediaTek Dimensity 8100', price: 48, quality: 68, tier: 3 },
                    { name: 'Qualcomm Snapdragon 7 Gen 1', price: 52, quality: 72, tier: 3 },
                    { name: 'MediaTek Dimensity 8200', price: 55, quality: 75, tier: 3 },
                    // Tier 4 - High End
                    { name: 'Qualcomm Snapdragon 8 Gen 1', price: 62, quality: 80, tier: 4 },
                    { name: 'MediaTek Dimensity 9000', price: 68, quality: 83, tier: 4 },
                    { name: 'Samsung Exynos 2200', price: 72, quality: 85, tier: 4 },
                    { name: 'Qualcomm Snapdragon 8+ Gen 1', price: 75, quality: 87, tier: 4 },
                    { name: 'Qualcomm Snapdragon 8 Gen 2', price: 82, quality: 90, tier: 4 },
                    { name: 'MediaTek Dimensity 9200', price: 85, quality: 92, tier: 4 },
                    // Tier 5 - Flagship
                    { name: 'Apple A16 Bionic', price: 90, quality: 94, tier: 5 },
                    { name: 'Qualcomm Snapdragon 8 Gen 3', price: 95, quality: 96, tier: 5 },
                    { name: 'MediaTek Dimensity 9300', price: 98, quality: 97, tier: 5 },
                    { name: 'Samsung Exynos 2400', price: 100, quality: 98, tier: 5 },
                    { name: 'Apple A17 Pro', price: 110, quality: 99, tier: 5 },
                    { name: 'Qualcomm Snapdragon 8 Gen 3+ Elite', price: 120, quality: 101, tier: 5 },
                    { name: 'MediaTek Dimensity 9400', price: 125, quality: 102, tier: 5 },
                    { name: 'Apple A18 Pro', price: 135, quality: 104, tier: 5 },
                    { name: 'Samsung Exynos 2500', price: 140, quality: 105, tier: 5 },
                    { name: 'Qualcomm Snapdragon 8 Gen 4', price: 150, quality: 106, tier: 5 },
                    { name: 'MediaTek Dimensity 9500', price: 160, quality: 108, tier: 5 },
                    { name: 'Apple A19 Pro', price: 180, quality: 110, tier: 5 },
                    { name: 'Samsung Exynos 2600', price: 190, quality: 112, tier: 5 }
                ]
            },
            display_mobile: {
                name: '–ú–æ–±–∏–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π',
                category: 'smartphone',
                items: [
                    // Tier 1 - Budget
                    { name: 'TFT LCD 5.5" 480p', price: 3, quality: 5, tier: 1 },
                    { name: 'TFT LCD 6.0" 720p 60Hz', price: 5, quality: 10, tier: 1 },
                    { name: 'IPS LCD 6.2" 720p 60Hz', price: 8, quality: 18, tier: 1 },
                    { name: 'IPS LCD 6.4" HD+ 60Hz', price: 10, quality: 22, tier: 1 },
                    { name: 'IPS LCD 6.5" 720p+ 90Hz', price: 12, quality: 28, tier: 1 },
                    // Tier 2 - Entry Mid
                    { name: 'IPS LCD 6.5" 1080p 60Hz', price: 16, quality: 35, tier: 2 },
                    { name: 'IPS LCD 6.6" FHD+ 90Hz', price: 20, quality: 42, tier: 2 },
                    { name: 'IPS LCD 6.7" FHD+ 120Hz', price: 25, quality: 48, tier: 2 },
                    { name: 'AMOLED 6.4" FHD+ 60Hz', price: 28, quality: 52, tier: 2 },
                    { name: 'AMOLED 6.5" FHD+ 90Hz', price: 32, quality: 56, tier: 2 },
                    // Tier 3 - Mid Range
                    { name: 'AMOLED 6.6" FHD+ 120Hz', price: 38, quality: 62, tier: 3 },
                    { name: 'Super AMOLED 6.5" FHD+ 120Hz', price: 42, quality: 66, tier: 3 },
                    { name: 'AMOLED 6.7" FHD+ 120Hz HDR10', price: 48, quality: 70, tier: 3 },
                    { name: 'Dynamic AMOLED 6.6" FHD+ 120Hz', price: 52, quality: 74, tier: 3 },
                    { name: 'Fluid AMOLED 6.7" FHD+ 120Hz', price: 56, quality: 78, tier: 3 },
                    // Tier 4 - High End
                    { name: 'Dynamic AMOLED 2X 6.7" QHD+', price: 65, quality: 82, tier: 4 },
                    { name: 'LTPO AMOLED 6.7" QHD+ 120Hz', price: 72, quality: 86, tier: 4 },
                    { name: 'LTPO2 AMOLED 6.8" QHD+ 120Hz', price: 78, quality: 88, tier: 4 },
                    { name: 'Fluid AMOLED 6.7" QHD+ LTPO', price: 82, quality: 90, tier: 4 },
                    { name: 'E6 AMOLED 6.73" 2K LTPO', price: 88, quality: 92, tier: 4 },
                    // Tier 5 - Flagship
                    { name: 'Super Retina XDR 6.7" ProMotion', price: 95, quality: 95, tier: 5 },
                    { name: 'LTPO3 AMOLED 6.8" 2K 144Hz', price: 100, quality: 96, tier: 5 },
                    { name: 'Dynamic AMOLED 2X 6.9" QHD+ LTPO', price: 108, quality: 97, tier: 5 },
                    { name: 'M13 AMOLED 6.8" 2K 144Hz', price: 115, quality: 98, tier: 5 },
                    { name: 'Super Retina XDR ProMotion 2K', price: 125, quality: 99, tier: 5 }
                ]
            },
            battery_mobile: {
                name: '–ú–æ–±–∏–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è',
                category: 'smartphone',
                items: [
                    // Tier 1
                    { name: 'Li-Ion 2500mAh 5W', price: 3, quality: 10, tier: 1 },
                    { name: 'Li-Ion 3000mAh 10W', price: 4, quality: 15, tier: 1 },
                    { name: 'Li-Ion 3500mAh 10W', price: 5, quality: 20, tier: 1 },
                    { name: 'Li-Po 4000mAh 15W', price: 7, quality: 28, tier: 1 },
                    { name: 'Li-Po 4500mAh 18W', price: 9, quality: 32, tier: 1 },
                    // Tier 2
                    { name: 'Li-Po 4500mAh 25W', price: 12, quality: 40, tier: 2 },
                    { name: 'Li-Po 5000mAh 25W', price: 14, quality: 45, tier: 2 },
                    { name: 'Li-Po 5000mAh 33W', price: 16, quality: 50, tier: 2 },
                    { name: 'Li-Po 5000mAh 45W', price: 18, quality: 55, tier: 2 },
                    // Tier 3
                    { name: 'Li-Po 5000mAh 55W', price: 22, quality: 62, tier: 3 },
                    { name: 'Li-Po 5000mAh 67W', price: 25, quality: 68, tier: 3 },
                    { name: 'Li-Po 5500mAh 67W', price: 28, quality: 72, tier: 3 },
                    { name: 'Li-Po 5500mAh 80W', price: 32, quality: 76, tier: 3 },
                    // Tier 4
                    { name: 'Li-Po 5500mAh 100W', price: 38, quality: 82, tier: 4 },
                    { name: 'Li-Po 6000mAh 100W', price: 42, quality: 85, tier: 4 },
                    { name: 'Silicon-Anode 5500mAh 120W', price: 48, quality: 88, tier: 4 },
                    { name: 'Silicon-Carbon 5000mAh 150W', price: 52, quality: 90, tier: 4 },
                    // Tier 5
                    { name: 'Silicon-Carbon 6000mAh 120W', price: 58, quality: 94, tier: 5 },
                    { name: 'Silicon-Carbon 5500mAh 200W', price: 65, quality: 96, tier: 5 },
                    { name: 'Graphene 5500mAh 240W', price: 75, quality: 98, tier: 5 },
                    { name: 'Solid-State 6000mAh 300W', price: 90, quality: 99, tier: 5 }
                ]
            },
            camera_main: {
                name: '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞',
                category: 'smartphone',
                items: [
                    // Tier 1
                    { name: 'OmniVision OV5648 5MP', price: 3, quality: 8, tier: 1 },
                    { name: 'Samsung S5K4H7 8MP', price: 5, quality: 12, tier: 1 },
                    { name: 'Samsung S5K3L6 12MP', price: 8, quality: 18, tier: 1 },
                    { name: 'OmniVision OV13B 13MP', price: 10, quality: 24, tier: 1 },
                    { name: 'Samsung S5KGW3 16MP', price: 12, quality: 28, tier: 1 },
                    // Tier 2
                    { name: 'Sony IMX471 32MP', price: 15, quality: 35, tier: 2 },
                    { name: 'Samsung S5KGM2 48MP', price: 18, quality: 42, tier: 2 },
                    { name: 'Sony IMX582 48MP', price: 22, quality: 48, tier: 2 },
                    { name: 'Samsung S5KGM1 48MP', price: 25, quality: 52, tier: 2 },
                    { name: 'Sony IMX586 48MP', price: 28, quality: 56, tier: 2 },
                    // Tier 3
                    { name: 'Samsung ISOCELL GM5 50MP', price: 32, quality: 62, tier: 3 },
                    { name: 'Sony IMX766 50MP OIS', price: 38, quality: 68, tier: 3 },
                    { name: 'Samsung ISOCELL GN5 50MP', price: 42, quality: 72, tier: 3 },
                    { name: 'Sony IMX787 54MP OIS', price: 48, quality: 76, tier: 3 },
                    { name: 'Samsung ISOCELL HP1 108MP', price: 52, quality: 78, tier: 3 },
                    // Tier 4
                    { name: 'Sony IMX890 50MP OIS', price: 58, quality: 83, tier: 4 },
                    { name: 'Samsung ISOCELL GN2 50MP', price: 65, quality: 86, tier: 4 },
                    { name: 'Sony IMX800 54MP OIS', price: 72, quality: 88, tier: 4 },
                    { name: 'Samsung ISOCELL HP2 200MP', price: 78, quality: 90, tier: 4 },
                    { name: 'Sony IMX866 50MP 1/1.56"', price: 82, quality: 92, tier: 4 },
                    // Tier 5
                    { name: 'Sony IMX989 1" 50MP', price: 95, quality: 95, tier: 5 },
                    { name: 'Samsung ISOCELL HP3 200MP OIS', price: 105, quality: 97, tier: 5 },
                    { name: 'Sony LYT-900 1" 50MP', price: 115, quality: 98, tier: 5 },
                    { name: 'Samsung ISOCELL HP9 200MP OIS', price: 125, quality: 99, tier: 5 }
                ]
            },
            camera_ultra: {
                name: '–£–ª—å—Ç—Ä–∞—à–∏—Ä–æ–∫–∞—è –∫–∞–º–µ—Ä–∞',
                category: 'smartphone',
                items: [
                    { name: 'OmniVision OV8856 8MP', price: 5, quality: 20, tier: 1 },
                    { name: 'Samsung S5K3L6 12MP UW', price: 10, quality: 35, tier: 1 },
                    { name: 'Sony IMX355 12MP UW', price: 15, quality: 45, tier: 2 },
                    { name: 'Samsung S5KGW3 50MP UW', price: 25, quality: 60, tier: 3 },
                    { name: 'Sony IMX581 48MP UW', price: 35, quality: 75, tier: 4 },
                    { name: 'Sony IMX858 50MP UW', price: 50, quality: 90, tier: 5 }
                ]
            },
            camera_tele: {
                name: '–¢–µ–ª–µ—Ñ–æ—Ç–æ –∫–∞–º–µ—Ä–∞',
                category: 'smartphone',
                items: [
                    { name: 'Samsung S5K3M5 8MP 2x', price: 8, quality: 25, tier: 1 },
                    { name: 'Sony IMX350 12MP 2x', price: 15, quality: 40, tier: 2 },
                    { name: 'Samsung S5KGW2 50MP 3x', price: 30, quality: 60, tier: 3 },
                    { name: 'Sony IMX754 50MP 3x OIS', price: 45, quality: 78, tier: 4 },
                    { name: 'Sony IMX903 50MP 5x Periscope', price: 70, quality: 92, tier: 5 }
                ]
            },
            camera_front: {
                name: '–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞',
                category: 'smartphone',
                items: [
                    { name: 'OmniVision OV5675 5MP', price: 3, quality: 15, tier: 1 },
                    { name: 'Samsung S5K3P9 8MP', price: 5, quality: 25, tier: 1 },
                    { name: 'Sony IMX471 12MP', price: 8, quality: 40, tier: 2 },
                    { name: 'Samsung S5KGD2 16MP', price: 12, quality: 55, tier: 2 },
                    { name: 'Sony IMX615 32MP', price: 18, quality: 70, tier: 3 },
                    { name: 'Samsung S5K3J1 32MP AF', price: 25, quality: 82, tier: 4 },
                    { name: 'Sony IMX712 32MP AF 4K', price: 35, quality: 92, tier: 5 }
                ]
            },
            memory_mobile: {
                name: '–ú–æ–±–∏–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å',
                category: 'smartphone',
                items: [
                    // Tier 1
                    { name: 'LPDDR4 2GB + eMMC 16GB', price: 4, quality: 5, tier: 1 },
                    { name: 'LPDDR4 3GB + eMMC 32GB', price: 6, quality: 10, tier: 1 },
                    { name: 'LPDDR4X 4GB + eMMC 64GB', price: 8, quality: 18, tier: 1 },
                    { name: 'LPDDR4X 4GB + UFS 2.1 64GB', price: 10, quality: 24, tier: 1 },
                    { name: 'LPDDR4X 6GB + eMMC 128GB', price: 12, quality: 28, tier: 1 },
                    // Tier 2
                    { name: 'LPDDR4X 6GB + UFS 2.2 128GB', price: 16, quality: 38, tier: 2 },
                    { name: 'LPDDR4X 8GB + UFS 2.2 128GB', price: 20, quality: 44, tier: 2 },
                    { name: 'LPDDR5 6GB + UFS 3.0 128GB', price: 24, quality: 48, tier: 2 },
                    { name: 'LPDDR5 8GB + UFS 3.0 256GB', price: 28, quality: 54, tier: 2 },
                    // Tier 3
                    { name: 'LPDDR5 8GB + UFS 3.1 256GB', price: 35, quality: 62, tier: 3 },
                    { name: 'LPDDR5 8GB + UFS 3.1 512GB', price: 42, quality: 68, tier: 3 },
                    { name: 'LPDDR5 12GB + UFS 3.1 256GB', price: 48, quality: 72, tier: 3 },
                    { name: 'LPDDR5 12GB + UFS 3.1 512GB', price: 55, quality: 76, tier: 3 },
                    // Tier 4
                    { name: 'LPDDR5X 12GB + UFS 4.0 256GB', price: 62, quality: 82, tier: 4 },
                    { name: 'LPDDR5X 12GB + UFS 4.0 512GB', price: 72, quality: 86, tier: 4 },
                    { name: 'LPDDR5X 16GB + UFS 4.0 512GB', price: 82, quality: 90, tier: 4 },
                    { name: 'LPDDR5X 16GB + UFS 4.0 1TB', price: 95, quality: 93, tier: 4 },
                    // Tier 5
                    { name: 'LPDDR5X 16GB + UFS 4.1 1TB', price: 110, quality: 96, tier: 5 },
                    { name: 'LPDDR5X 24GB + UFS 4.1 1TB', price: 130, quality: 98, tier: 5 },
                    { name: 'LPDDR5T 24GB + UFS 4.1 2TB', price: 160, quality: 99, tier: 5 }
                ]
            },
            body_mobile: {
                name: '–ö–æ—Ä–ø—É—Å —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞',
                category: 'smartphone',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ –ø–æ–ª–∏–∫–∞—Ä–±–æ–Ω–∞—Ç', price: 4, quality: 20, tier: 1 },
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π', price: 8, quality: 35, tier: 1 },
                    { name: '–ê–ª—é–º–∏–Ω–∏–π + –ø–ª–∞—Å—Ç–∏–∫', price: 15, quality: 50, tier: 2 },
                    { name: '–ê–ª—é–º–∏–Ω–∏–π 6000 —Å–µ—Ä–∏–∏', price: 25, quality: 65, tier: 3 },
                    { name: '–ê–ª—é–º–∏–Ω–∏–π 7000 + —Å—Ç–µ–∫–ª–æ', price: 40, quality: 80, tier: 4 },
                    { name: '–¢–∏—Ç–∞–Ω + –∫–µ—Ä–∞–º–∏–∫–∞', price: 75, quality: 98, tier: 5 }
                ]
            },
            sensors: {
                name: '–°–µ–Ω—Å–æ—Ä—ã —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞',
                category: 'smartphone',
                items: [
                    { name: '–ë–∞–∑–æ–≤—ã–µ (–∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä, –≥–∏—Ä–æ)', price: 3, quality: 25, tier: 1 },
                    { name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç (+ –∫–æ–º–ø–∞—Å, –¥–∞—Ç—á–∏–∫ —Å–≤–µ—Ç–∞)', price: 6, quality: 45, tier: 2 },
                    { name: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ (+ –±–∞—Ä–æ–º–µ—Ç—Ä)', price: 10, quality: 65, tier: 3 },
                    { name: 'Pro (+ LiDAR)', price: 22, quality: 90, tier: 5 }
                ]
            },
            modem: {
                name: '–ú–æ–¥–µ–º',
                category: 'smartphone',
                items: [
                    { name: '4G LTE Cat 4', price: 6, quality: 25, tier: 1 },
                    { name: '4G LTE Cat 12', price: 12, quality: 45, tier: 2 },
                    { name: '5G Sub-6', price: 25, quality: 70, tier: 3 },
                    { name: '5G mmWave', price: 45, quality: 90, tier: 5 }
                ]
            },
            // Tablet
            display_tablet: {
                name: '–î–∏—Å–ø–ª–µ–π –ø–ª–∞–Ω—à–µ—Ç–∞',
                category: 'tablet',
                items: [
                    { name: 'IPS LCD 10" 1280x800', price: 15, quality: 20, tier: 1 },
                    { name: 'IPS LCD 10.9" 2000x1200', price: 28, quality: 40, tier: 2 },
                    { name: 'IPS LCD 11" 2560x1600 120Hz', price: 45, quality: 58, tier: 3 },
                    { name: 'AMOLED 12.4" 2800x1752', price: 75, quality: 78, tier: 4 },
                    { name: 'Liquid Retina XDR 12.9"', price: 120, quality: 95, tier: 5 }
                ]
            },
            battery_tablet: {
                name: '–ë–∞—Ç–∞—Ä–µ—è –ø–ª–∞–Ω—à–µ—Ç–∞',
                category: 'tablet',
                items: [
                    { name: 'Li-Po 5000mAh', price: 10, quality: 25, tier: 1 },
                    { name: 'Li-Po 7500mAh 25W', price: 18, quality: 45, tier: 2 },
                    { name: 'Li-Po 10000mAh 45W', price: 30, quality: 70, tier: 3 },
                    { name: 'Li-Po 11500mAh 67W', price: 48, quality: 90, tier: 5 }
                ]
            },
            body_tablet: {
                name: '–ö–æ—Ä–ø—É—Å –ø–ª–∞–Ω—à–µ—Ç–∞',
                category: 'tablet',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ ABS', price: 8, quality: 25, tier: 1 },
                    { name: '–ê–ª—é–º–∏–Ω–∏–π + –ø–ª–∞—Å—Ç–∏–∫', price: 22, quality: 50, tier: 2 },
                    { name: '–¶–µ–ª—å–Ω—ã–π –∞–ª—é–º–∏–Ω–∏–π', price: 45, quality: 75, tier: 4 }
                ]
            },
            speakers: {
                name: '–î–∏–Ω–∞–º–∏–∫–∏ –ø–ª–∞–Ω—à–µ—Ç–∞',
                category: 'tablet',
                items: [
                    { name: '–ú–æ–Ω–æ –¥–∏–Ω–∞–º–∏–∫', price: 3, quality: 20, tier: 1 },
                    { name: '–°—Ç–µ—Ä–µ–æ –¥–∏–Ω–∞–º–∏–∫–∏', price: 8, quality: 45, tier: 2 },
                    { name: 'Quad –¥–∏–Ω–∞–º–∏–∫–∏', price: 18, quality: 75, tier: 4 }
                ]
            },
            // Laptop
            processor_desktop: {
                name: '–î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä',
                category: 'laptop',
                items: [
                    // Tier 1
                    { name: 'Intel Celeron N4020', price: 15, quality: 8, tier: 1 },
                    { name: 'Intel Celeron N4500', price: 18, quality: 12, tier: 1 },
                    { name: 'Intel Celeron N5100', price: 22, quality: 16, tier: 1 },
                    { name: 'Intel Pentium Silver N6000', price: 28, quality: 20, tier: 1 },
                    { name: 'Intel Pentium Gold G7400', price: 35, quality: 26, tier: 1 },
                    { name: 'AMD Athlon Silver 3050U', price: 32, quality: 22, tier: 1 },
                    { name: 'AMD Ryzen 3 3250U', price: 38, quality: 28, tier: 1 },
                    { name: 'AMD Ryzen 3 4100', price: 45, quality: 32, tier: 1 },
                    // Tier 2
                    { name: 'Intel Core i3-1215U', price: 52, quality: 40, tier: 2 },
                    { name: 'Intel Core i3-12100', price: 58, quality: 45, tier: 2 },
                    { name: 'AMD Ryzen 5 5500', price: 62, quality: 48, tier: 2 },
                    { name: 'Intel Core i5-1235U', price: 68, quality: 52, tier: 2 },
                    { name: 'Intel Core i5-12400', price: 75, quality: 56, tier: 2 },
                    { name: 'AMD Ryzen 5 5600', price: 78, quality: 58, tier: 2 },
                    { name: 'Intel Core i5-12500', price: 82, quality: 60, tier: 2 },
                    // Tier 3
                    { name: 'AMD Ryzen 5 7600', price: 92, quality: 68, tier: 3 },
                    { name: 'Intel Core i5-13400', price: 98, quality: 72, tier: 3 },
                    { name: 'AMD Ryzen 5 7600X', price: 105, quality: 75, tier: 3 },
                    { name: 'Intel Core i5-13600K', price: 115, quality: 78, tier: 3 },
                    { name: 'AMD Ryzen 7 7700', price: 125, quality: 80, tier: 3 },
                    { name: 'Intel Core i5-14600K', price: 130, quality: 82, tier: 3 },
                    // Tier 4
                    { name: 'AMD Ryzen 7 7700X', price: 140, quality: 85, tier: 4 },
                    { name: 'Intel Core i7-13700K', price: 150, quality: 87, tier: 4 },
                    { name: 'AMD Ryzen 7 7800X3D', price: 165, quality: 90, tier: 4 },
                    { name: 'Intel Core i7-14700K', price: 175, quality: 92, tier: 4 },
                    { name: 'AMD Ryzen 9 7900X', price: 185, quality: 93, tier: 4 },
                    { name: 'Intel Core i9-13900K', price: 195, quality: 94, tier: 4 },
                    // Tier 5
                    { name: 'AMD Ryzen 9 7950X', price: 210, quality: 96, tier: 5 },
                    { name: 'Intel Core i9-14900K', price: 230, quality: 97, tier: 5 },
                    { name: 'AMD Ryzen 9 7950X3D', price: 260, quality: 98, tier: 5 },
                    { name: 'Intel Core i9-14900KS', price: 280, quality: 99, tier: 5 },
                    { name: 'AMD Ryzen 9 9950X', price: 310, quality: 101, tier: 5 },
                    { name: 'AMD Ryzen 9 9950X3D', price: 360, quality: 103, tier: 5 },
                    { name: 'Intel Core i9-15900K', price: 340, quality: 102, tier: 5 },
                    { name: 'Intel Core i9-15900KS', price: 380, quality: 105, tier: 5 },
                    { name: 'AMD Ryzen Threadripper 7995WX', price: 520, quality: 110, tier: 5 },
                    { name: 'Intel Xeon W9-3495X', price: 560, quality: 112, tier: 5 }
                ]
            },
            gpu: {
                name: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞',
                category: 'laptop',
                items: [
                    // Tier 1 - Integrated/Entry
                    { name: 'Intel UHD 610', price: 0, quality: 5, tier: 1 },
                    { name: 'Intel UHD 730', price: 0, quality: 8, tier: 1 },
                    { name: 'AMD Radeon Vega 6', price: 0, quality: 12, tier: 1 },
                    { name: 'Intel Iris Xe G4', price: 10, quality: 18, tier: 1 },
                    { name: 'NVIDIA GeForce GT 1030', price: 25, quality: 22, tier: 1 },
                    { name: 'AMD Radeon RX 6400', price: 42, quality: 28, tier: 1 },
                    { name: 'NVIDIA GeForce GTX 1650', price: 52, quality: 34, tier: 1 },
                    // Tier 2 - Entry Gaming
                    { name: 'NVIDIA GeForce GTX 1660 Super', price: 65, quality: 42, tier: 2 },
                    { name: 'AMD Radeon RX 6500 XT', price: 70, quality: 45, tier: 2 },
                    { name: 'NVIDIA GeForce RTX 3050', price: 78, quality: 48, tier: 2 },
                    { name: 'AMD Radeon RX 6600', price: 85, quality: 52, tier: 2 },
                    { name: 'NVIDIA GeForce RTX 3060', price: 98, quality: 56, tier: 2 },
                    { name: 'AMD Radeon RX 6600 XT', price: 105, quality: 58, tier: 2 },
                    { name: 'NVIDIA GeForce RTX 3060 Ti', price: 115, quality: 62, tier: 2 },
                    // Tier 3 - Mid Gaming
                    { name: 'NVIDIA GeForce RTX 4060', price: 125, quality: 68, tier: 3 },
                    { name: 'AMD Radeon RX 7600', price: 130, quality: 70, tier: 3 },
                    { name: 'NVIDIA GeForce RTX 4060 Ti', price: 145, quality: 74, tier: 3 },
                    { name: 'AMD Radeon RX 7700 XT', price: 160, quality: 76, tier: 3 },
                    { name: 'NVIDIA GeForce RTX 3070', price: 155, quality: 75, tier: 3 },
                    { name: 'NVIDIA GeForce RTX 3070 Ti', price: 165, quality: 78, tier: 3 },
                    // Tier 4 - High End
                    { name: 'NVIDIA GeForce RTX 4070', price: 195, quality: 82, tier: 4 },
                    { name: 'AMD Radeon RX 7800 XT', price: 205, quality: 84, tier: 4 },
                    { name: 'NVIDIA GeForce RTX 4070 Super', price: 225, quality: 86, tier: 4 },
                    { name: 'NVIDIA GeForce RTX 4070 Ti', price: 260, quality: 88, tier: 4 },
                    { name: 'AMD Radeon RX 7900 XT', price: 290, quality: 90, tier: 4 },
                    { name: 'NVIDIA GeForce RTX 4070 Ti Super', price: 320, quality: 92, tier: 4 },
                    // Tier 5 - Enthusiast
                    { name: 'NVIDIA GeForce RTX 4080', price: 380, quality: 94, tier: 5 },
                    { name: 'AMD Radeon RX 7900 XTX', price: 400, quality: 95, tier: 5 },
                    { name: 'NVIDIA GeForce RTX 4080 Super', price: 420, quality: 96, tier: 5 },
                    { name: 'NVIDIA GeForce RTX 4090', price: 550, quality: 99, tier: 5 },
                    { name: 'NVIDIA GeForce RTX 4090 Ti', price: 650, quality: 100, tier: 5 },
                    { name: 'NVIDIA GeForce RTX 5090', price: 780, quality: 104, tier: 5 },
                    { name: 'NVIDIA GeForce RTX 5090 Ti', price: 920, quality: 108, tier: 5 },
                    { name: 'AMD Radeon RX 8900 XTX', price: 760, quality: 103, tier: 5 },
                    { name: 'AMD Radeon RX 8950 XTX', price: 840, quality: 106, tier: 5 },
                    { name: 'NVIDIA RTX Titan Ada Next', price: 1200, quality: 112, tier: 5 }
                ]
            },
            display_laptop: {
                name: '–î–∏—Å–ø–ª–µ–π –Ω–æ—É—Ç–±—É–∫–∞',
                category: 'laptop',
                items: [
                    { name: 'TN 14" 1366x768', price: 18, quality: 15, tier: 1 },
                    { name: 'IPS 15.6" 1920x1080', price: 35, quality: 35, tier: 1 },
                    { name: 'IPS 15.6" 1080p 144Hz', price: 55, quality: 50, tier: 2 },
                    { name: 'IPS 16" 2560x1600', price: 85, quality: 65, tier: 3 },
                    { name: 'OLED 15.6" 2880x1800', price: 130, quality: 82, tier: 4 },
                    { name: 'Mini-LED 16" 3456x2234', price: 180, quality: 95, tier: 5 }
                ]
            },
            battery_laptop: {
                name: '–ë–∞—Ç–∞—Ä–µ—è –Ω–æ—É—Ç–±—É–∫–∞',
                category: 'laptop',
                items: [
                    { name: 'Li-Ion 37Wh', price: 15, quality: 20, tier: 1 },
                    { name: 'Li-Po 52Wh 65W', price: 28, quality: 40, tier: 2 },
                    { name: 'Li-Po 72Wh 100W', price: 45, quality: 60, tier: 3 },
                    { name: 'Li-Po 99.9Wh 140W', price: 75, quality: 85, tier: 4 }
                ]
            },
            memory_desktop: {
                name: '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å',
                category: 'laptop',
                items: [
                    { name: 'DDR4 8GB 2666MHz', price: 15, quality: 20, tier: 1 },
                    { name: 'DDR4 16GB 3200MHz', price: 28, quality: 40, tier: 2 },
                    { name: 'DDR5 16GB 4800MHz', price: 45, quality: 55, tier: 2 },
                    { name: 'DDR5 32GB 5600MHz', price: 75, quality: 72, tier: 3 },
                    { name: 'DDR5 64GB 6000MHz', price: 140, quality: 88, tier: 4 },
                    { name: 'DDR5 128GB 6400MHz', price: 280, quality: 98, tier: 5 }
                ]
            },
            storage: {
                name: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å',
                category: 'laptop',
                items: [
                    // Tier 1 - Budget
                    { name: 'eMMC 32GB', price: 5, quality: 5, tier: 1 },
                    { name: 'eMMC 64GB', price: 8, quality: 10, tier: 1 },
                    { name: 'HDD 500GB 5400rpm', price: 15, quality: 15, tier: 1 },
                    { name: 'eMMC 128GB', price: 12, quality: 18, tier: 1 },
                    { name: 'HDD 1TB 5400rpm', price: 20, quality: 20, tier: 1 },
                    { name: 'HDD 1TB 7200rpm', price: 25, quality: 25, tier: 1 },
                    { name: 'HDD 2TB 5400rpm', price: 30, quality: 28, tier: 1 },
                    // Tier 2 - Entry SSD
                    { name: 'SATA SSD 128GB', price: 18, quality: 35, tier: 2 },
                    { name: 'SATA SSD 256GB', price: 24, quality: 42, tier: 2 },
                    { name: 'SATA SSD 512GB', price: 35, quality: 48, tier: 2 },
                    { name: 'SATA SSD 1TB', price: 48, quality: 54, tier: 2 },
                    { name: 'NVMe SSD 256GB Gen3', price: 32, quality: 50, tier: 2 },
                    { name: 'NVMe SSD 512GB Gen3', price: 42, quality: 56, tier: 2 },
                    // Tier 3 - Mid NVMe
                    { name: 'NVMe SSD 512GB Gen4', price: 52, quality: 65, tier: 3 },
                    { name: 'NVMe SSD 1TB Gen3', price: 58, quality: 68, tier: 3 },
                    { name: 'NVMe SSD 1TB Gen4', price: 72, quality: 74, tier: 3 },
                    { name: 'NVMe SSD 1TB Gen4 (TLC)', price: 78, quality: 78, tier: 3 },
                    { name: 'NVMe SSD 2TB Gen3', price: 95, quality: 80, tier: 3 },
                    // Tier 4 - High End
                    { name: 'NVMe SSD 2TB Gen4', price: 115, quality: 85, tier: 4 },
                    { name: 'NVMe SSD 2TB Gen4 (TLC)', price: 130, quality: 88, tier: 4 },
                    { name: 'NVMe SSD 4TB Gen4', price: 180, quality: 90, tier: 4 },
                    { name: 'NVMe SSD 2TB Gen5', price: 165, quality: 92, tier: 4 },
                    // Tier 5 - Enthusiast
                    { name: 'NVMe SSD 4TB Gen5', price: 280, quality: 96, tier: 5 },
                    { name: 'NVMe SSD 8TB Gen4', price: 450, quality: 97, tier: 5 },
                    { name: 'NVMe SSD 8TB Gen5', price: 550, quality: 99, tier: 5 },
                    { name: 'NVMe SSD 8TB Gen5 Pro', price: 620, quality: 101, tier: 5 },
                    { name: 'NVMe SSD 16TB Gen5', price: 880, quality: 104, tier: 5 },
                    { name: 'NVMe SSD 32TB Gen5 Enterprise', price: 1400, quality: 110, tier: 5 }
                ]
            },
            body_laptop: {
                name: '–ö–æ—Ä–ø—É—Å –Ω–æ—É—Ç–±—É–∫–∞',
                category: 'laptop',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ ABS 2.5–∫–≥', price: 20, quality: 20, tier: 1 },
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ + –º–µ—Ç–∞–ª–ª 2.1–∫–≥', price: 38, quality: 40, tier: 2 },
                    { name: '–ê–ª—é–º–∏–Ω–∏–π unibody 1.7–∫–≥', price: 65, quality: 65, tier: 3 },
                    { name: '–ú–∞–≥–Ω–∏–µ–≤—ã–π —Å–ø–ª–∞–≤ 1.3–∫–≥', price: 95, quality: 82, tier: 4 },
                    { name: '–ö–∞—Ä–±–æ–Ω + –∞–ª—é–º–∏–Ω–∏–π 0.99–∫–≥', price: 150, quality: 96, tier: 5 }
                ]
            },
            keyboard: {
                name: '–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞',
                category: 'laptop',
                items: [
                    { name: '–ú–µ–º–±—Ä–∞–Ω–Ω–∞—è –±–∞–∑–æ–≤–∞—è', price: 8, quality: 25, tier: 1 },
                    { name: '–ú–µ–º–±—Ä–∞–Ω–Ω–∞—è —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π', price: 15, quality: 45, tier: 2 },
                    { name: '–ù–æ–∂–Ω–∏—á–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞', price: 28, quality: 70, tier: 3 },
                    { name: 'Low-profile –º–µ—Ö–∞–Ω–∏–∫–∞ RGB', price: 48, quality: 90, tier: 5 }
                ]
            },
            touchpad: {
                name: '–¢–∞—á–ø–∞–¥',
                category: 'laptop',
                items: [
                    { name: '–ë–∞–∑–æ–≤—ã–π 100x60–º–º', price: 5, quality: 25, tier: 1 },
                    { name: 'Precision 120x70–º–º', price: 12, quality: 50, tier: 2 },
                    { name: 'Glass 140x90–º–º', price: 25, quality: 75, tier: 4 },
                    { name: 'Haptic Force Touch', price: 45, quality: 95, tier: 5 }
                ]
            },
            webcam: {
                name: '–í–µ–±-–∫–∞–º–µ—Ä–∞',
                category: 'laptop',
                items: [
                    { name: '720p –±–∞–∑–æ–≤–∞—è', price: 4, quality: 25, tier: 1 },
                    { name: '1080p', price: 10, quality: 50, tier: 2 },
                    { name: '1080p + Windows Hello', price: 22, quality: 75, tier: 4 }
                ]
            },
            // Desktop PC
            motherboard: {
                name: '–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞',
                category: 'desktop',
                items: [
                    { name: 'H610 –±–∞–∑–æ–≤–∞—è', price: 35, quality: 25, tier: 1 },
                    { name: 'B660 —Å—Ä–µ–¥–Ω—è—è', price: 55, quality: 40, tier: 2 },
                    { name: 'B760 —Ö–æ—Ä–æ—à–∞—è', price: 85, quality: 60, tier: 3 },
                    { name: 'Z790 –ø—Ä–µ–º–∏—É–º', price: 150, quality: 85, tier: 4 },
                    { name: 'X670E —Ñ–ª–∞–≥–º–∞–Ω', price: 250, quality: 98, tier: 5 }
                ]
            },
            psu: {
                name: '–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è',
                category: 'desktop',
                items: [
                    { name: '400W 80+', price: 20, quality: 25, tier: 1 },
                    { name: '550W 80+ Bronze', price: 35, quality: 45, tier: 2 },
                    { name: '750W 80+ Gold', price: 65, quality: 70, tier: 3 },
                    { name: '1000W 80+ Platinum', price: 120, quality: 90, tier: 5 }
                ]
            },
            case: {
                name: '–ö–æ—Ä–ø—É—Å –ü–ö',
                category: 'desktop',
                items: [
                    { name: 'Mini Tower –±–∞–∑–æ–≤—ã–π', price: 25, quality: 25, tier: 1 },
                    { name: 'Mid Tower —Å—Ç–µ–∫–ª–æ', price: 55, quality: 50, tier: 2 },
                    { name: 'Full Tower RGB', price: 95, quality: 75, tier: 4 },
                    { name: 'Premium ITX/ATX', price: 150, quality: 95, tier: 5 }
                ]
            },
            cooling: {
                name: '–°–∏—Å—Ç–µ–º–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è',
                category: 'desktop',
                items: [
                    { name: '–ë–æ–∫—Å–æ–≤—ã–π –∫—É–ª–µ—Ä', price: 0, quality: 20, tier: 1 },
                    { name: 'Tower –∫—É–ª–µ—Ä', price: 25, quality: 45, tier: 2 },
                    { name: 'AIO 240–º–º', price: 65, quality: 70, tier: 3 },
                    { name: 'AIO 360–º–º', price: 110, quality: 88, tier: 4 },
                    { name: 'Custom –≤–æ–¥—è–Ω–∫–∞', price: 250, quality: 99, tier: 5 }
                ]
            },
            // Smartwatch
            processor_wearable: {
                name: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä —á–∞—Å–æ–≤',
                category: 'smartwatch',
                items: [
                    { name: 'Dual Core 1.1GHz', price: 8, quality: 30, tier: 1 },
                    { name: 'Dual Core 1.8GHz', price: 18, quality: 55, tier: 2 },
                    { name: 'Apple S9 / Snapdragon W5', price: 38, quality: 90, tier: 5 }
                ]
            },
            display_watch: {
                name: '–î–∏—Å–ø–ª–µ–π —á–∞—Å–æ–≤',
                category: 'smartwatch',
                items: [
                    { name: 'LCD 1.3" 240x240', price: 5, quality: 25, tier: 1 },
                    { name: 'AMOLED 1.4" 320x320', price: 12, quality: 50, tier: 2 },
                    { name: 'AMOLED 1.5" 400x400', price: 22, quality: 70, tier: 3 },
                    { name: 'LTPO AMOLED 1.9" Always-On', price: 38, quality: 90, tier: 4 }
                ]
            },
            battery_watch: {
                name: '–ë–∞—Ç–∞—Ä–µ—è —á–∞—Å–æ–≤',
                category: 'smartwatch',
                items: [
                    { name: 'Li-Po 250mAh', price: 3, quality: 30, tier: 1 },
                    { name: 'Li-Po 350mAh', price: 5, quality: 50, tier: 2 },
                    { name: 'Li-Po 500mAh', price: 8, quality: 75, tier: 3 }
                ]
            },
            sensors_watch: {
                name: '–°–µ–Ω—Å–æ—Ä—ã —á–∞—Å–æ–≤',
                category: 'smartwatch',
                items: [
                    { name: '–ü—É–ª—å—Å–æ–º–µ—Ç—Ä', price: 4, quality: 30, tier: 1 },
                    { name: '+ SpO2', price: 8, quality: 50, tier: 2 },
                    { name: '+ –≠–ö–ì', price: 18, quality: 75, tier: 3 },
                    { name: 'Full Health (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ª–∞)', price: 35, quality: 95, tier: 5 }
                ]
            },
            body_watch: {
                name: '–ö–æ—Ä–ø—É—Å —á–∞—Å–æ–≤',
                category: 'smartwatch',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫', price: 4, quality: 25, tier: 1 },
                    { name: '–ê–ª—é–º–∏–Ω–∏–π', price: 12, quality: 55, tier: 2 },
                    { name: '–ù–µ—Ä–∂–∞–≤–µ–π–∫–∞', price: 25, quality: 75, tier: 3 },
                    { name: '–¢–∏—Ç–∞–Ω', price: 45, quality: 95, tier: 5 }
                ]
            },
            strap: {
                name: '–†–µ–º–µ—à–æ–∫ —á–∞—Å–æ–≤',
                category: 'smartwatch',
                items: [
                    { name: '–°–∏–ª–∏–∫–æ–Ω –±–∞–∑–æ–≤—ã–π', price: 2, quality: 25, tier: 1 },
                    { name: '–°–∏–ª–∏–∫–æ–Ω —Å–ø–æ—Ä—Ç', price: 5, quality: 50, tier: 2 },
                    { name: '–ö–æ–∂–∞–Ω—ã–π', price: 12, quality: 70, tier: 3 },
                    { name: '–¢–∏—Ç–∞–Ω–æ–≤—ã–π –±—Ä–∞—Å–ª–µ—Ç', price: 35, quality: 95, tier: 5 }
                ]
            },
            // Headphones
            drivers: {
                name: '–î—Ä–∞–π–≤–µ—Ä—ã –Ω–∞—É—à–Ω–∏–∫–æ–≤',
                category: 'headphones',
                items: [
                    { name: '30–º–º –±–∞–∑–æ–≤—ã–µ', price: 5, quality: 25, tier: 1 },
                    { name: '40–º–º Hi-Fi', price: 15, quality: 50, tier: 2 },
                    { name: '50–º–º –ø–ª–∞–Ω–∞—Ä–Ω—ã–µ', price: 35, quality: 80, tier: 4 },
                    { name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ', price: 75, quality: 98, tier: 5 }
                ]
            },
            battery_headphones: {
                name: '–ë–∞—Ç–∞—Ä–µ—è –Ω–∞—É—à–Ω–∏–∫–æ–≤',
                category: 'headphones',
                items: [
                    { name: 'Li-Po 300mAh (20—á)', price: 4, quality: 35, tier: 1 },
                    { name: 'Li-Po 500mAh (40—á)', price: 7, quality: 55, tier: 2 },
                    { name: 'Li-Po 700mAh (60—á)', price: 12, quality: 80, tier: 4 }
                ]
            },
            bluetooth: {
                name: 'Bluetooth –º–æ–¥—É–ª—å',
                category: 'headphones',
                items: [
                    { name: 'Bluetooth 5.0', price: 4, quality: 35, tier: 1 },
                    { name: 'Bluetooth 5.2 aptX', price: 10, quality: 60, tier: 2 },
                    { name: 'Bluetooth 5.3 LDAC', price: 20, quality: 90, tier: 4 }
                ]
            },
            body_headphones: {
                name: '–ö–æ—Ä–ø—É—Å –Ω–∞—É—à–Ω–∏–∫–æ–≤',
                category: 'headphones',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ –±–∞–∑–æ–≤—ã–π', price: 5, quality: 25, tier: 1 },
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ premium', price: 12, quality: 50, tier: 2 },
                    { name: '–ú–µ—Ç–∞–ª–ª + –∫–æ–∂–∞', price: 28, quality: 80, tier: 4 }
                ]
            },
            cushions: {
                name: '–ê–º–±—É—à—é—Ä—ã',
                category: 'headphones',
                items: [
                    { name: '–ü–æ—Ä–æ–ª–æ–Ω', price: 2, quality: 25, tier: 1 },
                    { name: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–∂–∞', price: 6, quality: 50, tier: 2 },
                    { name: 'Memory foam + –∫–æ–∂–∞', price: 15, quality: 85, tier: 4 }
                ]
            },
            microphone: {
                name: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω',
                category: 'headphones',
                items: [
                    { name: '–û–¥–∏–Ω–æ—á–Ω—ã–π', price: 2, quality: 30, tier: 1 },
                    { name: '–î–≤–æ–π–Ω–æ–π —Å —à—É–º–æ–¥–∞–≤–æ–º', price: 6, quality: 60, tier: 2 },
                    { name: '–ú–∞—Å—Å–∏–≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤ AI', price: 15, quality: 90, tier: 4 }
                ]
            },
            // TV
            display_tv: {
                name: '–¢–í –ø–∞–Ω–µ–ª—å',
                category: 'tv',
                items: [
                    { name: 'LED 32" HD', price: 40, quality: 20, tier: 1 },
                    { name: 'LED 43" FHD', price: 65, quality: 35, tier: 1 },
                    { name: 'LED 55" 4K', price: 120, quality: 50, tier: 2 },
                    { name: 'QLED 55" 4K 120Hz', price: 200, quality: 70, tier: 3 },
                    { name: 'OLED 55" 4K 120Hz', price: 350, quality: 85, tier: 4 },
                    { name: 'OLED 65" 4K 120Hz VRR', price: 500, quality: 95, tier: 5 }
                ]
            },
            processor_tv: {
                name: '–¢–í –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä',
                category: 'tv',
                items: [
                    { name: 'Quad Core –±–∞–∑–æ–≤—ã–π', price: 8, quality: 25, tier: 1 },
                    { name: 'Quad Core AI', price: 22, quality: 55, tier: 2 },
                    { name: 'Neural Processor', price: 55, quality: 85, tier: 4 }
                ]
            },
            speakers_tv: {
                name: '–¢–í –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º–∞',
                category: 'tv',
                items: [
                    { name: '–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ 10W', price: 8, quality: 25, tier: 1 },
                    { name: '–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ 20W Dolby', price: 22, quality: 50, tier: 2 },
                    { name: '–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ 40W Atmos', price: 55, quality: 80, tier: 4 }
                ]
            },
            smart_module: {
                name: 'Smart TV –º–æ–¥—É–ª—å',
                category: 'tv',
                items: [
                    { name: '–ë–∞–∑–æ–≤—ã–π (YouTube, Netflix)', price: 8, quality: 30, tier: 1 },
                    { name: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (–≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã)', price: 18, quality: 55, tier: 2 },
                    { name: 'Premium (–∏–≥—Ä—ã, Airplay)', price: 38, quality: 85, tier: 4 }
                ]
            },
            body_tv: {
                name: '–ö–æ—Ä–ø—É—Å –¢–í',
                category: 'tv',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ –±–∞–∑–æ–≤—ã–π', price: 15, quality: 25, tier: 1 },
                    { name: '–¢–æ–Ω–∫–∏–π –ø–ª–∞—Å—Ç–∏–∫', price: 30, quality: 50, tier: 2 },
                    { name: '–ü—Ä–µ–º–∏—É–º –º–µ—Ç–∞–ª–ª', price: 65, quality: 85, tier: 4 }
                ]
            },
            stand: {
                name: '–ü–æ–¥—Å—Ç–∞–≤–∫–∞ –¢–í',
                category: 'tv',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –Ω–æ–∂–∫–∏', price: 5, quality: 25, tier: 1 },
                    { name: '–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è', price: 18, quality: 55, tier: 2 },
                    { name: '–ü—Ä–µ–º–∏—É–º –ø–æ–¥—Å—Ç–∞–≤–∫–∞', price: 45, quality: 85, tier: 4 }
                ]
            },
            // Console
            processor_console: {
                name: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∫–æ–Ω—Å–æ–ª–∏',
                category: 'console',
                items: [
                    { name: 'AMD Jaguar 8-core', price: 45, quality: 30, tier: 1 },
                    { name: 'AMD Zen 2 Custom', price: 95, quality: 60, tier: 3 },
                    { name: 'AMD Zen 4 Custom', price: 150, quality: 90, tier: 5 }
                ]
            },
            gpu_console: {
                name: 'GPU –∫–æ–Ω—Å–æ–ª–∏',
                category: 'console',
                items: [
                    { name: 'AMD GCN 1.84 TFLOPS', price: 55, quality: 30, tier: 1 },
                    { name: 'AMD RDNA 2 10 TFLOPS', price: 120, quality: 65, tier: 3 },
                    { name: 'AMD RDNA 3 15 TFLOPS', price: 200, quality: 95, tier: 5 }
                ]
            },
            memory_console: {
                name: '–ü–∞–º—è—Ç—å –∫–æ–Ω—Å–æ–ª–∏',
                category: 'console',
                items: [
                    { name: 'GDDR5 8GB', price: 35, quality: 30, tier: 1 },
                    { name: 'GDDR6 12GB', price: 65, quality: 55, tier: 2 },
                    { name: 'GDDR6 16GB', price: 95, quality: 75, tier: 4 }
                ]
            },
            storage_console: {
                name: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å –∫–æ–Ω—Å–æ–ª–∏',
                category: 'console',
                items: [
                    { name: 'HDD 500GB', price: 25, quality: 25, tier: 1 },
                    { name: 'NVMe SSD 512GB', price: 55, quality: 55, tier: 2 },
                    { name: 'NVMe SSD 1TB', price: 85, quality: 80, tier: 4 }
                ]
            },
            body_console: {
                name: '–ö–æ—Ä–ø—É—Å –∫–æ–Ω—Å–æ–ª–∏',
                category: 'console',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ ABS', price: 15, quality: 30, tier: 1 },
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ –º–∞—Ç–æ–≤—ã–π', price: 28, quality: 55, tier: 2 },
                    { name: '–ü—Ä–µ–º–∏—É–º –ø–ª–∞—Å—Ç–∏–∫', price: 48, quality: 80, tier: 4 }
                ]
            },
            cooling_console: {
                name: '–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Å–æ–ª–∏',
                category: 'console',
                items: [
                    { name: '–ë–∞–∑–æ–≤–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ', price: 12, quality: 35, tier: 1 },
                    { name: '–£–ª—É—á—à–µ–Ω–Ω–æ–µ', price: 28, quality: 60, tier: 2 },
                    { name: '–ñ–∏–¥–∫–æ—Å—Ç–Ω–æ–µ', price: 55, quality: 90, tier: 5 }
                ]
            },
            controller: {
                name: '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä',
                category: 'console',
                items: [
                    { name: '–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–≤–æ–¥–Ω–æ–π', price: 12, quality: 25, tier: 1 },
                    { name: '–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–π', price: 28, quality: 55, tier: 2 },
                    { name: 'Pro —Å —Ç–∞–∫—Ç–∏–ª—å–Ω–æ–π –æ—Ç–¥–∞—á–µ–π', price: 55, quality: 85, tier: 4 }
                ]
            },
            // Appliances
            compressor: {
                name: '–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞',
                category: 'refrigerator',
                items: [
                    { name: '–ü–æ—Ä—à–Ω–µ–≤–æ–π –±–∞–∑–æ–≤—ã–π', price: 25, quality: 25, tier: 1 },
                    { name: '–ü–æ—Ä—à–Ω–µ–≤–æ–π –∏–Ω–≤–µ—Ä—Ç–æ—Ä', price: 55, quality: 55, tier: 2 },
                    { name: 'Linear Inverter', price: 95, quality: 90, tier: 5 }
                ]
            },
            motor: {
                name: '–ú–æ—Ç–æ—Ä —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞',
                category: 'refrigerator',
                items: [
                    { name: 'AC –º–æ—Ç–æ—Ä –±–∞–∑–æ–≤—ã–π', price: 12, quality: 25, tier: 1 },
                    { name: '–ò–Ω–≤–µ—Ä—Ç–æ—Ä–Ω—ã–π', price: 32, quality: 60, tier: 3 }
                ]
            },
            controls_appliance: {
                name: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π',
                category: 'refrigerator',
                items: [
                    { name: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏', price: 5, quality: 20, tier: 1 },
                    { name: '–ö–Ω–æ–ø–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å', price: 15, quality: 40, tier: 2 },
                    { name: '–°–µ–Ω—Å–æ—Ä–Ω—ã–π –¥–∏—Å–ø–ª–µ–π', price: 35, quality: 65, tier: 3 },
                    { name: 'Smart WiFi + –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', price: 55, quality: 85, tier: 4 }
                ]
            },
            body_appliance: {
                name: '–ö–æ—Ä–ø—É—Å —Ç–µ—Ö–Ω–∏–∫–∏',
                category: 'refrigerator',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ –±–µ–ª—ã–π', price: 12, quality: 25, tier: 1 },
                    { name: '–ú–µ—Ç–∞–ª–ª –æ–∫—Ä–∞—à–µ–Ω–Ω—ã–π', price: 28, quality: 50, tier: 2 },
                    { name: '–ù–µ—Ä–∂–∞–≤–µ—é—â–∞—è —Å—Ç–∞–ª—å', price: 55, quality: 75, tier: 3 },
                    { name: '–ü—Ä–µ–º–∏—É–º –Ω–µ—Ä–∂–∞–≤–µ–π–∫–∞', price: 95, quality: 95, tier: 5 }
                ]
            },
            insulation: {
                name: '–ò–∑–æ–ª—è—Ü–∏—è',
                category: 'refrigerator',
                items: [
                    { name: '–ü–µ–Ω–æ–ø–æ–ª–∏—É—Ä–µ—Ç–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç', price: 18, quality: 35, tier: 1 },
                    { name: 'VIP –ø–∞–Ω–µ–ª–∏', price: 55, quality: 80, tier: 4 }
                ]
            },
            shelves: {
                name: '–ü–æ–ª–∫–∏ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞',
                category: 'refrigerator',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ', price: 8, quality: 25, tier: 1 },
                    { name: '–°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ', price: 22, quality: 55, tier: 2 },
                    { name: '–ó–∞–∫–∞–ª—ë–Ω–Ω–æ–µ —Å—Ç–µ–∫–ª–æ premium', price: 45, quality: 85, tier: 4 }
                ]
            },
            // Washer
            motor_washer: {
                name: '–ú–æ—Ç–æ—Ä —Å—Ç–∏—Ä–∞–ª–∫–∏',
                category: 'washer',
                items: [
                    { name: '–ö–æ–ª–ª–µ–∫—Ç–æ—Ä–Ω—ã–π 800W', price: 25, quality: 25, tier: 1 },
                    { name: '–ò–Ω–≤–µ—Ä—Ç–æ—Ä–Ω—ã–π 1200W', price: 55, quality: 55, tier: 2 },
                    { name: 'Direct Drive', price: 95, quality: 90, tier: 5 }
                ]
            },
            drum: {
                name: '–ë–∞—Ä–∞–±–∞–Ω',
                category: 'washer',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫–æ–≤—ã–π 6–∫–≥', price: 18, quality: 25, tier: 1 },
                    { name: '–ù–µ—Ä–∂–∞–≤–µ–π–∫–∞ 8–∫–≥', price: 38, quality: 55, tier: 2 },
                    { name: '–ù–µ—Ä–∂–∞–≤–µ–π–∫–∞ 10–∫–≥', price: 65, quality: 85, tier: 4 }
                ]
            },
            pump: {
                name: '–ü–æ–º–ø–∞',
                category: 'washer',
                items: [
                    { name: '–ë–∞–∑–æ–≤–∞—è', price: 8, quality: 30, tier: 1 },
                    { name: '–£—Å–∏–ª–µ–Ω–Ω–∞—è', price: 18, quality: 60, tier: 3 }
                ]
            },
            heater: {
                name: '–¢–≠–ù',
                category: 'washer',
                items: [
                    { name: '1800W –±–∞–∑–æ–≤—ã–π', price: 12, quality: 30, tier: 1 },
                    { name: '2000W –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π', price: 28, quality: 70, tier: 3 }
                ]
            },
            // Aircon
            compressor_ac: {
                name: '–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞',
                category: 'aircon',
                items: [
                    { name: 'On/Off –±–∞–∑–æ–≤—ã–π', price: 35, quality: 25, tier: 1 },
                    { name: 'Inverter', price: 75, quality: 60, tier: 3 },
                    { name: 'Dual Inverter', price: 120, quality: 90, tier: 5 }
                ]
            },
            fan: {
                name: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä',
                category: 'aircon',
                items: [
                    { name: '–ë–∞–∑–æ–≤—ã–π', price: 12, quality: 30, tier: 1 },
                    { name: '–ò–Ω–≤–µ—Ä—Ç–æ—Ä–Ω—ã–π —Ç–∏—Ö–∏–π', price: 35, quality: 70, tier: 3 }
                ]
            },
            filter: {
                name: '–§–∏–ª—å—Ç—Ä –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞',
                category: 'aircon',
                items: [
                    { name: '–°–µ—Ç—á–∞—Ç—ã–π', price: 5, quality: 25, tier: 1 },
                    { name: 'HEPA', price: 18, quality: 60, tier: 2 },
                    { name: 'Plasma + HEPA', price: 38, quality: 90, tier: 4 }
                ]
            },
            refrigerant: {
                name: '–•–ª–∞–¥–∞–≥–µ–Ω—Ç',
                category: 'aircon',
                items: [
                    { name: 'R32 –±–∞–∑–æ–≤—ã–π', price: 15, quality: 40, tier: 1 },
                    { name: 'R410A', price: 28, quality: 70, tier: 3 }
                ]
            },
            // Vacuum
            motor_vacuum: {
                name: '–ú–æ—Ç–æ—Ä –ø—ã–ª–µ—Å–æ—Å–∞',
                category: 'vacuum',
                items: [
                    { name: 'DC –º–æ—Ç–æ—Ä 300W', price: 15, quality: 25, tier: 1 },
                    { name: 'Brushless 500W', price: 35, quality: 55, tier: 2 },
                    { name: 'Digital Motor', price: 75, quality: 90, tier: 5 }
                ]
            },
            battery_vacuum: {
                name: '–ë–∞—Ç–∞—Ä–µ—è –ø—ã–ª–µ—Å–æ—Å–∞',
                category: 'vacuum',
                items: [
                    { name: 'Li-Ion 2000mAh', price: 12, quality: 25, tier: 1 },
                    { name: 'Li-Ion 4000mAh', price: 25, quality: 50, tier: 2 },
                    { name: 'Li-Ion 6000mAh', price: 42, quality: 80, tier: 4 }
                ]
            },
            filter_vacuum: {
                name: '–§–∏–ª—å—Ç—Ä –ø—ã–ª–µ—Å–æ—Å–∞',
                category: 'vacuum',
                items: [
                    { name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π', price: 4, quality: 30, tier: 1 },
                    { name: 'HEPA H12', price: 12, quality: 60, tier: 2 },
                    { name: 'HEPA H14', price: 25, quality: 90, tier: 4 }
                ]
            },
            body_vacuum: {
                name: '–ö–æ—Ä–ø—É—Å –ø—ã–ª–µ—Å–æ—Å–∞',
                category: 'vacuum',
                items: [
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ –±–∞–∑–æ–≤—ã–π', price: 8, quality: 30, tier: 1 },
                    { name: '–ü–ª–∞—Å—Ç–∏–∫ premium', price: 18, quality: 55, tier: 2 },
                    { name: '–ú–µ—Ç–∞–ª–ª + –ø–ª–∞—Å—Ç–∏–∫', price: 35, quality: 80, tier: 4 }
                ]
            },
            brush: {
                name: '–©—ë—Ç–∫–∏ –ø—ã–ª–µ—Å–æ—Å–∞',
                category: 'vacuum',
                items: [
                    { name: '–ë–∞–∑–æ–≤–∞—è —â—ë—Ç–∫–∞', price: 5, quality: 30, tier: 1 },
                    { name: '–¢—É—Ä–±–æ—â—ë—Ç–∫–∞', price: 15, quality: 60, tier: 2 },
                    { name: '–ö–æ–º–ø–ª–µ–∫—Ç —â—ë—Ç–æ–∫', price: 35, quality: 90, tier: 4 }
                ]
            },
            sensors_vacuum: {
                name: '–°–µ–Ω—Å–æ—Ä—ã –ø—ã–ª–µ—Å–æ—Å–∞',
                category: 'vacuum',
                items: [
                    { name: '–ò–ö-–¥–∞—Ç—á–∏–∫–∏', price: 5, quality: 25, tier: 1 },
                    { name: '–õ–∞–∑–µ—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è', price: 18, quality: 60, tier: 3 },
                    { name: 'LiDAR + –∫–∞–º–µ—Ä–∞', price: 38, quality: 90, tier: 5 }
                ]
            }
        };

        // Category mapping for components tab
        const COMPONENT_CATEGORIES = {
            smartphone: { name: 'üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω', devices: ['smartphone'] },
            tablet: { name: 'üì≤ –ü–ª–∞–Ω—à–µ—Ç', devices: ['tablet'] },
            laptop: { name: 'üíª –ù–æ—É—Ç–±—É–∫', devices: ['laptop'] },
            desktop: { name: 'üñ•Ô∏è –ü–ö', devices: ['desktop'] },
            smartwatch: { name: '‚åö –ß–∞—Å—ã', devices: ['smartwatch'] },
            headphones: { name: 'üéß –ù–∞—É—à–Ω–∏–∫–∏', devices: ['headphones'] },
            tv: { name: 'üì∫ –¢–í', devices: ['tv'] },
            console: { name: 'üéÆ –ö–æ–Ω—Å–æ–ª—å', devices: ['console'] },
            refrigerator: { name: 'üßä –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫', devices: ['refrigerator'] },
            washer: { name: 'üß∫ –°—Ç–∏—Ä–∞–ª–∫–∞', devices: ['washer'] },
            aircon: { name: '‚ùÑÔ∏è –ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä', devices: ['aircon'] },
            vacuum: { name: 'üßπ –ü—ã–ª–µ—Å–æ—Å', devices: ['vacuum'] }
        };

        // ==================== CONTRACTS WITH SPECIALIZATIONS ====================
        const CONTRACT_SUPPLIERS = [
            { name: 'TSMC', specialty: 'processor', description: '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –∏ —á–∏–ø—ã', discount: 0.15 },
            { name: 'Samsung Display', specialty: 'display', description: '–î–∏—Å–ø–ª–µ–∏ –∏ –ø–∞–Ω–µ–ª–∏', discount: 0.18 },
            { name: 'BOE Technology', specialty: 'display', description: 'LCD –∏ OLED –ø–∞–Ω–µ–ª–∏', discount: 0.12 },
            { name: 'CATL', specialty: 'battery', description: '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã', discount: 0.20 },
            { name: 'LG Chem', specialty: 'battery', description: '–õ–∏—Ç–∏–µ–≤—ã–µ –±–∞—Ç–∞—Ä–µ–∏', discount: 0.15 },
            { name: 'SK Hynix', specialty: 'memory', description: '–ü–∞–º—è—Ç—å –∏ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏', discount: 0.17 },
            { name: 'Micron', specialty: 'memory', description: 'RAM –∏ SSD', discount: 0.14 },
            { name: 'Sony Semiconductor', specialty: 'camera', description: '–ö–∞–º–µ—Ä—ã –∏ —Å–µ–Ω—Å–æ—Ä—ã', discount: 0.16 },
            { name: 'Foxconn', specialty: 'body', description: '–ö–æ—Ä–ø—É—Å–∞ –∏ —Å–±–æ—Ä–∫–∞', discount: 0.12 },
            { name: 'Qualcomm', specialty: 'modem', description: '–ú–æ–¥–µ–º—ã –∏ —Å–≤—è–∑—å', discount: 0.18 },
            { name: 'NVIDIA', specialty: 'gpu', description: '–í–∏–¥–µ–æ–∫–∞—Ä—Ç—ã', discount: 0.10 },
            { name: 'AMD', specialty: 'processor', description: 'CPU –∏ GPU', discount: 0.13 }
        ];

        // ==================== BROKEN DEVICES ====================
        // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª–æ–º–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å —Ä–∞–∑–Ω–æ–π –≤—ã–≥–æ–¥–Ω–æ—Å—Ç—å—é
        function generateBrokenDevices() {
            const devices = [
                // –í—ã–≥–æ–¥–Ω—ã–µ (—Ä–µ–¥–∫–æ) - –ø—Ä–∏–±—ã–ª—å 20-40%
                { name: 'iPhone 12 - —Ç—Ä–µ—Å–Ω—É–ª–æ —Å—Ç–µ–∫–ª–æ', buyPrice: 120, repairCost: 80, sellPrice: 280, repairTime: 12 },
                { name: 'Samsung S22 - —Ä–∞–∑—ä—ë–º –∑–∞—Ä—è–¥–∫–∏', buyPrice: 90, repairCost: 50, sellPrice: 190, repairTime: 10 },
                
                // –°—Ä–µ–¥–Ω–∏–µ - –ø—Ä–∏–±—ã–ª—å 5-15%
                { name: 'Xiaomi 12 - —Ä–∞–∑–±–∏—Ç —ç–∫—Ä–∞–Ω', buyPrice: 100, repairCost: 95, sellPrice: 220, repairTime: 15 },
                { name: 'OnePlus 10 - –±–∞—Ç–∞—Ä–µ—è –≤–∑–¥—É–ª–∞—Å—å', buyPrice: 80, repairCost: 75, sellPrice: 170, repairTime: 12 },
                { name: 'Pixel 7 - –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è', buyPrice: 150, repairCost: 130, sellPrice: 300, repairTime: 18 },
                { name: 'iPad Air - —Ç—Ä–µ—â–∏–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ', buyPrice: 200, repairCost: 190, sellPrice: 420, repairTime: 20 },
                { name: 'Huawei P50 - –∫–∞–º–µ—Ä–∞', buyPrice: 110, repairCost: 100, sellPrice: 230, repairTime: 14 },
                
                // –ú–∞–ª–æ–≤—ã–≥–æ–¥–Ω—ã–µ - –ø—Ä–∏–±—ã–ª—å 0-5%
                { name: 'MacBook Pro - –∑–∞–ª–∏—Ç–∏–µ', buyPrice: 400, repairCost: 380, sellPrice: 800, repairTime: 35 },
                { name: 'iPhone 14 Pro - Face ID', buyPrice: 350, repairCost: 320, sellPrice: 680, repairTime: 28 },
                { name: 'Galaxy Z Fold - —à–∞—Ä–Ω–∏—Ä', buyPrice: 500, repairCost: 480, sellPrice: 1000, repairTime: 40 },
                { name: 'Sony WH-1000XM5 - –¥—Ä–∞–π–≤–µ—Ä', buyPrice: 80, repairCost: 75, sellPrice: 160, repairTime: 10 },
                
                // –ù–µ–≤—ã–≥–æ–¥–Ω—ã–µ (—É–±—ã—Ç–æ—á–Ω—ã–µ!) - —É–±—ã—Ç–æ–∫ 10-30%
                { name: 'iPhone 15 Pro Max - –º–∞—Ç–µ—Ä–∏–Ω–∫–∞', buyPrice: 600, repairCost: 550, sellPrice: 950, repairTime: 45 },
                { name: 'MacBook M3 - –ø–æ–≤—Ä–µ–∂–¥—ë–Ω —á–∏–ø', buyPrice: 800, repairCost: 750, sellPrice: 1200, repairTime: 50 },
                { name: 'PS5 - —Å–≥–æ—Ä–µ–ª GPU', buyPrice: 300, repairCost: 380, sellPrice: 550, repairTime: 35 },
                { name: 'Samsung S24 Ultra - —Ä–∞–∑–±–∏—Ç', buyPrice: 450, repairCost: 520, sellPrice: 850, repairTime: 38 },
                { name: 'Apple Watch Ultra - —É—Ç–æ–ø–ª–µ–Ω', buyPrice: 250, repairCost: 320, sellPrice: 480, repairTime: 25 },
                { name: 'Switch OLED - —É–±–∏—Ç —ç–∫—Ä–∞–Ω', buyPrice: 180, repairCost: 240, sellPrice: 350, repairTime: 22 },
                { name: 'AirPods Max - –æ–±–∞ –¥–∏–Ω–∞–º–∏–∫–∞', buyPrice: 200, repairCost: 280, sellPrice: 400, repairTime: 18 },
                
                // –û—á–µ–Ω—å –ø–ª–æ—Ö–∏–µ —Å–¥–µ–ª–∫–∏ - —É–±—ã—Ç–æ–∫ 30%+
                { name: 'iMac 27" - –º–∞—Ç—Ä–∏—Ü–∞ –º—ë—Ä—Ç–≤–∞—è', buyPrice: 400, repairCost: 650, sellPrice: 850, repairTime: 55 },
                { name: 'Dell XPS - —Å–≥–æ—Ä–µ–≤—à–∞—è –º–∞—Ç—å', buyPrice: 350, repairCost: 550, sellPrice: 750, repairTime: 45 },
                { name: 'Surface Pro - –Ω–µ—Ä–µ–º.', buyPrice: 300, repairCost: 500, sellPrice: 600, repairTime: 50 },
                { name: 'LG OLED 65" - –ø–∞–Ω–µ–ª—å', buyPrice: 600, repairCost: 900, sellPrice: 1200, repairTime: 60 },
                { name: 'Tesla Phone - —Ä–µ–¥–∫–∏–π', buyPrice: 400, repairCost: 700, sellPrice: 900, repairTime: 55 },
            ];
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏ –±–µ—Ä—ë–º 8 —Å–ª—É—á–∞–π–Ω—ã—Ö
            return devices.sort(() => Math.random() - 0.5).slice(0, 8);
        }
        
        let currentBrokenOffers = generateBrokenDevices();

        // ==================== RESEARCH ====================
        const RESEARCH_TREE = [
            { id: 'fast_production', name: '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞', cost: 25000, seconds: 8, effect: '–°–∫–æ—Ä–æ—Å—Ç—å +20%', unlockTier: 1 },
            { id: 'quality_control', name: '–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞', cost: 35000, seconds: 12, effect: '–ö–∞—á–µ—Å—Ç–≤–æ +10%', unlockTier: 1 },
            { id: 'tier2_unlock', name: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –ù–µ–æ–±—ã—á–Ω—ã–µ', cost: 150000, seconds: 20, effect: '–î–æ—Å—Ç—É–ø –∫ –ù–µ–æ–±—ã—á–Ω—ã–º', unlockTier: 1 },
            { id: 'component_factory', name: '–§–∞–±—Ä–∏–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤', cost: 1500000, seconds: 60, effect: '–°–≤–æ–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã', unlockTier: 1 },
            { id: 'tier3_unlock', name: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –†–µ–¥–∫–∏–µ', cost: 400000, seconds: 30, effect: '–î–æ—Å—Ç—É–ø –∫ –†–µ–¥–∫–∏–º', unlockTier: 2 },
            { id: 'mass_production', name: '–ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', cost: 300000, seconds: 25, effect: 'Capacity +100%', unlockTier: 2 },
            { id: 'tier4_unlock', name: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –≠–ø–∏—á–µ—Å–∫–∏–µ', cost: 800000, seconds: 40, effect: '–î–æ—Å—Ç—É–ø –∫ –≠–ø–∏—á–µ—Å–∫–∏–º', unlockTier: 3 },
            { id: 'automation', name: '–†–æ–±–æ—Ç–∏–∑–∞—Ü–∏—è', cost: 600000, seconds: 35, effect: '–†–∞—Å—Ö–æ–¥—ã -25%', unlockTier: 3 },
            { id: 'tier5_unlock', name: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ', cost: 1500000, seconds: 55, effect: '–î–æ—Å—Ç—É–ø –∫ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–º', unlockTier: 4 }
        ];

        // ==================== META: ACHIEVEMENTS / QUESTS / MARKET / REVIEWS / EVENTS ====================
        const ACHIEVEMENTS = [
            { id: 'first_product', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', desc: '–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç', reward: { money: 5000 } },
            { id: 'produce_1000', name: '–ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', desc: '–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ 1,000 —É—Å—Ç—Ä–æ–π—Å—Ç–≤', reward: { money: 20000 } },
            { id: 'sales_1m', name: '–ú–∞–≥–Ω–∞—Ç', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å $1,000,000 –Ω–∞ –ø—Ä–æ–¥–∞–∂–∞—Ö', reward: { money: 50000 } },
            { id: 'repair_50', name: '–†–µ–º–æ–Ω—Ç–Ω–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è', desc: '–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å 50 —É—Å—Ç—Ä–æ–π—Å—Ç–≤', reward: { money: 15000 } },
            { id: 'all_tiers', name: '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', desc: '–û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Ä–µ–¥–∫–æ—Å—Ç–∏', reward: { uniqueComponent: true } },
            { id: 'collect_100_cards', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', desc: '–ü–æ–ª—É—á–∏—Ç—å 100 –∫–∞—Ä—Ç–æ—á–µ–∫', reward: { rareCard: 5 } },
            { id: 'factory_lvl5', name: '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫', desc: '–£–ª—É—á—à–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É –¥–æ —É—Ä–æ–≤–Ω—è 5', reward: { money: 100000 } },
            { id: 'brand_80', name: '–ë—Ä–µ–Ω–¥', desc: '–î–æ—Å—Ç–∏—á—å —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏ 80%', reward: { reputation: 10 } },
            { id: 'staff_20', name: '–ò–º–ø–µ—Ä–∏—è', desc: '–ù–∞–Ω—è—Ç—å 20+ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤', reward: { money: 30000 } }
        ];

        const DAILY_QUEST_TEMPLATES = [
            { id: 'd_sell_100', name: '–ü—Ä–æ–¥–∞—Ç—å 100 —É—Å—Ç—Ä–æ–π—Å—Ç–≤', type: 'sell_units', target: 100, rewardMoney: 5000 },
            { id: 'd_repair_5', name: '–û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å 5 —É—Å—Ç—Ä–æ–π—Å—Ç–≤', type: 'repair_units', target: 5, rewardMoney: 4000 },
            { id: 'd_produce_500', name: '–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ 500 —É—Å—Ç—Ä–æ–π—Å—Ç–≤', type: 'produce_units', target: 500, rewardMoney: 7000 }
        ];

        const WEEKLY_QUEST_TEMPLATES = [
            { id: 'w_earn_500k', name: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å $500,000', type: 'earn_money', target: 500000, rewardMoney: 25000 },
            { id: 'w_sign_3', name: '–ü–æ–¥–ø–∏—Å–∞—Ç—å 3 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞', type: 'sign_contracts', target: 3, rewardMoney: 20000 },
            { id: 'w_campaign_5', name: '–ó–∞–ø—É—Å—Ç–∏—Ç—å 5 –∫–∞–º–ø–∞–Ω–∏–π', type: 'start_campaigns', target: 5, rewardMoney: 22000 }
        ];

        const COMPETITOR_DEFS = [
            {
                id: 'apple',
                name: 'Apple',
                legal: 'Apple Inc.',
                strategy: 'premium',
                share: 20,
                hq: '–ö—É–ø–µ—Ä—Ç–∏–Ω–æ, –°–®–ê',
                founded: 1976,
                ceo: 'Tim Cook',
                tagline: '–ü—Ä–µ–º–∏—É–º‚Äë—ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –∏ —Ñ–ª–∞–≥–º–∞–Ω—ã'
            },
            {
                id: 'samsung',
                name: 'Samsung',
                legal: 'Samsung Electronics Co., Ltd.',
                strategy: 'premium',
                share: 18,
                hq: '–°–µ—É–ª, –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
                founded: 1969,
                ceo: 'Jong‚ÄëHee Han',
                tagline: '–§–ª–∞–≥–º–∞–Ω—ã –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞'
            },
            {
                id: 'xiaomi',
                name: 'Xiaomi',
                legal: 'Xiaomi Corporation',
                strategy: 'budget',
                share: 8,
                hq: '–ü–µ–∫–∏–Ω, –ö–∏—Ç–∞–π',
                founded: 2010,
                ceo: 'Lei Jun',
                tagline: '–õ—É—á—à–µ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏ –∫–∞—á–µ—Å—Ç–≤–∞'
            },
            {
                id: 'huawei',
                name: 'Huawei',
                legal: 'Huawei Technologies Co., Ltd.',
                strategy: 'premium',
                share: 7,
                hq: '–®—ç–Ω—å—á–∂—ç–Ω—å, –ö–∏—Ç–∞–π',
                founded: 1987,
                ceo: 'Ren Zhengfei',
                tagline: '–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø—Ä–µ–º–∏—É–º‚Äë—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞'
            },
            {
                id: 'oppo',
                name: 'OPPO',
                legal: 'Guangdong OPPO Mobile Telecommunications',
                strategy: 'mid',
                share: 6,
                hq: '–î—É–Ω–≥—É–∞–Ω—å, –ö–∏—Ç–∞–π',
                founded: 2004,
                ceo: 'Pete Lau',
                tagline: '–°—Ç–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞'
            },
            {
                id: 'vivo',
                name: 'vivo',
                legal: 'vivo Communication Technology Co., Ltd.',
                strategy: 'mid',
                share: 6,
                hq: '–î—É–Ω–≥—É–∞–Ω—å, –ö–∏—Ç–∞–π',
                founded: 2009,
                ceo: 'Shen Wei',
                tagline: '–ú–∞—Å—Å–æ–≤—ã–π —Ä—ã–Ω–æ–∫ –∏ –∫–∞–º–µ—Ä—ã'
            },
            {
                id: 'lenovo',
                name: 'Lenovo',
                legal: 'Lenovo Group Limited',
                strategy: 'mid',
                share: 5,
                hq: '–ü–µ–∫–∏–Ω, –ö–∏—Ç–∞–π',
                founded: 1984,
                ceo: 'Yang Yuanqing',
                tagline: '–ü–ö –∏ –Ω–æ—É—Ç–±—É–∫–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞'
            },
            {
                id: 'hp',
                name: 'HP',
                legal: 'HP Inc.',
                strategy: 'mid',
                share: 5,
                hq: '–ü–∞–ª–æ‚Äë–ê–ª—å—Ç–æ, –°–®–ê',
                founded: 1939,
                ceo: 'Enrique Lores',
                tagline: '–ù–∞–¥—ë–∂–Ω—ã–µ –ü–ö –∏ –ø—Ä–∏–Ω—Ç–µ—Ä—ã'
            },
            {
                id: 'dell',
                name: 'Dell',
                legal: 'Dell Technologies Inc.',
                strategy: 'mid',
                share: 5,
                hq: '–†–∞—É–Ω–¥‚Äë–†–æ–∫, –°–®–ê',
                founded: 1984,
                ceo: 'Michael Dell',
                tagline: '–ë–∏–∑–Ω–µ—Å‚Äë–ª–∏–Ω–µ–π–∫–∏ –∏ —Å–µ—Ä–≤–∏—Å'
            },
            {
                id: 'sony',
                name: 'Sony',
                legal: 'Sony Group Corporation',
                strategy: 'premium',
                share: 4,
                hq: '–¢–æ–∫–∏–æ, –Ø–ø–æ–Ω–∏—è',
                founded: 1946,
                ceo: 'Kenichiro Yoshida',
                tagline: '–ú–µ–¥–∏–∞‚Äë—ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'
            },
            {
                id: 'lg',
                name: 'LG',
                legal: 'LG Electronics Inc.',
                strategy: 'mid',
                share: 4,
                hq: '–°–µ—É–ª, –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
                founded: 1958,
                ceo: 'William Cho',
                tagline: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –∏ –¥–∏—Å–ø–ª–µ–∏'
            },
            {
                id: 'asus',
                name: 'ASUS',
                legal: 'ASUSTeK Computer Inc.',
                strategy: 'mid',
                share: 4,
                hq: '–¢–∞–π–±—ç–π, –¢–∞–π–≤–∞–Ω—å',
                founded: 1989,
                ceo: 'Samson Hu',
                tagline: '–ü–ö, –Ω–æ—É—Ç–±—É–∫–∏ –∏ –≥–µ–π–º–∏–Ω–≥'
            }
        ];

        function initCompetitorsIfNeeded() {
            if (!gameState.market) gameState.market = { yourShare: 1, competitors: [] };
            if (!Array.isArray(gameState.market.competitors) || gameState.market.competitors.length === 0) {
                const totalShare = 99;
                const weightSum = COMPETITOR_DEFS.reduce((sum, c) => sum + (c.share || 1), 0) || 1;
                gameState.market.competitors = COMPETITOR_DEFS.map(c => ({
                    id: c.id,
                    name: c.name,
                    legal: c.legal,
                    hq: c.hq,
                    founded: c.founded,
                    ceo: c.ceo,
                    tagline: c.tagline,
                    strategy: c.strategy,
                    share: Math.max(1, Math.round(totalShare * ((c.share || 1) / weightSum))),
                    strength: c.strategy === 'premium' ? 70 : c.strategy === 'budget' ? 45 : c.strategy === 'mid' ? 55 : 30,
                    priceIndex: c.strategy === 'premium' ? 1.35 : c.strategy === 'budget' ? 0.85 : c.strategy === 'mid' ? 1.05 : 0.95,
                    innovation: c.strategy === 'premium' ? 55 : c.strategy === 'budget' ? 25 : c.strategy === 'mid' ? 45 : 35,
                    cash: 2000000 + Math.floor(Math.random() * 6000000),
                    cashFloor: 2000000
                }));

                // Your share starts at 1%
                gameState.market.yourShare = 1;

                // Normalize sum to 100
                let sum = gameState.market.yourShare + gameState.market.competitors.reduce((a, b) => a + (b.share || 0), 0);
                const diff = 100 - sum;
                if (diff !== 0 && gameState.market.competitors[0]) {
                    gameState.market.competitors[0].share = Math.max(1, gameState.market.competitors[0].share + diff);
                }
            }
        }

        function getDayOfWeekIndex(day) {
            // Day 1 -> week 1, dayOfWeek 1
            return ((Number(day || 1) - 1) % 7) + 1;
        }

        function getWeekIndex(day) {
            return Math.floor((Number(day || 1) - 1) / 7) + 1;
        }

        function ensureQuests() {
            if (!Array.isArray(gameState.dailyQuests)) gameState.dailyQuests = [];
            if (!Array.isArray(gameState.weeklyQuests)) gameState.weeklyQuests = [];

            // Daily quests: regenerate once per in-game day
            if (gameState.lastQuestDay !== gameState.day) {
                gameState.dailyQuests = DAILY_QUEST_TEMPLATES.map(q => ({ ...q, progress: 0, completed: false, claimed: false }));
                gameState.lastQuestDay = gameState.day;
            }

            // Weekly quests: regenerate once per week
            const w = getWeekIndex(gameState.day);
            if (gameState.lastQuestWeek !== w) {
                gameState.weeklyQuests = WEEKLY_QUEST_TEMPLATES.map(q => ({ ...q, progress: 0, completed: false, claimed: false }));
                gameState.lastQuestWeek = w;
            }
        }

        function addNews(text, type = 'info') {
            if (!Array.isArray(gameState.newsLog)) gameState.newsLog = [];
            gameState.newsLog.unshift({ id: Date.now() + Math.random(), day: gameState.day, text, type });
            if (gameState.newsLog.length > 30) gameState.newsLog.pop();
        }

        function applyTimedEffectsTick() {
            // Called on nextDay to decrease daysLeft on effects
            if (!Array.isArray(gameState.priceModifiers)) gameState.priceModifiers = [];
            gameState.priceModifiers = gameState.priceModifiers.filter(e => {
                e.daysLeft = (Number(e.daysLeft || 0) - 1);
                return e.daysLeft > 0;
            });
        }

        function getSalesSpeedMultiplierFromRating() {
            const r = Number(gameState.avgRating || 3.5);
            if (r >= 4.6) return 1.35;
            if (r >= 4.2) return 1.20;
            if (r >= 3.6) return 1.05;
            if (r >= 3.0) return 0.90;
            if (r >= 2.3) return 0.75;
            return 0.60;
        }

        function getActiveEffectMultiplier(kind) {
            // kind: 'sales', 'component_prices'
            const effects = Array.isArray(gameState.priceModifiers) ? gameState.priceModifiers : [];
            let mult = 1;
            effects.forEach(e => {
                if (e.kind === kind) mult *= Number(e.mult || 1);
            });
            return mult;
        }

        function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

        function computeReviewStars({ quality, sellPrice }) {
            // Heuristic: quality helps; excessive margin hurts; reputation helps.
            const q = Number(quality || 0);
            const price = Math.max(1, Number(sellPrice || 1));
            const rec = Math.max(1, q * 5);
            const margin = price / rec;
            const rep = Number(gameState.reputation || 0);

            let score = 3.0;
            score += clamp(q / 30, 0, 2.2);              // up to +2.2
            score += clamp(rep / 120, 0, 0.8);           // up to +0.8
            score -= clamp((margin - 1) * 1.8, 0, 2.8);  // up to -2.8
            score += (Math.random() * 0.6 - 0.3);        // +/- 0.3

            const stars = Math.round(clamp(score, 1, 5));
            return { stars, margin };
        }

        function addReview(productName, stars, text) {
            if (!Array.isArray(gameState.reviews)) gameState.reviews = [];
            gameState.reviews.unshift({ id: Date.now() + Math.random(), day: gameState.day, productName, stars, text, responded: false });
            if (gameState.reviews.length > 40) gameState.reviews.pop();

            // update averages
            gameState.reviewCount = Number(gameState.reviewCount || 0) + 1;
            const prevAvg = Number(gameState.avgRating || 3.5);
            const n = gameState.reviewCount;
            gameState.avgRating = ((prevAvg * (n - 1)) + stars) / n;
        }

        function respondToReview(id, mode) {
            const r = (gameState.reviews || []).find(x => String(x.id) === String(id));
            if (!r || r.responded) return;

            if (mode === 'compensate') {
                const cost = 3000 + Math.floor(Math.random() * 6000);
                if (gameState.money < cost) {
                    notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏', 'error');
                    return;
                }
                gameState.money -= cost;
                gameState.reputation = clamp(gameState.reputation + 2, 0, 100);
                gameState.brandAwareness = clamp(gameState.brandAwareness + 1, 0, 100);
                r.text += ' ‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é.';
                addNews(`üó£Ô∏è –í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –æ—Ç–∑—ã–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é (${formatMoney(cost)}).`, 'info');
                notify(`–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${formatMoney(cost)}`, 'success');
            } else {
                // polite response
                gameState.reputation = clamp(gameState.reputation + 1, 0, 100);
                r.text += ' ‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∏–ª–∞ –ø—É–±–ª–∏—á–Ω–æ.';
                addNews('üó£Ô∏è –í—ã –ø—É–±–ª–∏—á–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –æ—Ç–∑—ã–≤.', 'info');
                notify('–û—Ç–≤–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω', 'success');
            }

            r.responded = true;
            updateUI();
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'meta') renderMeta();
        }

        function claimQuestReward(kind, id) {
            const list = kind === 'weekly' ? (gameState.weeklyQuests || []) : (gameState.dailyQuests || []);
            const q = list.find(x => x.id === id);
            if (!q || !q.completed || q.claimed) return;
            q.claimed = true;
            gameState.money += Number(q.rewardMoney || 0);
            addNews(`üéØ –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –∫–≤–µ—Å—Ç: ${q.name} (+${formatMoney(q.rewardMoney)})`, 'success');
            notify(`üéØ –ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: +${formatMoney(q.rewardMoney)}`, 'success');
            updateUI();
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'meta') renderMeta();
        }

        function unlockAchievement(id) {
            if (!Array.isArray(gameState.unlockedAchievements)) gameState.unlockedAchievements = [];
            if (gameState.unlockedAchievements.includes(id)) return;
            gameState.unlockedAchievements.push(id);

            const a = ACHIEVEMENTS.find(x => x.id === id);
            if (!a) return;

            if (a.reward?.money) {
                gameState.money += a.reward.money;
                notify(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name} (+${formatMoney(a.reward.money)})`, 'success');
                addNews(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name} (+${formatMoney(a.reward.money)})`, 'success');
            }
            if (a.reward?.reputation) {
                gameState.reputation = clamp(gameState.reputation + a.reward.reputation, 0, 100);
                notify(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name} (+${a.reward.reputation} —Ä–µ–ø.)`, 'success');
                addNews(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name} (+${a.reward.reputation} —Ä–µ–ø.)`, 'success');
            }

            if (a.reward?.uniqueComponent) {
                // grant a special internal component batch
                const compType = 'processor_mobile';
                const name = 'Legendary Custom SoC (Award Edition)';
                const quality = 120;
                const tier = 5;
                const qty = 200;
                addInventory(compType, name, qty);
                gameState.customComponents.push({
                    id: Date.now() + Math.random(),
                    compType,
                    name,
                    price: 300,
                    quality,
                    tier,
                    custom: true,
                    internal: true,
                    source: 'achievement'
                });
                notify(`üèÜ ${a.name}: –ø–æ–ª—É—á–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç x${qty}`, 'success');
                addNews(`üèÜ ${a.name}: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥.`, 'success');
            }

            if (a.reward?.rareCard) {
                // drop a tier 5 batch directly to inventory (card-like)
                const compType = 'processor_mobile';
                const base = COMPONENTS[compType].items.find(i => i.tier === 5) || COMPONENTS[compType].items[COMPONENTS[compType].items.length - 1];
                const fake = createCard(compType, { ...base, tier: 5 });
                addInventory(fake.compType, fake.name, fake.qty);
                gameState.customComponents.push({
                    id: Date.now() + Math.random(),
                    compType: fake.compType,
                    name: fake.name,
                    price: Math.max(1, Math.round(fake.unitPrice * 0.95)),
                    quality: fake.quality,
                    tier: fake.tier,
                    custom: true,
                    internal: true,
                    source: 'achievement'
                });
                notify(`üèÜ ${a.name}: —Ä–µ–¥–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ¬´${getTierName(5)}¬ª ‚Üí —Å–∫–ª–∞–¥`, 'success');
                addNews(`üèÜ ${a.name}: —Ä–µ–¥–∫–∞—è ¬´${getTierName(5)}¬ª –ø–∞—Ä—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥.`, 'success');
            }

            updateUI();
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'meta') renderMeta();
        }

        function checkAchievements() {
            // First product
            if ((gameState.totalProduced || 0) >= 1) unlockAchievement('first_product');
            if ((gameState.totalProduced || 0) >= 1000) unlockAchievement('produce_1000');
            if ((gameState.totalSales || 0) >= 1000000) unlockAchievement('sales_1m');
            if ((gameState.totalRepaired || 0) >= 50) unlockAchievement('repair_50');
            if (getMaxTier() >= 5) unlockAchievement('all_tiers');
            if ((gameState.cardsReceivedTotal || 0) >= 100) unlockAchievement('collect_100_cards');
            if ((gameState.factoryLevel || 1) >= 5) unlockAchievement('factory_lvl5');
            if ((gameState.brandAwareness || 0) >= 80) unlockAchievement('brand_80');
            const empTotal = Object.values(gameState.employees || {}).reduce((a,b) => a+b, 0);
            if (empTotal >= 20) unlockAchievement('staff_20');
        }

        function updateQuestProgress(kind, amount) {
            // kind: sell_units, repair_units, produce_units, earn_money, sign_contracts, start_campaigns
            const upd = (q) => {
                if (q.completed) return;
                q.progress = Math.min(q.target, Number(q.progress || 0) + Number(amount || 0));
                if (q.progress >= q.target) {
                    q.completed = true;
                    notify(`üéØ –ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: ${q.name}`, 'success');
                    addNews(`üéØ –ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: ${q.name}`, 'success');
                }
            };
            (gameState.dailyQuests || []).filter(q => q.type === kind).forEach(upd);
            (gameState.weeklyQuests || []).filter(q => q.type === kind).forEach(upd);
        }

        function simulateCompetitorDay() {
            initCompetitorsIfNeeded();
            const comps = gameState.market.competitors || [];

            // Competitors adjust share slightly based on their strategy and your rating/awareness
            const repFactor = clamp((gameState.reputation || 0) / 100, 0, 1);
            const ratingFactor = clamp((gameState.avgRating || 3.5) / 5, 0, 1);
            const awarenessFactor = clamp((gameState.brandAwareness || 0) / 100, 0, 1);
            const yourPower = awarenessFactor * 0.45 + ratingFactor * 0.35 + repFactor * 0.20;
            const yourDelta = (yourPower - 0.55) * 0.6; // slower drift

            // Random competitor moves
            const moveRoll = Math.random();
            if (moveRoll < 0.22) {
                const c = comps[Math.floor(Math.random() * comps.length)];
                addNews(`üè¢ ${c.name} –≤—ã–ø—É—Å—Ç–∏–ª–∞ –Ω–æ–≤—É—é –ª–∏–Ω–µ–π–∫—É (${c.strategy}).`, 'info');
                // your sales slow slightly
                gameState.priceModifiers.push({ kind: 'sales', mult: 0.92, daysLeft: 2, reason: 'competitor_launch' });
            } else if (moveRoll < 0.36) {
                const c = comps.find(x => x.strategy === 'budget') || comps[0];
                addNews(`üè∑Ô∏è ${c.name} –Ω–∞—á–∞–ª–∞ –¥–µ–º–ø–∏–Ω–≥. –í–∞—à–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞–º–µ–¥–ª–∏–ª–∏—Å—å.`, 'warning');
                gameState.priceModifiers.push({ kind: 'sales', mult: 0.75, daysLeft: 2, reason: 'dumping' });
            } else if (moveRoll < 0.44) {
                const c = comps.find(x => x.strategy === 'premium') || comps[0];
                addNews(`‚≠ê ${c.name} –ø–æ–ª—É—á–∏–ª–∞ –≤—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —É –∫—Ä–∏—Ç–∏–∫–æ–≤.`, 'info');
                gameState.priceModifiers.push({ kind: 'sales', mult: 0.88, daysLeft: 2, reason: 'press' });
            }

            // Market share shift: if you're strong, you gain share (very slowly)
            const gain = clamp(yourDelta + (Math.random() * 0.24 - 0.12), -0.35, 0.35);
            gameState.market.yourShare = clamp((gameState.market.yourShare || 1) + gain, 1, 25);

            // Distribute the rest among competitors proportional to their strength
            const rest = 100 - gameState.market.yourShare;
            const totalStr = comps.reduce((a, c) => a + (Number(c.strength || 1)), 0) || 1;
            comps.forEach(c => {
                c.share = Math.max(1, Math.round(rest * (Number(c.strength || 1) / totalStr)));
                // keep competitor cash from shrinking if used elsewhere
                if (c.cashFloor) c.cash = Math.max(c.cash, c.cashFloor);
            });

            // Normalize sum to 100
            let sum = gameState.market.yourShare + comps.reduce((a, c) => a + c.share, 0);
            const diff = 100 - sum;
            if (diff !== 0 && comps[0]) comps[0].share = Math.max(1, comps[0].share + diff);
        }

        function tryRandomEvent() {
            // chance per nextDay
            const p = 0.22;
            if (Math.random() > p) return;

            const roll = Math.random();
            if (roll < 0.32) {
                // Positive: viral product
                gameState.priceModifiers.push({ kind: 'sales', mult: 1.5, daysLeft: 3, reason: 'viral' });
                gameState.brandAwareness = clamp(gameState.brandAwareness + 6, 0, 100);
                addNews('üöÄ –û–¥–∏–Ω –∏–∑ –≤–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å—Ç–∞–ª –≤–∏—Ä—É—Å–Ω—ã–º! –ü—Ä–æ–¥–∞–∂–∏ +50% –Ω–∞ 3 –¥–Ω—è.', 'success');
                notify('üöÄ –í–∏—Ä—É—Å–Ω—ã–π —Ö–∏—Ç! –ü—Ä–æ–¥–∞–∂–∏ —É—Å–∫–æ—Ä–µ–Ω—ã', 'success');
            } else if (roll < 0.50) {
                // Positive: industry award
                const money = 25000 + Math.floor(Math.random() * 40000);
                gameState.money += money;
                gameState.reputation = clamp(gameState.reputation + 5, 0, 100);
                addNews(`üèÜ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç—Ä–∞—Å–ª–µ–≤—É—é –Ω–∞–≥—Ä–∞–¥—É! +${formatMoney(money)} –∏ +5 —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.`, 'success');
                notify('üèÜ –û—Ç—Ä–∞—Å–ª–µ–≤–æ–π –ø—Ä–∏–∑!', 'success');
                updateQuestProgress('earn_money', money);
            } else if (roll < 0.64) {
                // Negative: component shortage (prices up)
                gameState.priceModifiers.push({ kind: 'component_prices', mult: 1.3, daysLeft: 2, reason: 'shortage' });
                addNews('‚õî –î–µ—Ñ–∏—Ü–∏—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: —Ü–µ–Ω—ã –≤ –º–∞—Ä–∫–µ—Ç–µ +30% –Ω–∞ 2 –¥–Ω—è.', 'warning');
                notify('‚õî –î–µ—Ñ–∏—Ü–∏—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (+30%)', 'warning');
            } else if (roll < 0.75) {
                // Negative: defect recall
                const loss = 15000 + Math.floor(Math.random() * 40000);
                gameState.money -= loss;
                gameState.reputation = clamp(gameState.reputation - 6, 0, 100);
                addNews(`üßØ –ë—Ä–∞–∫ –≤ –ø–∞—Ä—Ç–∏–∏: –æ—Ç–∑—ã–≤ –ø—Ä–æ–¥—É–∫—Ü–∏–∏. –ü–æ—Ç–µ—Ä–∏ ${formatMoney(loss)} –∏ -6 —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.`, 'error');
                notify('üßØ –û—Ç–∑—ã–≤ –ø–∞—Ä—Ç–∏–∏ (–±—Ä–∞–∫)', 'error');
            } else if (roll < 0.86) {
                // Negative: hackers
                const loss = 12000 + Math.floor(Math.random() * 35000);
                gameState.money -= loss;
                addNews(`üïµÔ∏è –•–∞–∫–µ—Ä—Å–∫–∞—è –∞—Ç–∞–∫–∞: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–æ—à–ª–æ—Å—å –≤ ${formatMoney(loss)}.`, 'error');
                notify('üïµÔ∏è –•–∞–∫–µ—Ä—ã –∞—Ç–∞–∫–æ–≤–∞–ª–∏!', 'error');
            } else {
                // Neutral choice: interview
                showModal(`
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-bold">üéôÔ∏è –ò–Ω—Ç–µ—Ä–≤—å—é</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <p class="text-gray-300 mb-4">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç –ø—Ä–æ—Å–∏—Ç –∏–Ω—Ç–µ—Ä–≤—å—é –æ –≤–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö. –ö–∞–∫ –æ—Ç–≤–µ—Ç–∏—Ç–µ?</p>
                    <div class="space-y-2">
                        <button class="btn-action w-full bg-blue-600 px-4 py-2 rounded-xl" onclick="eventInterviewAnswer('bold')">–ú—ã ‚Ññ1 –Ω–∞ —Ä—ã–Ω–∫–µ, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –æ—Ç—Å—Ç–∞—é—Ç</button>
                        <button class="btn-action w-full bg-gray-700 px-4 py-2 rounded-xl" onclick="eventInterviewAnswer('neutral')">–ú—ã –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ–º —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã</button>
                        <button class="btn-action w-full bg-green-600 px-4 py-2 rounded-xl" onclick="eventInterviewAnswer('humble')">–ú—ã —É—á–∏–º—Å—è –∏ —É–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</button>
                    </div>
                `);
            }
        }

        function eventInterviewAnswer(mode) {
            closeModal();
            if (mode === 'bold') {
                gameState.reputation = clamp(gameState.reputation + 3, 0, 100);
                gameState.brandAwareness = clamp(gameState.brandAwareness + 4, 0, 100);
                addNews('üéôÔ∏è –ò–Ω—Ç–µ—Ä–≤—å—é –≤—ã—à–ª–æ –¥–µ—Ä–∑–∫–∏–º: +3 —Ä–µ–ø—É—Ç–∞—Ü–∏–∏, +4 —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏.', 'info');
            } else if (mode === 'humble') {
                gameState.reputation = clamp(gameState.reputation + 5, 0, 100);
                addNews('üéôÔ∏è –ò–Ω—Ç–µ—Ä–≤—å—é –≤—ã—à–ª–æ —á–µ—Å—Ç–Ω—ã–º: +5 —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.', 'success');
            } else {
                gameState.brandAwareness = clamp(gameState.brandAwareness + 2, 0, 100);
                addNews('üéôÔ∏è –ò–Ω—Ç–µ—Ä–≤—å—é –ø—Ä–æ—à–ª–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ: +2 —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏.', 'info');
            }
            updateUI();
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'meta') renderMeta();
        }

        function renderMeta() {
            ensureQuests();
            initCompetitorsIfNeeded();
            checkAchievements();

            const achUnlocked = new Set(gameState.unlockedAchievements || []);

            const dailyHtml = (gameState.dailyQuests || []).map(q => {
                const pct = Math.round((q.progress / q.target) * 100);
                return `
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="flex justify-between items-center">
                            <div class="min-w-0">
                                <div class="font-bold text-sm truncate">${q.name}</div>
                                <div class="text-[11px] text-gray-400">–ù–∞–≥—Ä–∞–¥–∞: ${formatMoney(q.rewardMoney)}</div>
                            </div>
                            <button ${q.completed && !q.claimed ? '' : 'disabled'} onclick="claimQuestReward('daily','${q.id}')" class="btn-action px-3 py-1.5 rounded-lg text-xs ${q.completed && !q.claimed ? 'bg-green-600' : 'bg-gray-700 opacity-50'}">
                                ${q.claimed ? '–ü–æ–ª—É—á–µ–Ω–æ' : (q.completed ? '–ó–∞–±—Ä–∞—Ç—å' : '‚Ä¶')}
                            </button>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="repair-progress bg-blue-500 h-2 rounded-full" style="width:${clamp(pct,0,100)}%"></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-1">${q.progress}/${q.target}</div>
                    </div>
                `;
            }).join('');

            const weeklyHtml = (gameState.weeklyQuests || []).map(q => {
                const pct = Math.round((q.progress / q.target) * 100);
                return `
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="flex justify-between items-center">
                            <div class="min-w-0">
                                <div class="font-bold text-sm truncate">${q.name}</div>
                                <div class="text-[11px] text-gray-400">–ù–∞–≥—Ä–∞–¥–∞: ${formatMoney(q.rewardMoney)}</div>
                            </div>
                            <button ${q.completed && !q.claimed ? '' : 'disabled'} onclick="claimQuestReward('weekly','${q.id}')" class="btn-action px-3 py-1.5 rounded-lg text-xs ${q.completed && !q.claimed ? 'bg-purple-600' : 'bg-gray-700 opacity-50'}">
                                ${q.claimed ? '–ü–æ–ª—É—á–µ–Ω–æ' : (q.completed ? '–ó–∞–±—Ä–∞—Ç—å' : '‚Ä¶')}
                            </button>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="repair-progress bg-purple-500 h-2 rounded-full" style="width:${clamp(pct,0,100)}%"></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-1">${q.progress}/${q.target}</div>
                    </div>
                `;
            }).join('');

            const achHtml = ACHIEVEMENTS.map(a => {
                const done = achUnlocked.has(a.id);
                return `
                    <div class="bg-gray-800/50 rounded-xl p-3 border ${done ? 'border-green-500/30' : 'border-gray-700/30'}">
                        <div class="flex justify-between items-start gap-2">
                            <div class="min-w-0">
                                <div class="font-bold text-sm truncate">${a.name} ${done ? '‚úÖ' : ''}</div>
                                <div class="text-[11px] text-gray-400">${a.desc}</div>
                            </div>
                            <div class="text-[10px] text-gray-400 flex-shrink-0">
                                ${a.reward?.money ? `+${formatMoney(a.reward.money)}` : a.reward?.reputation ? `+${a.reward.reputation} —Ä–µ–ø.` : a.reward?.uniqueComponent ? '–£–Ω–∏–∫. –∫–æ–º–ø–æ–Ω–µ–Ω—Ç' : a.reward?.rareCard ? `${getTierName(5)} –ø–∞—Ä—Ç–∏—è` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const comps = (gameState.market.competitors || []);
            const compHtml = comps.map(c => `
                <div class="bg-gray-800/50 rounded-xl p-3">
                    <div class="flex justify-between items-start gap-2">
                        <div class="min-w-0">
                            <div class="font-bold text-sm truncate">${c.name}</div>
                            <div class="text-[11px] text-gray-400">–°—Ç—Ä–∞—Ç–µ–≥–∏—è: ${c.strategy} ‚Ä¢ HQ: ${escapeHtml(c.hq || '‚Äî')}</div>
                        </div>
                        <div class="text-blue-300 text-sm font-bold flex-shrink-0">${Math.round(c.share)}%</div>
                    </div>
                    <div class="mt-2 text-[11px] text-gray-400 flex justify-between">
                        <span>–ö—ç—à: <span class="text-white font-bold">${formatMoney(Math.round(c.cash || 0))}</span></span>
                        <span>–°–∏–ª–∞: <span class="text-white font-bold">${Math.round(c.strength || 0)}</span></span>
                    </div>
                    <button onclick="showTab('buyouts')" class="btn-action mt-2 w-full bg-gray-700 px-3 py-2 rounded-lg text-xs">ü§ù –ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–í—ã–∫—É–ø¬ª</button>
                </div>
            `).join('');

            const reviewsHtml = (gameState.reviews || []).slice(0, 10).map(r => {
                const stars = '‚òÖ'.repeat(r.stars) + '‚òÜ'.repeat(5 - r.stars);
                const canRespond = r.stars <= 2 && !r.responded;
                return `
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="flex justify-between items-start gap-2">
                            <div class="min-w-0">
                                <div class="text-sm font-bold truncate">${escapeHtml(r.productName)}</div>
                                <div class="text-yellow-400 text-xs">${stars}</div>
                                <div class="text-[11px] text-gray-400 whitespace-normal break-words">${escapeHtml(r.text)}</div>
                            </div>
                            <div class="text-[10px] text-gray-500 flex-shrink-0">–î–µ–Ω—å ${r.day}</div>
                        </div>
                        ${canRespond ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="respondToReview('${r.id}','reply')" class="btn-action flex-1 bg-blue-600 px-3 py-1.5 rounded-lg text-xs">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            <button onclick="respondToReview('${r.id}','compensate')" class="btn-action flex-1 bg-green-600 px-3 py-1.5 rounded-lg text-xs">–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è</button>
                        </div>` : (r.responded ? `<div class="mt-2 text-[10px] text-gray-500">–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏</div>` : '')}
                    </div>
                `;
            }).join('');

            const newsHtml = (gameState.newsLog || []).slice(0, 10).map(n => `
                <div class="bg-gray-800/50 rounded-xl p-3">
                    <div class="text-[11px] text-gray-500">–î–µ–Ω—å ${n.day}</div>
                    <div class="text-sm whitespace-normal break-words">${escapeHtml(n.text)}</div>
                </div>
            `).join('');

            const rating = Number(gameState.avgRating || 3.5);
            const salesMult = getSalesSpeedMultiplierFromRating();

            const rep = Number(gameState.reputation || 0);
            const awareness = Number(gameState.brandAwareness || 0);

            const shareHtml = (() => {
                const your = Math.round(gameState.market.yourShare || 0);
                const rows = [
                    { name: gameState.companyName || '–í—ã', share: your, cls: 'bg-emerald-500' },
                    ...(comps || []).map(c => ({ name: c.name, share: Math.round(c.share || 0), cls: 'bg-blue-500' }))
                ].sort((a, b) => b.share - a.share);

                return rows.map(r => `
                    <div class="space-y-1">
                        <div class="flex justify-between text-xs text-gray-300 gap-2">
                            <span class="truncate min-w-0">${escapeHtml(r.name)}</span>
                            <span class="text-white font-bold flex-shrink-0">${r.share}%</span>
                        </div>
                        <div class="w-full bg-gray-700/60 rounded-full h-2 overflow-hidden">
                            <div class="h-2 ${r.cls}" style="width:${clamp(r.share,0,100)}%"></div>
                        </div>
                    </div>
                `).join('');
            })();

            const effects = Array.isArray(gameState.priceModifiers) ? gameState.priceModifiers : [];
            const effectsHtml = effects.length === 0 ? '<div class="text-xs text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤</div>' : effects.slice(0, 8).map(e => {
                const label = e.kind === 'sales' ? '–ü—Ä–æ–¥–∞–∂–∏' : e.kind === 'component_prices' ? '–¶–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤' : e.kind;
                const pct = Math.round((Number(e.mult || 1) - 1) * 100);
                const sign = pct >= 0 ? '+' : '';
                const cls = pct >= 0 ? 'bg-emerald-600/25 border-emerald-500/30 text-emerald-200' : 'bg-red-600/25 border-red-500/30 text-red-200';
                return `
                    <div class="${cls} border rounded-lg px-2 py-1 text-[11px] flex justify-between gap-2">
                        <span class="truncate">${label}</span>
                        <span class="font-bold flex-shrink-0">${sign}${pct}% ‚Ä¢ ${Number(e.daysLeft||0)}–¥</span>
                    </div>
                `;
            }).join('');

            const html = `
                <div class="flex items-start justify-between gap-3 mb-4">
                    <div class="min-w-0">
                        <h3 class="text-xl font-extrabold">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <p class="text-gray-400 text-sm">–ö–≤–µ—Å—Ç—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —Ä—ã–Ω–æ–∫, —Å–æ–±—ã—Ç–∏—è –∏ –æ—Ç–∑—ã–≤—ã</p>
                    </div>
                    <button onclick="showTab('buyouts')" class="btn-action bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-xs whitespace-nowrap">ü§ù –í—ã–∫—É–ø –∫–æ–º–ø–∞–Ω–∏–π</button>
                </div>

                <div class="grid md:grid-cols-4 gap-3 mb-4">
                    <div class="bg-gray-800/50 rounded-2xl p-4">
                        <div class="text-gray-400 text-xs">–†–µ–π—Ç–∏–Ω–≥</div>
                        <div class="text-yellow-400 font-extrabold text-2xl">${rating.toFixed(2)} ‚òÖ</div>
                        <div class="text-[11px] text-gray-400">–ü—Ä–æ–¥–∞–∂–∏: <span class="text-white font-bold">x${salesMult.toFixed(2)}</span></div>
                    </div>
                    <div class="bg-gray-800/50 rounded-2xl p-4">
                        <div class="text-gray-400 text-xs">–†–µ–ø—É—Ç–∞—Ü–∏—è</div>
                        <div class="text-emerald-300 font-extrabold text-2xl">${Math.round(rep)}</div>
                        <div class="text-[11px] text-gray-400">–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥ –∏ —Å–¥–µ–ª–∫–∏</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-2xl p-4">
                        <div class="text-gray-400 text-xs">–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å</div>
                        <div class="text-blue-300 font-extrabold text-2xl">${Math.round(awareness)}%</div>
                        <div class="text-[11px] text-gray-400">–£—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–¥–∞–∂–∏</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-2xl p-4">
                        <div class="text-gray-400 text-xs">–î–æ–ª—è —Ä—ã–Ω–∫–∞</div>
                        <div class="text-purple-300 font-extrabold text-2xl">${Math.round(gameState.market.yourShare || 0)}%</div>
                        <div class="text-[11px] text-gray-400">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: <span class="text-white font-bold">${comps.length}</span></div>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-900/30 rounded-2xl p-4 lg:col-span-2">
                        <h4 class="font-bold mb-3">üåç –†–∞—Å–∫–ª–∞–¥ —Ä—ã–Ω–∫–∞</h4>
                        <div class="space-y-3">${shareHtml}</div>
                    </div>
                    <div class="bg-gray-900/30 rounded-2xl p-4">
                        <h4 class="font-bold mb-3">üß© –ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h4>
                        <div class="space-y-2">${effectsHtml}</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div class="bg-gray-900/30 rounded-2xl p-4">
                            <h4 class="font-bold mb-2">üéØ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</h4>
                            <div class="space-y-2">${dailyHtml || '<p class="text-gray-500 text-sm">–ù–µ—Ç</p>'}</div>
                        </div>
                        <div class="bg-gray-900/30 rounded-2xl p-4">
                            <h4 class="font-bold mb-2">üìÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∫–≤–µ—Å—Ç—ã</h4>
                            <div class="space-y-2">${weeklyHtml || '<p class="text-gray-500 text-sm">–ù–µ—Ç</p>'}</div>
                        </div>
                        <div class="bg-gray-900/30 rounded-2xl p-4">
                            <h4 class="font-bold mb-2">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h4>
                            <div class="space-y-2 max-h-80 overflow-y-auto">${achHtml}</div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="bg-gray-900/30 rounded-2xl p-4">
                            <h4 class="font-bold mb-2">‚≠ê –û—Ç–∑—ã–≤—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ)</h4>
                            <div class="space-y-2 max-h-80 overflow-y-auto">${reviewsHtml || '<p class="text-gray-500 text-sm">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>'}</div>
                        </div>
                        <div class="bg-gray-900/30 rounded-2xl p-4">
                            <h4 class="font-bold mb-2">üì∞ –ù–æ–≤–æ—Å—Ç–∏ / —Å–æ–±—ã—Ç–∏—è</h4>
                            <div class="space-y-2 max-h-64 overflow-y-auto">${newsHtml || '<p class="text-gray-500 text-sm">–ü–æ–∫–∞ —Ç–∏—Ö–æ‚Ä¶</p>'}</div>
                        </div>
                        <div class="bg-gray-900/30 rounded-2xl p-4">
                            <h4 class="font-bold mb-2">üè¢ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">${compHtml}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('tabContent').innerHTML = html;
        }

        // ==================== BUYOUTS (ACQUISITIONS) ====================
        function calcBuyoutPrice(c) {
            // Premium valuation based on cash, market share and strength
            const cash = Math.max(0, Number(c.cash || 0));
            const share = Math.max(0, Number(c.share || 0));
            const strength = Math.max(1, Number(c.strength || 1));
            const base = cash * 3.6 + share * 320000 + strength * 12000;
            // Smaller-share companies are significantly cheaper
            const sizeFactor = Math.max(0.35, Math.min(1.1, 0.35 + (share / 18)));
            // Reputation affects ability to negotiate slightly
            const repDisc = clamp((Number(gameState.reputation || 0) - 50) / 400, -0.04, 0.06);
            return Math.max(350000, Math.round(base * sizeFactor * (1 - repDisc)));
        }

        function canBuyoutCompany(c) {
            // Small companies are buyable; also allow if they are weakened (low cash)
            const share = Number(c.share || 0);
            const cash = Number(c.cash || 0);
            return share <= 10 || cash <= 250000;
        }

        function renderBuyouts() {
            initCompetitorsIfNeeded();
            const comps = gameState.market.competitors || [];

            const html = `
                <h3 class="text-xl font-bold mb-4">ü§ù –í—ã–∫—É–ø –∫–æ–º–ø–∞–Ω–∏–π</h3>
                <div class="bg-gray-800/50 rounded-2xl p-4 mb-4">
                    <div class="text-sm text-gray-300">–ó–¥–µ—Å—å –º–æ–∂–Ω–æ <span class="text-white font-bold">–≤—ã–∫—É–ø–∞—Ç—å</span> –Ω–µ–±–æ–ª—å—à–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø–æ–≤—ã—à–∞—Ç—å –¥–æ–ª—é —Ä—ã–Ω–∫–∞.</div>
                    <div class="mt-2 text-[11px] text-gray-400">–û–±—ã—á–Ω–æ –≤—ã–∫—É–ø –¥–æ—Å—Ç—É–ø–µ–Ω, –µ—Å–ª–∏ –¥–æ–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ ‚â§ 10% –∏–ª–∏ —É –Ω–µ—ë –º–∞–ª–æ –∫—ç—à–∞. –†–µ–ø—É—Ç–∞—Ü–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –Ω–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∂–∞—Ç—å —Ü–µ–Ω—É.</div>
                </div>

                <div class="grid md:grid-cols-2 gap-3">
                    ${comps.length === 0 ? `
                        <div class="bg-gray-800/50 rounded-2xl p-6 text-center text-gray-400">–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è –≤—ã–∫—É–ø–∞ ‚Äî –≤—ã —É–∂–µ –ª–∏–¥–µ—Ä —Ä—ã–Ω–∫–∞.</div>
                    ` : comps.map(c => {
                        const buyable = canBuyoutCompany(c);
                        const price = calcBuyoutPrice(c);
                        const badge = buyable ? 'bg-green-600/30 border-green-500/30' : 'bg-gray-800/50 border-gray-700/40';
                        return `
                            <div class="bg-gray-800/50 rounded-2xl p-4 border ${badge}">
                                <div class="flex justify-between items-start gap-2">
                                    <div class="min-w-0">
                                        <div class="font-extrabold text-sm truncate">${c.name}</div>
                                        <div class="text-[11px] text-gray-400 truncate">${escapeHtml(c.legal || '')}</div>
                                    </div>
                                    <div class="text-blue-300 font-extrabold text-sm flex-shrink-0">${Math.round(c.share)}%</div>
                                </div>

                                <div class="mt-2 text-[11px] text-gray-400 space-y-1">
                                    <div class="flex justify-between"><span>–®—Ç–∞–±-–∫–≤–∞—Ä—Ç–∏—Ä–∞</span><span class="text-white font-semibold">${escapeHtml(c.hq || '‚Äî')}</span></div>
                                    <div class="flex justify-between"><span>CEO</span><span class="text-white font-semibold">${escapeHtml(c.ceo || '‚Äî')}</span></div>
                                    <div class="flex justify-between"><span>–û—Å–Ω–æ–≤–∞–Ω–∞</span><span class="text-white font-semibold">${c.founded || '‚Äî'}</span></div>
                                    <div class="flex justify-between"><span>–ö—ç—à</span><span class="text-white font-semibold">${formatMoney(Math.round(c.cash || 0))}</span></div>
                                </div>

                                <div class="mt-3 bg-gray-900/30 rounded-xl p-3">
                                    <div class="text-[11px] text-gray-400">–û—Ü–µ–Ω–∫–∞ –≤—ã–∫—É–ø–∞</div>
                                    <div class="text-yellow-300 font-extrabold text-lg">${formatMoney(price)}</div>
                                    <div class="text-[11px] text-gray-400">${escapeHtml(c.tagline || '')}</div>
                                </div>

                                <button ${buyable ? '' : 'disabled'} onclick="buyoutCompany('${c.id}')" class="btn-action mt-3 w-full px-4 py-2 rounded-xl text-sm font-bold ${buyable ? 'bg-gradient-to-r from-emerald-600 to-green-600' : 'bg-gray-700 opacity-50 cursor-not-allowed'}">
                                    ü§ù –í—ã–∫—É–ø–∏—Ç—å
                                </button>
                                ${buyable ? '' : '<div class="mt-2 text-[10px] text-gray-500">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ: –∫–æ–º–ø–∞–Ω–∏—è —Å–ª–∏—à–∫–æ–º –∫—Ä—É–ø–Ω–∞—è –∏ –Ω–µ –æ—Å–ª–∞–±–ª–µ–Ω–∞.</div>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('tabContent').innerHTML = html;
        }

        function buyoutCompany(id) {
            initCompetitorsIfNeeded();
            const comps = gameState.market.competitors || [];
            const c = comps.find(x => x.id === id);
            if (!c) return;

            if (!canBuyoutCompany(c)) {
                notify('–≠—Ç–∞ –∫–æ–º–ø–∞–Ω–∏—è –ø–æ–∫–∞ —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–∞ –¥–ª—è –≤—ã–∫—É–ø–∞.', 'warning');
                return;
            }

            const price = calcBuyoutPrice(c);
            if (gameState.money < price) {
                notify(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –≤—ã–∫—É–ø–∞. –ù—É–∂–Ω–æ ${formatMoney(price)}`, 'error');
                return;
            }

            if (!confirm(`–í—ã–∫—É–ø–∏—Ç—å ${c.name} –∑–∞ ${formatMoney(price)}?`)) return;

            gameState.money -= price;
            // You gain their share, but cap to avoid 100% instantly
            gameState.market.yourShare = clamp((gameState.market.yourShare || 10) + (c.share || 0), 1, 95);
            gameState.market.competitors = comps.filter(x => x.id !== id);
            gameState.reputation = clamp((gameState.reputation || 0) + 1, 0, 100);

            addNews(`ü§ù –í—ã –≤—ã–∫—É–ø–∏–ª–∏ ${c.name}. –î–æ–ª—è —Ä—ã–Ω–∫–∞ –≤—ã—Ä–æ—Å–ª–∞.`, 'success');
            notify(`ü§ù –í—ã–∫—É–ø: ${c.name}`, 'success');

            updateUI();
            // refresh buyouts view
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'buyouts') renderBuyouts();
        }

        // Backward compatibility (old button)
        function tryAcquireCompetitor(id) {
            buyoutCompany(id);
        }

        // ==================== INIT ====================
        let repairInterval = null;

        function init() {
            loadGame();

            // Sanitize critical fields
            gameState.companyName = (gameState.companyName || '').trim();

            // Theme
            applyTheme();
            
            // Initialize card system
            if (!gameState.cardCollection) gameState.cardCollection = [];
            if (!gameState.selectedCardCategory) gameState.selectedCardCategory = 'smartphone';
            startCardTimer();

            // Dev logo clicks
            initDevLogo();

            // Screen sync
            const hasCompany = !!gameState.companyName;
            const welcome = document.getElementById('welcomeScreen');
            const create = document.getElementById('createCompanyScreen');
            const game = document.getElementById('gameScreen');
            const headerActions = document.getElementById('headerActions');
            const headerStats = document.getElementById('headerStats');

            if (hasCompany) {
                welcome?.classList.add('hidden');
                create?.classList.add('hidden');
                game?.classList.remove('hidden');
                headerActions?.classList.remove('hidden');
                headerStats?.classList.remove('hidden');

                if (!gameState.availableContracts || gameState.availableContracts.length === 0) {
                    generateContracts();
                }

                updateUI();
                showTab('home');
                startRepairTimer();
                startSalesTimer();
                startResearchTimer();
            } else {
                // Ensure only welcome is visible
                welcome?.classList.remove('hidden');
                create?.classList.add('hidden');
                game?.classList.add('hidden');
                headerActions?.classList.add('hidden');
                headerStats?.classList.add('hidden');
                updateUI();
            }
        }

        // ==================== REAL-TIME SALES ====================
        let salesInterval = null;

        function startSalesTimer() {
            if (salesInterval) clearInterval(salesInterval);
            salesInterval = setInterval(updateSales, 100);
        }

        function updateSales() {
            if (!gameState.sellingProducts) gameState.sellingProducts = [];
            
            let updated = false;
            gameState.sellingProducts = gameState.sellingProducts.filter(sp => {
                sp.progress += 100;
                if (sp.progress >= sp.totalTime) {
                    // –ü—Ä–æ–¥–∞–∂–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                    const revenue = sp.count * sp.price;
                    gameState.money += revenue;
                    gameState.totalSales += revenue;
                    notify(`üí∞ –ü—Ä–æ–¥–∞–Ω–æ ${sp.count.toLocaleString()}x ${sp.name} = ${formatMoney(revenue)}`, 'success');
                    updated = true;
                    return false;
                }
                return true;
            });
            
            if (updated) {
                updateUI();
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –ø—Ä–æ–¥–∞–∂
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'market' && gameState.sellingProducts.length > 0) {
                updateSalesProgress();
            }
        }

        function updateSalesProgress() {
            gameState.sellingProducts.forEach((sp, i) => {
                const el = document.getElementById(`sales-progress-${i}`);
                if (el) {
                    const pct = Math.min(100, (sp.progress / sp.totalTime) * 100);
                    el.style.width = pct + '%';
                }
                const timeEl = document.getElementById(`sales-time-${i}`);
                if (timeEl) {
                    const remaining = Math.ceil((sp.totalTime - sp.progress) / 1000);
                    timeEl.textContent = `${remaining}—Å`;
                }
            });
        }

        function startSelling(productIndex, count) {
            const product = gameState.products[productIndex];
            if (!product) return;
            
            const available = product.count || 1;
            const toSell = Math.min(count, available);
            
            if (toSell <= 0) {
                notify('–ù–µ—á–µ–≥–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å!', 'error');
                return;
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ä–∂–∏
            const recommendedPrice = product.quality * 5;
            const margin = product.sellPrice / recommendedPrice;
            
            // –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è: 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –º–∞—Ä–∂–µ 100%
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –º–∞—Ä–∂–µ
            // –£–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å—é –±—Ä–µ–Ω–¥–∞
            const baseTime = 9000;
            const marginMultiplier = Math.pow(margin, 4.2);
            const awarenessMultiplier = Math.max(0.2, 1 - (gameState.brandAwareness / 120));
            const countMultiplier = 1 + Math.log10(toSell) * 0.75;
            
            const totalTime = Math.round(baseTime * marginMultiplier * awarenessMultiplier * countMultiplier);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–¥–∞–∂
            if (!gameState.sellingProducts) gameState.sellingProducts = [];
            
            gameState.sellingProducts.push({
                name: product.name,
                count: toSell,
                price: product.sellPrice,
                quality: product.quality,
                progress: 0,
                totalTime: totalTime
            });
            
            // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
            product.count = available - toSell;
            
            // –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –µ—Å–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
            if (product.count <= 0) {
                gameState.products.splice(productIndex, 1);
            }
            
            updateUI();
            renderMarket();
            
            const seconds = (totalTime / 1000).toFixed(1);
            notify(`üì¶ –ù–∞—á–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∞ ${toSell.toLocaleString()}x ${product.name} (~${seconds}—Å)`, 'info');
        }

        function startRepairTimer() {
            if (repairInterval) clearInterval(repairInterval);
            repairInterval = setInterval(updateRepairs, 100);
        }

        let researchInterval = null;
        function startResearchTimer() {
            if (researchInterval) clearInterval(researchInterval);
            researchInterval = setInterval(updateResearch, 200);
        }

        function updateResearch() {
            if (!gameState.activeResearch || gameState.activeResearch.length === 0) return;
            const speedBoost = getResearchSpeedBoost();
            let updated = false;
            gameState.activeResearch = gameState.activeResearch.filter(task => {
                task.progress += 200 * speedBoost;
                if (task.progress >= task.totalTime) {
                    gameState.researchedTech.push(task.id);
                    const r = RESEARCH_TREE.find(x => x.id === task.id);
                    notify(`üéâ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ "${r.name}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ!`, 'success');
                    updated = true;
                    return false;
                }
                return true;
            });

            if (updated) {
                updateUI();
            }

            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'rnd') {
                renderRnD();
            }
        }

        function updateRepairs() {
            let updated = false;
            const speedBoost = getRepairSpeedBoost();
            const concurrencyDivider = Math.max(1, gameState.repairingDevices.length);
            const effectiveSpeed = speedBoost / concurrencyDivider;
            gameState.repairingDevices = gameState.repairingDevices.filter(d => {
                d.progress = Math.min(d.totalTime, d.progress + (100 * effectiveSpeed));
                if (d.progress >= d.totalTime) {
                    gameState.repairedDevices.push({
                        name: d.name,
                        sellPrice: d.sellPrice
                    });
                    gameState.totalRepaired++;
                    notify(`‚úÖ –†–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω: ${d.name}`, 'success');
                    updated = true;
                    return false;
                }
                return true;
            });
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (updated) {
                updateUI();
                if (activeTab?.dataset.tab === 'repair') {
                    renderRepair();
                }
            }
            if (activeTab?.dataset.tab === 'repair' && gameState.repairingDevices.length > 0) {
                updateRepairProgress();
            }
        }

        function updateRepairProgress() {
            gameState.repairingDevices.forEach((d, i) => {
                const el = document.getElementById(`repair-progress-${i}`);
                if (el) {
                    const pct = Math.min(100, (d.progress / d.totalTime) * 100);
                    el.style.width = pct + '%';
                }
                const timeEl = document.getElementById(`repair-time-${i}`);
                if (timeEl) {
                    const remaining = Math.max(0, Math.ceil((d.totalTime - d.progress) / 1000));
                    timeEl.textContent = `${remaining}—Å`;
                }
            });
        }

        function saveGame() {
            try {
                const data = JSON.stringify(gameState);
                // localStorage is the primary store (no strict 4KB limit)
                localStorage.setItem('techEmpireSave', data);
                // cookie is a fallback; may fail for large saves (cards/components)
                try { setCookie('techEmpireSave', data, 365); } catch (e) {}
            } catch(e) { console.error(e); }
        }

        function loadGame() {
            // Prefer localStorage (no 4KB limit). Fallback to cookie.
            const savedLS = localStorage.getItem('techEmpireSave');
            const savedCookie = getCookie('techEmpireSave');

            let parsed = null;

            // Try localStorage first
            if (savedLS) {
                try {
                    parsed = JSON.parse(savedLS);
                } catch (e) {
                    console.warn('Invalid localStorage save, trying cookie...', e);
                }
            }

            // If localStorage failed, try cookie
            if (!parsed && savedCookie) {
                try {
                    parsed = JSON.parse(savedCookie);
                } catch (e) {
                    console.warn('Invalid cookie save.', e);
                }
            }

            if (!parsed) return;

            gameState = { ...gameState, ...parsed };
            if (!gameState.repairingDevices) gameState.repairingDevices = [];
            if (!gameState.repairedDevices) gameState.repairedDevices = [];
            if (!gameState.activeResearch) gameState.activeResearch = [];
            if (!gameState.sellingProducts) gameState.sellingProducts = [];
            if (!gameState.inventory) gameState.inventory = {};
            if (!gameState.cardCollection) gameState.cardCollection = [];
            if (!gameState.selectedCardCategory) gameState.selectedCardCategory = 'smartphone';
            if (!gameState.customComponents) gameState.customComponents = [];

            // Settings defaults
            if (typeof gameState.devMenuUnlocked !== 'boolean') gameState.devMenuUnlocked = false;
            if (typeof gameState.devSkipCardCooldown !== 'boolean') gameState.devSkipCardCooldown = false;
            if (typeof gameState.darkTheme !== 'boolean') gameState.darkTheme = true;

            // Migrate older cards to new fields (qty/unitPrice/value)
            if (Array.isArray(gameState.cardCollection)) {
                gameState.cardCollection = gameState.cardCollection.map(c => {
                    const tier = Number(c.tier || 1);
                    const qty = Number(c.qty || 0) || rollCardQty(tier);
                    const unitPrice = Number(c.unitPrice || c.price || 1);
                    const value = Number(c.value || Math.round(unitPrice * qty));
                    return { ...c, qty, unitPrice, value };
                });
            }

            // New system: cards are auto-sent to warehouse (migrate old saves)
            if (Array.isArray(gameState.cardCollection) && gameState.cardCollection.length > 0) {
                gameState.cardCollection.forEach(card => {
                    const qty = Number(card.qty || 1);
                    const cleanName = stripTierPrefix(card.name);
                    addInventory(card.compType, cleanName, qty);
                    if (!gameState.customComponents) gameState.customComponents = [];
                    gameState.customComponents.push({
                        id: Date.now() + Math.random(),
                        compType: card.compType,
                        name: cleanName,
                        price: Math.max(1, Math.round(Number(card.unitPrice || card.price || 1) * 0.95)),
                        quality: card.quality,
                        tier: card.tier,
                        custom: true,
                        internal: true,
                        source: card.exclusive ? 'card_exclusive' : 'card'
                    });
                });
                gameState.cardCollection = [];
            }

            // Strip legacy prefixes (Prototype / Tier words) from existing card items (inventory + customComponents)
            try {
                const stripLegacy = (s) => stripTierPrefix(String(s || '').replace(/^Prototype\s+/i, ''));

                // inventory keys
                const inv = gameState.inventory || {};
                const invNext = {};
                Object.entries(inv).forEach(([k, v]) => {
                    const qty = Number(v || 0);
                    const idx = k.indexOf(':');
                    if (idx === -1) {
                        invNext[k] = (invNext[k] || 0) + qty;
                        return;
                    }
                    const t = k.slice(0, idx);
                    const nm = k.slice(idx + 1);
                    const newName = stripLegacy(nm);
                    const nk = makeInvKey(t, newName);
                    invNext[nk] = (invNext[nk] || 0) + qty;
                });
                gameState.inventory = invNext;

                // custom components
                if (!gameState.customComponents) gameState.customComponents = [];
                gameState.customComponents = gameState.customComponents.map(c => {
                    const nm = String(c?.name || '');
                    const cleaned = stripLegacy(nm);
                    if (cleaned !== nm) return { ...c, name: cleaned };
                    return c;
                });
            } catch (e) {}

            // Migrate/normalize inventory keys (fix quotes/entities mismatches)
            normalizeAllInventoryKeys();
        }

        function resetGame() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) {
                deleteCookie('techEmpireSave');
                localStorage.removeItem('techEmpireSave');
                location.reload();
            }
        }

        // ==================== UI ====================
        function updateUI() {
            const cn = document.getElementById('companyName');
            if (cn) cn.textContent = gameState.companyName;

            const moneyEl = document.getElementById('moneyDisplay');
            if (moneyEl) moneyEl.textContent = formatMoney(gameState.money);
            const dayEl = document.getElementById('dayDisplay');
            if (dayEl) dayEl.textContent = gameState.day;

            // Live update for Home tab (without re-render)
            const homeMoneyEl = document.getElementById('homeMoneyDisplay');
            if (homeMoneyEl) homeMoneyEl.textContent = formatMoney(gameState.money);
            const homeDayEl = document.getElementById('homeDayDisplay');
            if (homeDayEl) homeDayEl.textContent = gameState.day;

            const repEl = document.getElementById('reputationDisplay');
            if (repEl) repEl.textContent = gameState.reputation;

            let totalProducts = 0;
            (gameState.products || []).forEach(p => totalProducts += (p.count || 1));
            const prodEl = document.getElementById('productsDisplay');
            if (prodEl) prodEl.textContent = totalProducts.toLocaleString();
            const homeProdEl = document.getElementById('homeProductsDisplay');
            if (homeProdEl) homeProdEl.textContent = totalProducts.toLocaleString();

            let totalComponents = 0;
            Object.values(gameState.inventory || {}).forEach(v => totalComponents += Number(v || 0));
            const compEl = document.getElementById('componentsDisplay');
            if (compEl) compEl.textContent = totalComponents.toLocaleString();
            const homeCompEl = document.getElementById('homeComponentsDisplay');
            if (homeCompEl) homeCompEl.textContent = totalComponents.toLocaleString();

            const empTotal = Object.values(gameState.employees || {}).reduce((a,b) => a+b, 0);
            const empEl = document.getElementById('employeesDisplay');
            if (empEl) empEl.textContent = empTotal;
            const homeEmpEl = document.getElementById('homeEmployeesDisplay');
            if (homeEmpEl) homeEmpEl.textContent = empTotal.toLocaleString();

            const lvlEl = document.getElementById('levelDisplay');
            if (lvlEl) lvlEl.textContent = gameState.level;

            const homeSalesEl = document.getElementById('homeSalesDisplay');
            if (homeSalesEl) homeSalesEl.textContent = formatMoney(gameState.totalSales || 0);
            const homeProducedEl = document.getElementById('homeProducedDisplay');
            if (homeProducedEl) homeProducedEl.textContent = (gameState.totalProduced || 0).toLocaleString();

            saveGame();
        }

        function formatMoney(n) { return '$' + n.toLocaleString(); }

        // Safe for HTML attribute values (escapes quotes too)
        function escapeAttr(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // Safe for HTML text nodes (does NOT escape quotes, so names like 6.5" render normally)
        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        // Minimal JS string escaper (single-quote context). Note: avoid putting user strings into inline onclick.
        function escapeJs(value) {
            return String(value)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'");
        }

        // Helpers to avoid breaking HTML attributes when names contain double quotes (e.g. 6.5")
        function selectComponentFromEl(el) {
            const compType = el.dataset.compType;
            const name = el.dataset.name;
            const price = parseInt(el.dataset.price || '0', 10) || 0;
            const quality = parseInt(el.dataset.quality || '0', 10) || 0;
            const tier = parseInt(el.dataset.tier || '1', 10) || 1;
            const discount = parseFloat(el.dataset.discount || '0') || 0;
            selectComponent(compType, name, price, quality, tier, discount);
        }

        function selectBuildFromEl(el) {
            const compType = el.dataset.compType;
            const value = el.dataset.value;
            const price = parseInt(el.dataset.price || '0', 10) || 0;
            const quality = parseInt(el.dataset.quality || '0', 10) || 0;
            const optional = el.dataset.optional === '1';
            const disabled = el.dataset.disabled === '1';
            const labelText = el.dataset.label || '';
            selectBuildComponent(compType, value, price, quality, optional, disabled, labelText);
        }

        // ==================== INVENTORY KEY NORMALIZATION ====================
        function decodeHtmlEntities(str) {
            const txt = document.createElement('textarea');
            txt.innerHTML = String(str);
            return txt.value;
        }

        function normalizeCompName(name) {
            return decodeHtmlEntities(String(name)).replace(/\s+/g, ' ').trim();
        }

        function makeInvKey(compType, name) {
            return `${compType}:${normalizeCompName(name)}`;
        }

        function normalizeAllInventoryKeys() {
            const inv = gameState.inventory || {};
            const next = {};
            Object.entries(inv).forEach(([k, v]) => {
                const qty = Number(v || 0);
                const idx = k.indexOf(':');
                if (idx === -1) {
                    next[k] = (next[k] || 0) + qty;
                    return;
                }
                const t = k.slice(0, idx);
                const nm = k.slice(idx + 1);
                const nk = makeInvKey(t, nm);
                next[nk] = (next[nk] || 0) + qty;
            });
            gameState.inventory = next;
        }

        function getInventoryQty(compType, name) {
            const key = makeInvKey(compType, name);
            if (gameState.inventory[key] != null) return Number(gameState.inventory[key] || 0);

            // Fallback for very old saves: scan for matching normalized keys
            let sum = 0;
            const targetName = normalizeCompName(name);
            Object.entries(gameState.inventory || {}).forEach(([k, v]) => {
                const idx = k.indexOf(':');
                if (idx === -1) return;
                const t = k.slice(0, idx);
                const nm = k.slice(idx + 1);
                if (t === compType && normalizeCompName(nm) === targetName) {
                    sum += Number(v || 0);
                }
            });
            return sum;
        }

        function addInventory(compType, name, qty) {
            const key = makeInvKey(compType, name);
            gameState.inventory[key] = (Number(gameState.inventory[key] || 0) + Number(qty || 0));
        }

        function consumeInventory(compType, name, qty) {
            const key = makeInvKey(compType, name);
            const have = Number(gameState.inventory[key] || 0);
            if (have < qty) return false;
            const left = have - qty;
            if (left <= 0) delete gameState.inventory[key];
            else gameState.inventory[key] = left;
            return true;
        }

        // Notification system
        let notificationHistory = [];
        let unreadCount = 0;
        const MAX_TOASTS = 3;
        const MAX_HISTORY = 50;
        let activeToasts = 0;

        function notify(msg, type = 'info') {
            const colors = { 
                success: 'bg-green-600/70 border-green-500/50', 
                error: 'bg-red-600/70 border-red-500/50', 
                warning: 'bg-yellow-600/70 border-yellow-500/50', 
                info: 'bg-blue-600/70 border-blue-500/50' 
            };
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            // Add to history
            const timestamp = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            notificationHistory.unshift({ msg, type, timestamp, id: Date.now() });
            if (notificationHistory.length > MAX_HISTORY) notificationHistory.pop();
            
            // Update badge
            unreadCount++;
            updateNotifBadge();
            updateNotifPanel();
            
            // Show mini toast only if under limit
            if (activeToasts < MAX_TOASTS) {
                activeToasts++;
                const container = document.getElementById('toastContainer');
                const el = document.createElement('div');
                el.className = `mini-notif ${colors[type]} px-3 py-2 rounded-lg shadow-lg border text-xs flex items-center gap-2`;
                el.innerHTML = `
                    <span>${icons[type]}</span>
                    <span class="flex-1 break-words leading-snug">${msg}</span>
                    <button onclick="this.parentElement.classList.add('fade-out'); setTimeout(() => this.parentElement.remove(), 300); activeToasts--;" class="text-white/70 hover:text-white ml-1">√ó</button>
                `;
                container.appendChild(el);
                
                setTimeout(() => {
                    if (el.parentElement) {
                        el.classList.add('fade-out');
                        setTimeout(() => {
                            el.remove();
                            activeToasts--;
                        }, 300);
                    }
                }, 3000);
            }
        }

        function updateNotifBadge() {
            const badge = document.getElementById('notifBadge');
            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badge.classList.add('hidden');
            }
        }

        function updateNotifPanel() {
            const list = document.getElementById('notifList');
            if (notificationHistory.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center text-xs py-4">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
                return;
            }
            
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const bgColors = { success: 'bg-green-900/30', error: 'bg-red-900/30', warning: 'bg-yellow-900/30', info: 'bg-blue-900/30' };
            
            list.innerHTML = notificationHistory.slice(0, 30).map(n => `
                <div class="${bgColors[n.type]} rounded-lg px-2 py-1.5 text-xs flex items-start gap-2">
                    <span>${icons[n.type]}</span>
                    <div class="flex-1 min-w-0">
                        <div class="truncate">${n.msg}</div>
                        <div class="text-gray-500 text-[10px]">${n.timestamp}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleNotifPanel() {
            const panel = document.getElementById('notifPanel');
            const isOpen = panel.classList.contains('open');

            if (isOpen) {
                panel.classList.remove('open');
                setTimeout(() => panel.classList.add('hidden'), 200);
            } else {
                panel.classList.remove('hidden');
                requestAnimationFrame(() => panel.classList.add('open'));
                unreadCount = 0;
                updateNotifBadge();
            }
        }

        function clearAllNotifs() {
            notificationHistory = [];
            unreadCount = 0;
            updateNotifBadge();
            updateNotifPanel();
        }

        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notifPanel');
            const bellBtn = document.getElementById('notifBtn');
            if (!bellBtn?.contains(e.target) && !panel?.contains(e.target)) {
                panel?.classList.remove('open');
                setTimeout(() => panel?.classList.add('hidden'), 200);
            }
        });

        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        document.getElementById('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });

        function showCreateCompany() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('createCompanyScreen').classList.remove('hidden');
        }

        function createCompany() {
            const name = document.getElementById('companyNameInput').value.trim();
            if (!name) { notify('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!', 'error'); return; }
            gameState.companyName = name;

            document.getElementById('welcomeScreen')?.classList.add('hidden');
            document.getElementById('createCompanyScreen')?.classList.add('hidden');
            document.getElementById('gameScreen')?.classList.remove('hidden');
            document.getElementById('headerActions')?.classList.remove('hidden');
            document.getElementById('headerStats')?.classList.remove('hidden');

            generateContracts();
            startRepairTimer();
            startSalesTimer();
            startResearchTimer();
            updateUI();
            showTab('home');
            notify(`üéâ –ö–æ–º–ø–∞–Ω–∏—è "${name}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'active-tab');
                btn.classList.add('bg-gray-700');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn?.classList.remove('bg-gray-700');
            activeBtn?.classList.add('bg-blue-600', 'active-tab');
            
            const content = document.getElementById('tabContent');
            content.className = 'slide-in';
            
            switch(tabName) {
                case 'home': renderHome(); break;
                case 'production': renderProduction(); break;
                case 'components': renderComponents(); break;
                case 'factory': renderFactory(); break;
                case 'repair': renderRepair(); break;
                case 'contracts': renderContracts(); break;
                case 'rnd': renderRnD(); break;
                case 'marketing': renderMarketing(); break;
                case 'staff': renderStaff(); break;
                case 'market': renderMarket(); break;
                case 'warehouse': renderWarehouse(); break;
                case 'meta': renderMeta(); break;
                case 'buyouts': renderBuyouts(); break;
                case 'settings': renderSettings(); break;
            }
        }

        function getMaxTier() {
            let tier = 1;
            if (gameState.researchedTech.includes('tier2_unlock')) tier = 2;
            if (gameState.researchedTech.includes('tier3_unlock')) tier = 3;
            if (gameState.researchedTech.includes('tier4_unlock')) tier = 4;
            if (gameState.researchedTech.includes('tier5_unlock')) tier = 5;
            return tier;
        }

        // ==================== HOME ====================
        function renderHome() {
            let totalProducts = 0;
            gameState.products.forEach(p => totalProducts += (p.count || 1));

            let totalComponents = 0;
            Object.values(gameState.inventory || {}).forEach(v => totalComponents += Number(v || 0));

            const employeesTotal = Object.values(gameState.employees || {}).reduce((a,b) => a+b, 0);

            const salaryMonthly = (gameState.employees.engineers * 800)
                + (gameState.employees.marketers * 600)
                + (gameState.employees.repairmen * 500)
                + (gameState.employees.researchers * 1000);

            const daysUntilPayday = 30 - (gameState.day % 30);

            const html = `
                <div class="flex items-start justify-between gap-3 mb-4">
                    <div class="min-w-0">
                        <h3 class="text-xl font-bold">üè¢ ${escapeHtml(gameState.companyName || 'Tech Empire')}</h3>
                        <p class="text-gray-400 text-sm">–£—Ä–æ–≤–µ–Ω—å: <span class="text-green-400 font-bold">${gameState.level}</span> ‚Ä¢ –†–µ–ø—É—Ç–∞—Ü–∏—è: <span class="text-yellow-400 font-bold">${gameState.reputation}</span> ‚Ä¢ –£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å: <span class="text-blue-400 font-bold">${gameState.brandAwareness}%</span></p>
                    </div>
                </div>

                <div class="home-hero relative overflow-hidden rounded-2xl p-4 md:p-5 mb-3 bg-gradient-to-br from-emerald-500/18 via-sky-500/10 to-purple-500/18">
                    <div class="absolute -top-16 -right-16 w-56 h-56 rounded-full bg-emerald-400/10 blur-2xl"></div>
                    <div class="absolute -bottom-20 -left-20 w-64 h-64 rounded-full bg-blue-400/10 blur-2xl"></div>
                    <div class="absolute inset-0 opacity-30" style="background: radial-gradient(600px 260px at 30% 30%, rgba(255,255,255,0.10), transparent 60%);"></div>

                    <div class="relative flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[11px] text-gray-300">üí∞ –ë–∞–ª–∞–Ω—Å</span>
                                <span class="text-[11px] px-2 py-0.5 rounded-full bg-black/25 border border-white/10">üìÖ –î–µ–Ω—å <span id="homeDayDisplay" class="font-bold text-white">${gameState.day}</span></span>
                            </div>
                            <div id="homeMoneyDisplay" class="text-4xl md:text-5xl font-extrabold text-emerald-300 tracking-tight leading-none truncate">${formatMoney(gameState.money)}</div>
                            <div class="mt-2 text-[11px] text-gray-300">–†–µ–π—Ç–∏–Ω–≥: <span class="text-yellow-300 font-bold">${Number(gameState.avgRating||3.5).toFixed(2)}‚òÖ</span> ‚Ä¢ –†–µ–ø—É—Ç–∞—Ü–∏—è: <span class="text-white font-bold">${Math.round(gameState.reputation||0)}</span></div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-[11px] md:w-[340px]">
                            <div class="bg-black/20 rounded-xl px-3 py-2 border border-white/10">
                                <div class="text-gray-300">–ú–∞–∫—Å. —Ä–µ–¥–∫–æ—Å—Ç—å</div>
                                <div class="font-extrabold text-white">${getTierName(getMaxTier())}</div>
                            </div>
                            <div class="bg-black/20 rounded-xl px-3 py-2 border border-white/10">
                                <div class="text-gray-300">–ú–æ—â–Ω–æ—Å—Ç—å/–¥–µ–Ω—å</div>
                                <div class="font-extrabold text-white">${getEffectiveProductionCapacity().toLocaleString()}</div>
                            </div>
                            <div class="bg-black/20 rounded-xl px-3 py-2 border border-white/10">
                                <div class="text-gray-300">–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å</div>
                                <div class="font-extrabold text-white">${Math.round(gameState.brandAwareness||0)}%</div>
                            </div>
                            <div class="bg-black/20 rounded-xl px-3 py-2 border border-white/10">
                                <div class="text-gray-300">–î–æ–ª—è —Ä—ã–Ω–∫–∞</div>
                                <div class="font-extrabold text-white">${Math.round(gameState.market?.yourShare || 0)}%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4">
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="text-gray-400 text-xs">–¢–æ–≤–∞—Ä—ã</div>
                        <div id="homeProductsDisplay" class="text-blue-400 font-bold">${totalProducts.toLocaleString()}</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="text-gray-400 text-xs">–î–µ—Ç–∞–ª–∏</div>
                        <div id="homeComponentsDisplay" class="text-cyan-400 font-bold">${totalComponents.toLocaleString()}</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="text-gray-400 text-xs">–ü–µ—Ä—Å–æ–Ω–∞–ª</div>
                        <div id="homeEmployeesDisplay" class="text-purple-400 font-bold">${employeesTotal.toLocaleString()}</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="text-gray-400 text-xs">–ü—Ä–æ–¥–∞–∂–∏</div>
                        <div id="homeSalesDisplay" class="text-emerald-400 font-bold">${formatMoney(gameState.totalSales || 0)}</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-3">
                        <div class="text-gray-400 text-xs">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ</div>
                        <div id="homeProducedDisplay" class="text-orange-400 font-bold">${(gameState.totalProduced || 0).toLocaleString()}</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-gray-800/50 rounded-2xl p-4">
                        <h4 class="font-bold mb-2">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h4>
                        <div class="text-sm text-gray-300 space-y-1">
                            <div class="flex justify-between"><span>–ò–Ω–∂–µ–Ω–µ—Ä—ã</span><span class="text-white font-bold">${gameState.employees.engineers}</span></div>
                            <div class="flex justify-between"><span>–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∏</span><span class="text-white font-bold">${gameState.employees.marketers}</span></div>
                            <div class="flex justify-between"><span>–†–µ–º–æ–Ω—Ç–Ω–∏–∫–∏</span><span class="text-white font-bold">${gameState.employees.repairmen}</span></div>
                            <div class="flex justify-between"><span>–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏</span><span class="text-white font-bold">${gameState.employees.researchers}</span></div>
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            üí∏ –ó–∞—Ä–ø–ª–∞—Ç—ã/–º–µ—Å: <span class="text-yellow-400 font-bold">${formatMoney(salaryMonthly)}</span> ‚Ä¢ –î–æ –≤—ã–ø–ª–∞—Ç—ã: <span class="text-blue-400 font-bold">${daysUntilPayday} –¥–Ω.</span>
                        </div>

                        ${gameState.devMenuUnlocked ? `
                        <div class="mt-4 pt-3 border-t border-gray-700/50">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="font-bold text-sm">üõ†Ô∏è –ú–µ–Ω—é —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h5>
                                <span class="text-[10px] text-gray-400">Dev</span>
                            </div>
                            <div class="space-y-2">
                                <button onclick="devGrantMoney(1000000)" class="btn-action w-full bg-gradient-to-r from-emerald-600 to-green-600 px-3 py-2 rounded-lg text-xs font-bold">
                                    + $1,000,000
                                </button>
                                <label class="flex items-center justify-between bg-gray-700/40 rounded-lg px-3 py-2 text-xs">
                                    <span class="text-gray-200">–ü—Ä–æ–ø—É—Å–∫ –æ–∂–∏–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫</span>
                                    <input type="checkbox" ${gameState.devSkipCardCooldown ? 'checked' : ''} onchange="devToggleSkipCardCooldown(this.checked)">
                                </label>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="bg-gray-800/50 rounded-2xl p-4">
                        <h4 class="font-bold mb-2">üé¥ –ï–∂–µ—á–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h4>
                        <div id="cardDropTimer" class="text-gray-400 mb-3"></div>

                        <div class="mb-3">
                            <label class="block text-gray-400 mb-2 text-sm">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                            <div class="grid grid-cols-3 md:grid-cols-4 gap-2" id="cardCategoryGrid"></div>
                        </div>

                        <button id="claimCardsBtn" onclick="claimCards()" class="btn-action bg-gradient-to-r from-yellow-500 to-orange-600 px-5 py-2.5 rounded-xl font-bold text-sm w-full disabled:opacity-50 disabled:cursor-not-allowed">
                            üéÅ –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
                        </button>

                        <div id="cardDropResults" class="mt-4 hidden">
                            <h5 class="font-bold mb-3 text-green-400">‚ú® –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:</h5>
                            <div id="droppedCardsGrid" class="space-y-2"></div>
                        </div>

                        <div class="mt-4 text-[11px] text-gray-400">
                            üì¶ –í—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥ (–≤–∫–ª–∞–¥–∫–∞ ¬´–°–∫–ª–∞–¥¬ª).
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('tabContent').innerHTML = html;
            // re-render card UI into Home tab
            updateCardUI();
        }

        function getAvailableComponents(compType, maxTier) {
            const baseItems = COMPONENTS[compType]?.items || [];
            const customItems = (gameState.customComponents || []).filter(c => c.compType === compType);
            return [...baseItems, ...customItems]
                .filter(item => Number(item.tier || 1) <= Number(maxTier || 1))
                .sort((a, b) => {
                    const ta = Number(a.tier || 1), tb = Number(b.tier || 1);
                    if (ta !== tb) return ta - tb;
                    const qa = Number(a.quality || 0), qb = Number(b.quality || 0);
                    if (qa !== qb) return qa - qb;
                    return String(a.name || '').localeCompare(String(b.name || ''), 'ru');
                });
        }

        function getEffectiveProductionCapacity() {
            return gameState.productionCapacity + (gameState.employees.engineers * 500);
        }

        function getResearchSpeedBoost() {
            return 1 + (gameState.employees.researchers * 0.2);
        }

        function getRepairSpeedBoost() {
            const raw = 1 + (gameState.employees.repairmen * 0.2);
            return Math.min(3, raw);
        }

        function getMarketingBoost() {
            return 1 + (gameState.employees.marketers * 0.15);
        }

        // ==================== PRODUCTION ====================
        function renderProduction() {
            let html = `
                <h3 class="text-xl font-bold mb-4">üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h3>
                <p class="text-gray-400 mb-4">–ú–æ—â–Ω–æ—Å—Ç—å: <span class="text-green-400">${getEffectiveProductionCapacity().toLocaleString()}</span> —à—Ç/–¥–µ–Ω—å <span class="text-xs text-gray-500">(+${(gameState.employees.engineers * 500).toLocaleString()} –æ—Ç –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤)</span></p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            `;
            
            Object.entries(DEVICE_TYPES).forEach(([key, device]) => {
                html += `
                    <button onclick="openProductBuilder('${key}')" class="btn-action bg-gradient-to-br from-blue-600 to-purple-600 p-4 rounded-xl text-center">
                        <div class="text-3xl mb-2">${device.icon}</div>
                        <div class="font-medium text-sm">${device.name}</div>
                    </button>
                `;
            });
            
            html += `</div>
                <div class="mt-4 bg-gray-800/50 rounded-xl p-4">
                    <p class="text-gray-400 text-sm">üìä –ú–∞–∫—Å. —Ä–µ–¥–∫–æ—Å—Ç—å: ${getTierName(getMaxTier())} | –ò—Å—Å–ª–µ–¥—É–π—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª—É—á—à–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º</p>
                </div>
            `;
            
            document.getElementById('tabContent').innerHTML = html;
        }

        function openProductBuilder(deviceType) {
            const device = DEVICE_TYPES[deviceType];
            const maxTier = getMaxTier();
            
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">${device.icon} –°–±–æ—Ä–∫–∞: ${device.name}</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="buildForm" class="space-y-3">
                    <input type="hidden" id="buildDeviceType" value="${deviceType}">
                    <div>
                        <label class="block text-gray-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                        <input type="text" id="productName" placeholder="${gameState.companyName} ${device.name}" 
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 focus:border-blue-500 focus:outline-none">
                    </div>
            `;
            
            device.components.forEach(compType => {
                const compData = COMPONENTS[compType];
                if (!compData) return;
                
                const available = getAvailableComponents(compType, maxTier);
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π stock –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏)
                const stockMap = {};
                available.forEach(c => {
                    stockMap[c.name] = getInventoryQty(compType, c.name);
                });
                
                html += `
                    <div>
                        <label class="block text-gray-400 mb-1">${compData.name}</label>
                        ${(() => {
                            const optionItems = [];
                            optionItems.push({ label: '-- –í—ã–±–µ—Ä–∏—Ç–µ --', value: '', price: 0, quality: 0, optional: false, disabled: false });
                            if (compType === 'camera_ultra') {
                                optionItems.push({ label: '–ë–µ–∑ —É–ª—å—Ç—Ä–∞—à–∏—Ä–æ–∫–æ–π –∫–∞–º–µ—Ä—ã', value: '__none__', price: 0, quality: 0, optional: true, disabled: false });
                            }
                            if (compType === 'camera_tele') {
                                optionItems.push({ label: '–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ—Ç–æ –∫–∞–º–µ—Ä—ã', value: '__none__', price: 0, quality: 0, optional: true, disabled: false });
                            }
                            available.forEach(c => {
                                const stock = stockMap[c.name] || 0;
                                const isUnique = !!c.custom && !!c.internal && (c.source === 'card_exclusive' || c.source === 'achievement');
                                optionItems.push({
                                    label: `${c.name}${isUnique ? ' ‚ú®' : ''} ‚Ä¢ ${getTierName(c.tier)} ‚Ä¢ Q:${c.quality} [${stock} —à—Ç]${isUnique ? ' ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π' : ''}`,
                                    value: c.name,
                                    price: c.price,
                                    quality: c.quality,
                                    optional: false,
                                    disabled: stock === 0,
                                    unique: isUnique
                                });
                            });
                            const firstSelectable = optionItems.find(opt => !opt.disabled) || optionItems[0];
                            const labelText = firstSelectable ? firstSelectable.label : '-- –í—ã–±–µ—Ä–∏—Ç–µ --';
                            const safeLabel = escapeAttr(labelText);
                            const safeValue = escapeAttr(firstSelectable?.value || '');
                            return `
                                <div class="build-select-wrapper">
                                    <button type="button" class="build-select-btn w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-sm text-left flex items-center justify-between gap-2" onclick="toggleBuildDropdown('${escapeAttr(compType)}')">
                                        <span id="buildLabel_${escapeAttr(compType)}" class="truncate">${safeLabel}</span>
                                        <span class="text-gray-400">‚ñæ</span>
                                    </button>
                                    <div id="buildMenu_${escapeAttr(compType)}" class="build-select-menu hidden absolute left-0 right-0 mt-1 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-30">
                                        ${optionItems.map(item => {
                                            const disabledClass = item.disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-700';
                                            const uniqueClass = item.unique ? 'border-l-2 border-amber-400/70 bg-amber-500/5' : '';
                                            return `<button type="button" class="w-full text-left px-3 py-2 text-xs ${disabledClass} ${uniqueClass}" ${item.disabled ? 'disabled' : ''}
                                                data-comp-type="${escapeAttr(compType)}"
                                                data-value="${escapeAttr(item.value)}"
                                                data-price="${item.price}"
                                                data-quality="${item.quality}"
                                                data-optional="${item.optional ? '1' : '0'}"
                                                data-disabled="${item.disabled ? '1' : '0'}"
                                                data-label="${escapeAttr(item.label)}"
                                                onclick="selectBuildFromEl(this)">
                                                ${escapeHtml(item.label)}
                                            </button>`;
                                        }).join('')}
                                    </div>
                                    <input type="hidden" name="${escapeAttr(compType)}" class="component-select" id="buildInput_${escapeAttr(compType)}" value="${safeValue}" data-price="${firstSelectable?.price || 0}" data-quality="${firstSelectable?.quality || 0}" data-optional="${firstSelectable?.optional ? 'true' : 'false'}">
                                </div>
                            `;
                        })()}
                    </div>
                `;
            });
            
            html += `
                <div class="bg-gray-800/50 rounded-xl p-3 text-xs">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex flex-col gap-0.5 min-w-0">
                            <span class="text-gray-400">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å / –µ–¥.</span>
                            <span id="totalCost" class="text-red-400 font-bold truncate">$0</span>
                        </div>
                        <div class="flex flex-col gap-0.5 min-w-0">
                            <span class="text-gray-400">–ö–∞—á–µ—Å—Ç–≤–æ (Q)</span>
                            <span id="avgQuality" class="text-blue-400 font-bold">0</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-400 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–∞–∫—Å: ${getEffectiveProductionCapacity().toLocaleString()})</label>
                    <input type="number" id="quantity" value="100" min="1" max="${getEffectiveProductionCapacity()}"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 focus:border-blue-500 focus:outline-none">
                </div>
                <button type="button" onclick="buildProduct()" class="btn-action w-full bg-gradient-to-r from-green-500 to-emerald-600 py-3 rounded-xl font-bold">
                    üè≠ –ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                </button>
            </form>
            `;
            
            showModal(html);
            setTimeout(() => {
                updateBuildPreview();
            }, 100);
        }

        function updateBuildPreview() {
            let totalQuality = 0, count = 0, totalCost = 0;

            document.querySelectorAll('.component-select').forEach(inp => {
                const value = inp.value;
                if (!value) return;

                const price = parseInt(inp.dataset.price || '0', 10) || 0;
                const quality = parseInt(inp.dataset.quality || '0', 10) || 0;
                const isNoneOptional = (inp.dataset.optional === 'true' && value === '__none__');

                totalCost += price;
                if (!isNoneOptional) {
                    totalQuality += quality;
                    count++;
                }
            });

            const avgQ = count > 0 ? Math.round(totalQuality / count) : 0;

            const costEl = document.getElementById('totalCost');
            const qEl = document.getElementById('avgQuality');
            if (costEl) costEl.textContent = formatMoney(totalCost);
            if (qEl) qEl.textContent = avgQ > 0 ? avgQ : '‚Äî';
        }

        function buildProduct() {
            const deviceType = document.getElementById('buildDeviceType').value;
            const device = DEVICE_TYPES[deviceType];
            const name = document.getElementById('productName').value.trim() || `${gameState.companyName} ${device.name}`;
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            
            if (quantity <= 0 || quantity > getEffectiveProductionCapacity()) {
                notify('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!', 'error');
                return;
            }
            
            let totalQuality = 0, count = 0;
            const usedComponents = {};
            let canBuild = true;
            
            document.querySelectorAll('.component-select').forEach(inp => {
                const compType = inp.name;
                const selected = inp.value;

                if (!selected) {
                    canBuild = false;
                    return;
                }

                const isNoneOptional = (inp.dataset.optional === 'true' && selected === '__none__');
                if (isNoneOptional) {
                    return;
                }

                const stock = getInventoryQty(compType, selected);
                if (stock < quantity) {
                    notify(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: ${COMPONENTS[compType]?.name || compType}. –ù—É–∂–Ω–æ ${quantity}, –µ—Å—Ç—å ${stock}`, 'error');
                    canBuild = false;
                    return;
                }

                usedComponents[makeInvKey(compType, selected)] = quantity;
                const q = parseInt(inp.dataset.quality || '0', 10) || 0;
                totalQuality += q;
                count++;
            });
            
            if (!canBuild) return;
            
            const avgQ = count > 0 ? Math.round(totalQuality / count) : 0;
            const sellPrice = Math.round(avgQ * 4.2);
            
            Object.entries(usedComponents).forEach(([key, qty]) => {
                gameState.inventory[key] -= qty;
                if (gameState.inventory[key] <= 0) delete gameState.inventory[key];
            });
            
            const existingProduct = gameState.products.find(p => p.name === name && p.sellPrice === sellPrice && p.quality === avgQ);
            if (existingProduct) {
                existingProduct.count = (existingProduct.count || 1) + quantity;
            } else {
                gameState.products.push({
                    id: Date.now(),
                    name,
                    deviceType,
                    quality: avgQ,
                    sellPrice,
                    count: quantity
                });
            }
            
            gameState.totalProduced += quantity;
            gameState.experience += quantity;

            // Gradually increase market share with production (slow, model-based)
            const modelFactor = Math.max(1, (gameState.totalProduced || 0) / 2500);
            const repFactor = clamp((gameState.reputation || 0) / 100, 0.4, 1.2);
            const awarenessFactor = clamp((gameState.brandAwareness || 0) / 100, 0.4, 1.2);
            const gain = Math.min(0.18, (quantity / 60000) * (0.4 + repFactor * 0.3 + awarenessFactor * 0.3) * Math.min(2, modelFactor));
            if (gain > 0) {
                gameState.market.yourShare = clamp((gameState.market.yourShare || 1) + gain, 1, 25);
                const comps = gameState.market?.competitors || [];
                const rest = 100 - gameState.market.yourShare;
                const totalStr = comps.reduce((a, c) => a + (Number(c.strength || 1)), 0) || 1;
                comps.forEach(c => {
                    c.share = Math.max(1, Math.round(rest * (Number(c.strength || 1) / totalStr)));
                });
                let sum = gameState.market.yourShare + comps.reduce((a, c) => a + c.share, 0);
                const diff = 100 - sum;
                if (diff !== 0 && comps[0]) comps[0].share = Math.max(1, comps[0].share + diff);
            }

            checkLevelUp();
            closeModal();
            updateUI();
            notify(`‚úÖ –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ ${quantity.toLocaleString()}x ${name}!`, 'success');
        }

        // ==================== COMPONENTS BY DEVICE ====================
        let currentComponentCategory = 'smartphone';
        let currentWarehouseCategory = 'smartphone';

        function renderComponents() {
            const maxTier = getMaxTier();
            
            let html = `
                <h3 class="text-xl font-bold mb-4">üì¶ –ó–∞–∫–∞–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</h3>
                
                <!-- Category Tabs -->
                <div class="flex flex-wrap gap-1 mb-3 overflow-x-auto">
            `;
            
            Object.entries(COMPONENT_CATEGORIES).forEach(([key, cat]) => {
                const isActive = currentComponentCategory === key;
                html += `
                    <button onclick="switchComponentCategory('${key}')" 
                        class="device-tab btn-action ${isActive ? 'active bg-blue-600' : 'bg-gray-700'} px-2 py-1.5 rounded-lg text-[10px] font-medium whitespace-nowrap flex-shrink-0">
                        ${cat.name}
                    </button>
                `;
            });
            
            html += `</div>
                
                <!-- Global quantity -->
                <div class="bg-gray-800/50 rounded-xl p-2 mb-4">
                    <div class="flex flex-wrap items-center gap-1.5">
                        <label class="text-gray-400 text-xs">–ö–æ–ª-–≤–æ:</label>
                        <input type="number" id="globalQty" value="100" min="1" class="bg-gray-700 rounded-lg px-2 py-1.5 w-20 text-xs" oninput="updateTotalCost()">
                        <button onclick="applyGlobalQty()" class="btn-action bg-blue-600 px-2 py-1.5 rounded-lg text-xs whitespace-nowrap">‚úì</button>
                        <div class="flex items-center gap-1">
                            <span class="text-gray-400 text-xs">–ò—Ç–æ–≥–æ:</span>
                            <span id="totalOrderCost" class="text-yellow-400 font-bold text-xs">$0</span>
                        </div>
                        <button onclick="orderAllVisible()" class="btn-action bg-green-600 px-2 py-1.5 rounded-lg text-xs whitespace-nowrap">üõí –í—Å—ë</button>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="componentsList">
            `;
            
            // Filter components by category
            Object.entries(COMPONENTS).forEach(([compType, compData]) => {
                if (compData.category !== currentComponentCategory) return;
                
                // Market ordering: only market components (no internal/card/factory parts)
                const available = (COMPONENTS[compType]?.items || []).filter(item => item.tier <= maxTier);
                if (available.length === 0) return;
                
                html += `
                    ${(() => {
                        const initial = available[0];
                        const discount = getContractDiscount(compType);
                        const discountLabel = discount > 0 ? ` (-${Math.round(discount * 100)}%)` : '';
                        const initialLabel = `${initial.name} ‚Ä¢ ${getTierName(initial.tier)} ‚Ä¢ Q:${initial.quality} ‚Äî ${formatMoney(initial.price)}${discountLabel}`;
                        return `
                    <div class="bg-gray-800/50 rounded-xl p-2 component-order-card" data-type="${compType}" data-selected-name="${escapeAttr(initial.name)}" data-selected-price="${initial.price}" data-selected-quality="${initial.quality}" data-selected-tier="${initial.tier}">
                        <h4 class="font-bold mb-1.5 text-xs truncate">${compData.name}</h4>
                        <div class="relative comp-select-wrapper mb-1.5">
                            <button type="button" class="comp-select-btn w-full bg-gray-700 rounded-lg px-2 py-1 text-[10px] text-left flex items-center justify-between gap-2" onclick="toggleCompDropdown('${compType}')">
                                <span id="compLabel_${compType}" class="truncate">${initialLabel}</span>
                                <span class="text-gray-400">‚ñæ</span>
                            </button>
                            <div id="compMenu_${compType}" class="comp-menu hidden absolute left-0 right-0 mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-20 max-h-40 overflow-y-auto">
                                ${available.map(c => {
                                    const d = getContractDiscount(compType);
                                    const dLabel = d > 0 ? ` (-${Math.round(d * 100)}%)` : '';
                                    return `<button type="button" class="comp-option w-full text-left px-2 py-1 text-[10px] hover:bg-gray-700 whitespace-normal break-words"
                                        data-comp-type="${escapeAttr(compType)}"
                                        data-name="${escapeAttr(c.name)}"
                                        data-price="${c.price}"
                                        data-quality="${c.quality}"
                                        data-tier="${c.tier}"
                                        data-discount="${d}"
                                        onclick="selectComponentFromEl(this)">
                                        ${escapeHtml(c.name)} ‚Ä¢ ${escapeHtml(getTierName(c.tier))} ‚Ä¢ Q:${c.quality} ‚Äî ${formatMoney(c.price)}${dLabel}
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-gray-400 mb-1" id="priceRow_${compType}">
                            <span>–¶–µ–Ω–∞:</span>
                            <span id="price_${compType}" class="text-yellow-400 font-semibold">$0</span>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1" id="discount_${compType}"></div>
                        <div class="flex gap-1">
                            <input type="number" id="qty_${compType}" value="100" min="1" class="flex-1 bg-gray-700 rounded-lg px-1.5 py-1 text-xs comp-qty min-w-0" oninput="updateTotalCost()">
                            <button onclick="orderComponent('${compType}')" class="btn-action bg-blue-600 px-2 py-1 rounded-lg text-[10px] whitespace-nowrap">+</button>
                        </div>
                    </div>`;
                    })()}
                `;
            });
            
            html += `</div>
                
                <h4 class="font-bold mt-4 mb-2 text-sm">üìã –ù–∞ —Å–∫–ª–∞–¥–µ</h4>
                <div class="bg-gray-800/50 rounded-xl p-2 max-h-40 overflow-y-auto">
            `;
            
            const inventoryItems = Object.entries(gameState.inventory).filter(([k,v]) => {
                if (v <= 0) return false;
                const [type] = k.split(':');
                return COMPONENTS[type]?.category === currentComponentCategory;
            });
            
            if (inventoryItems.length === 0) {
                html += `<p class="text-gray-500 text-center text-xs py-2">–ü—É—Å—Ç–æ</p>`;
            } else {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-1">`;
                inventoryItems.forEach(([key, qty]) => {
                    const [type, name] = key.split(':');
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-1.5 flex justify-between items-center text-xs gap-1">
                            <span class="truncate min-w-0 flex-1">${name}</span>
                            <span class="text-blue-400 font-bold flex-shrink-0">${qty.toLocaleString()}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            document.getElementById('tabContent').innerHTML = html;
            setTimeout(() => updateTotalCost(), 50);
        }

        function switchComponentCategory(cat) {
            currentComponentCategory = cat;
            renderComponents();
        }

        function switchWarehouseCategory(cat) {
            currentWarehouseCategory = cat;
            renderWarehouse();
        }

        function applyGlobalQty() {
            const qty = document.getElementById('globalQty').value;
            document.querySelectorAll('.comp-qty').forEach(el => el.value = qty);
            updateTotalCost();
        }

        const COMPONENT_SPECIALTIES = {
            processor_mobile: 'processor',
            processor_desktop: 'processor',
            processor_console: 'processor',
            processor_tv: 'processor',
            processor_wearable: 'processor',
            display_mobile: 'display',
            display_tablet: 'display',
            display_laptop: 'display',
            display_tv: 'display',
            display_watch: 'display',
            battery_mobile: 'battery',
            battery_tablet: 'battery',
            battery_laptop: 'battery',
            battery_watch: 'battery',
            battery_headphones: 'battery',
            battery_vacuum: 'battery',
            memory_mobile: 'memory',
            memory_desktop: 'memory',
            memory_console: 'memory',
            storage: 'memory',
            camera_main: 'camera',
            camera_ultra: 'camera',
            camera_tele: 'camera',
            camera_front: 'camera',
            webcam: 'camera',
            gpu: 'gpu',
            gpu_console: 'gpu',
            modem: 'modem',
            body_mobile: 'body',
            body_tablet: 'body',
            body_laptop: 'body',
            body_watch: 'body',
            body_headphones: 'body',
            body_tv: 'body',
            body_console: 'body',
            body_appliance: 'body',
            body_vacuum: 'body',
            case: 'body'
        };

        function getContractDiscount(compType) {
            const specialty = COMPONENT_SPECIALTIES[compType];
            if (!specialty || !gameState.activeContracts) return 0;
            const discounts = gameState.activeContracts
                .filter(c => c.specialty === specialty)
                .map(c => c.discount || 0);
            return discounts.length > 0 ? Math.max(...discounts) : 0;
        }

        function getDiscountedPrice(compType, basePrice) {
            const discount = getContractDiscount(compType);
            return Math.round(basePrice * (1 - discount));
        }

        function toggleCompDropdown(compType) {
            const menu = document.getElementById(`compMenu_${compType}`);
            if (!menu) return;
            const isOpen = !menu.classList.contains('hidden');
            document.querySelectorAll('.comp-menu').forEach(m => m.classList.add('hidden'));
            if (!isOpen) menu.classList.remove('hidden');
        }

        function selectComponent(compType, name, price, quality, discount) {
            const card = document.querySelector(`.component-order-card[data-type="${compType}"]`);
            if (!card) return;
            card.dataset.selectedName = name;
            card.dataset.selectedPrice = price;
            card.dataset.selectedQuality = quality;
            const discountLabel = discount > 0 ? ` (-${Math.round(discount * 100)}%)` : '';
            const label = `${name} (Q:${quality}) - ${formatMoney(price)}${discountLabel}`;
            const labelEl = document.getElementById(`compLabel_${compType}`);
            if (labelEl) labelEl.textContent = label;
            const menu = document.getElementById(`compMenu_${compType}`);
            if (menu) menu.classList.add('hidden');
            updateTotalCost();
        }

        document.addEventListener('click', (e) => {
            const isSelect = e.target.closest('.comp-select-wrapper');
            if (!isSelect) {
                document.querySelectorAll('.comp-menu').forEach(m => m.classList.add('hidden'));
            }
            const isBuildSelect = e.target.closest('.build-select-wrapper');
            if (!isBuildSelect) {
                document.querySelectorAll('.build-select-menu').forEach(m => m.classList.add('hidden'));
            }
            const isFactorySelect = e.target.closest('.factory-select-wrapper');
            if (!isFactorySelect) {
                document.querySelectorAll('.factory-select-menu').forEach(m => m.classList.add('hidden'));
            }
        });

        function toggleBuildDropdown(compType) {
            const menu = document.getElementById(`buildMenu_${compType}`);
            if (!menu) return;
            const isOpen = !menu.classList.contains('hidden');
            document.querySelectorAll('.build-select-menu').forEach(m => m.classList.add('hidden'));
            if (!isOpen) menu.classList.remove('hidden');
        }

        function selectBuildComponent(compType, value, price, quality, optional, disabled, labelText) {
            if (disabled) return;
            const labelEl = document.getElementById(`buildLabel_${compType}`);
            const inputEl = document.getElementById(`buildInput_${compType}`);
            if (!labelEl || !inputEl) return;
            labelEl.textContent = labelText || '-- –í—ã–±–µ—Ä–∏—Ç–µ --';
            inputEl.value = value;
            inputEl.dataset.price = price;
            inputEl.dataset.quality = quality;
            inputEl.dataset.optional = optional ? 'true' : 'false';
            const menu = document.getElementById(`buildMenu_${compType}`);
            if (menu) menu.classList.add('hidden');
            updateBuildPreview();
        }

        function toggleFactoryDropdown(group) {
            const menu = document.getElementById(`${group}CompMenu`);
            if (!menu) return;
            const isOpen = !menu.classList.contains('hidden');
            document.querySelectorAll('.factory-select-menu').forEach(m => m.classList.add('hidden'));
            if (!isOpen) menu.classList.remove('hidden');
        }

        function selectFactoryType(group, value, labelText) {
            const labelEl = document.getElementById(`${group}CompLabel`);
            const inputEl = document.getElementById(`${group}CompType`);
            if (!labelEl || !inputEl) return;
            labelEl.textContent = labelText;
            inputEl.value = value;
            const menu = document.getElementById(`${group}CompMenu`);
            if (menu) menu.classList.add('hidden');
            updateFactoryCostPreviews();
        }

        function updateTotalCost() {
            const cards = document.querySelectorAll('.component-order-card');
            let totalCost = 0;
            
            cards.forEach(card => {
                const compType = card.dataset.type;
                const qtyInput = document.getElementById(`qty_${compType}`);
                if (!qtyInput) return;

                const basePrice = parseInt(card.dataset.selectedPrice || 0, 10) || 0;
                const price = getDiscountedPrice(compType, basePrice);
                const qty = parseInt(qtyInput.value) || 0;
                totalCost += price * qty;

                const priceEl = document.getElementById(`price_${compType}`);
                if (priceEl) {
                    priceEl.textContent = formatMoney(price);
                }
            });
            
            const el = document.getElementById('totalOrderCost');
            if (el) {
                el.textContent = formatMoney(totalCost);
                el.className = totalCost > gameState.money ? 'text-red-400 font-bold text-sm' : 'text-yellow-400 font-bold text-sm';
            }

            document.querySelectorAll('.component-order-card').forEach(card => {
                const compType = card.dataset.type;
                const label = document.getElementById(`discount_${compType}`);
                const discount = getContractDiscount(compType);
                if (label) {
                    label.textContent = discount > 0 ? `–°–∫–∏–¥–∫–∞ ${Math.round(discount * 100)}% –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É` : '';
                }
            });
        }

        function orderAllVisible() {
            const cards = document.querySelectorAll('.component-order-card');
            let totalCost = 0;
            const orders = [];
            
            cards.forEach(card => {
                const compType = card.dataset.type;
                const qtyInput = document.getElementById(`qty_${compType}`);
                const name = card.dataset.selectedName;
                const basePrice = parseInt(card.dataset.selectedPrice || 0, 10) || 0;
                const price = getDiscountedPrice(compType, basePrice);
                const qty = parseInt(qtyInput.value) || 0;
                
                if (qty > 0) {
                    totalCost += price * qty;
                    orders.push({ compType, name, price, qty });
                }
            });
            
            if (totalCost > gameState.money) {
                notify(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ ${formatMoney(totalCost)}`, 'error');
                return;
            }
            
            orders.forEach(o => {
                addInventory(o.compType, o.name, o.qty);
            });
            // Normalize just in case (old saves / entity issues)
            normalizeAllInventoryKeys();
            
            gameState.money -= totalCost;
            updateUI();
            renderComponents();
            notify(`‚úÖ –ó–∞–∫–∞–∑–∞–Ω–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ ${formatMoney(totalCost)}`, 'success');
        }

        function orderComponent(compType) {
            const card = document.querySelector(`.component-order-card[data-type="${compType}"]`);
            const qtyInput = document.getElementById(`qty_${compType}`);
            if (!card || !qtyInput) return;

            const name = card.dataset.selectedName;
            const basePrice = parseInt(card.dataset.selectedPrice || 0, 10) || 0;
            const price = getDiscountedPrice(compType, basePrice);
            const qty = parseInt(qtyInput.value) || 0;
            
            if (qty <= 0) { notify('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!', 'error'); return; }
            
            const totalCost = price * qty;
            if (gameState.money < totalCost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            
            gameState.money -= totalCost;
            addInventory(compType, name, qty);
            // Normalize just in case (old saves / entity issues)
            normalizeAllInventoryKeys();
            
            updateUI();
            renderComponents();
            notify(`‚úÖ –ó–∞–∫–∞–∑–∞–Ω–æ ${qty.toLocaleString()}x ${name}`, 'success');
        }

        function updateSellCompLine(i) {
            const slider = document.getElementById(`sellCompQty_${i}`);
            if (!slider) return;
            const qty = Math.max(0, parseInt(slider.value || '0', 10) || 0);
            const label = document.getElementById(`sellCompQtyLabel_${i}`);
            if (label) label.textContent = qty.toLocaleString();
            const unit = Math.max(0, parseInt(slider.dataset.unit || '0', 10) || 0);
            const total = document.getElementById(`sellCompTotal_${i}`);
            if (total) total.textContent = formatMoney(unit * qty);
        }

        function sellComponent(compType, name) {
            const qty = getInventoryQty(compType, name);
            if (qty <= 0) return;
            sellComponentQty(compType, name, qty);
        }

        function sellCompFromEl(btn) {
            const compType = btn?.dataset?.compType;
            const name = btn?.dataset?.name;
            const idx = parseInt(btn?.dataset?.idx || '0', 10) || 0;
            const slider = document.getElementById(`sellCompQty_${idx}`);
            const qty = slider ? (parseInt(slider.value || '0', 10) || 0) : 0;
            sellComponentQty(compType, name, qty);
        }

        function sellComponentQty(compType, name, qty) {
            // Use normalized inventory access to avoid quote/entity mismatches
            const stock = getInventoryQty(compType, name);
            const toSell = Math.min(stock, Math.max(0, Number(qty || 0)));
            if (toSell <= 0) return;

            const compData = COMPONENTS[compType];
            const baseItem = compData?.items?.find(item => normalizeCompName(item.name) === normalizeCompName(name));
            let basePrice = baseItem?.price;
            if (basePrice == null) {
                const custom = (gameState.customComponents || []).find(c => c.compType === compType && normalizeCompName(c.name) === normalizeCompName(name));
                basePrice = custom?.price ?? 0;
            }

            const sellPrice = Math.max(1, Math.round(Number(basePrice || 0) * 0.6));
            const revenue = sellPrice * toSell;

            // Consume using normalized keys
            consumeInventory(compType, name, toSell);

            gameState.money += revenue;
            updateUI();
            renderWarehouse();
            notify(`‚ôªÔ∏è –ü—Ä–æ–¥–∞–Ω–æ ${toSell.toLocaleString()}x ${name} –∑–∞ ${formatMoney(revenue)}`, 'success');
        }

        // Sell a received batch directly from the drop UI (uses card unit price, not market 60%)
        function sellDroppedBatchFromEl(btn) {
            const compType = btn?.dataset?.compType;
            const name = btn?.dataset?.name;
            const qty = parseInt(btn?.dataset?.qty || '0', 10) || 0;
            const unit = parseInt(btn?.dataset?.unit || '0', 10) || 0;
            sellDroppedBatch(compType, name, qty, unit, btn);
        }

        function sellDroppedBatch(compType, name, qty, unitPrice, btnEl = null) {
            if (!compType || !name || qty <= 0) return;

            const stock = getInventoryQty(compType, name);
            const toSell = Math.min(stock, qty);
            if (toSell <= 0) {
                notify('–ù–µ—á–µ–≥–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å (–ø–∞—Ä—Ç–∏—è —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∏–ª–∏ –ø—Ä–æ–¥–∞–Ω–∞).', 'warning');
                return;
            }

            // Sell for 70% of card unit price
            const sellUnit = Math.max(1, Math.round(Number(unitPrice || 0) * 0.7));
            const revenue = sellUnit * toSell;

            consumeInventory(compType, name, toSell);
            gameState.money += revenue;
            updateUI();

            if (btnEl) {
                btnEl.disabled = true;
                btnEl.classList.add('opacity-50', 'cursor-not-allowed');
                btnEl.textContent = '–ü—Ä–æ–¥–∞–Ω–æ';
            }

            notify(`üí∏ –ü—Ä–æ–¥–∞–Ω–æ: ${toSell.toLocaleString()}x ${name} = ${formatMoney(revenue)}`, 'success');
        }

        // ==================== FACTORY ====================
        function renderFactory() {
            const hasFactory = gameState.researchedTech.includes('component_factory');
            
            let html = `<h3 class="text-xl font-bold mb-4">‚öôÔ∏è –§–∞–±—Ä–∏–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</h3>`;
            
            if (!hasFactory) {
                html += `
                    <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-3">üîí</div>
                        <h4 class="font-bold mb-2">–§–∞–±—Ä–∏–∫–∞ –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞</h4>
                        <p class="text-gray-400">–ò—Å—Å–ª–µ–¥—É–π—Ç–µ "–§–∞–±—Ä–∏–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤" –≤ R&D (–¥–æ—Ä–æ–≥–æ–µ –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)</p>
                    </div>
                `;
            } else {
                html += `
                    <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
                        <p class="text-gray-400">–£—Ä–æ–≤–µ–Ω—å —Ñ–∞–±—Ä–∏–∫–∏: <span class="text-blue-400 font-bold">${gameState.factoryLevel}</span> | –°–Ω–∏–∂–µ–Ω–∏–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏: -${Math.round(getFactoryCostReduction() * 100)}% | –õ–∏–º–∏—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ —Ç–∏–ø–∞–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</p>
                        <button onclick="upgradeComponentFactory()" class="btn-action mt-2 bg-purple-600 px-4 py-2 rounded-lg">
                            ‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å (${formatMoney(600000 * (Number(gameState.factoryLevel) || 1))})
                        </button>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">–§–∞–±—Ä–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏. –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã—à–µ —Ä—ã–Ω–æ—á–Ω–æ–π –∏ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º —Ñ–∞–±—Ä–∏–∫–∏. –ö–∞—á–µ—Å—Ç–≤–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —É—Ä–æ–≤–Ω–µ–º, –Ω–æ –º–æ–∂–Ω–æ –ø–æ–≤—ã—à–∞—Ç—å –∑–∞ –¥–æ–ø–ª–∞—Ç—É.</p>

                    <div class="bg-gray-800/50 rounded-xl p-4 space-y-4">
                        <div>
                            <h4 class="font-bold mb-2">üì± –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h4>
                            <div class="grid md:grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–¢–∏–ø</label>
                                    <div class="factory-select-wrapper">
                                        <button type="button" class="factory-select-btn w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm text-left flex items-center justify-between gap-2" onclick="toggleFactoryDropdown('mobile')">
                                            <span id="mobileCompLabel" class="truncate">–ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä</span>
                                            <span class="text-gray-400">‚ñæ</span>
                                        </button>
                                        <div id="mobileCompMenu" class="factory-select-menu hidden absolute left-0 right-0 mt-1 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-30">
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'processor_mobile', '–ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä')">–ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'display_mobile', '–ú–æ–±–∏–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π')">–ú–æ–±–∏–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'battery_mobile', '–ú–æ–±–∏–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è')">–ú–æ–±–∏–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'camera_main', '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞')">–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'camera_ultra', '–£–ª—å—Ç—Ä–∞—à–∏—Ä–æ–∫–∞—è –∫–∞–º–µ—Ä–∞')">–£–ª—å—Ç—Ä–∞—à–∏—Ä–æ–∫–∞—è –∫–∞–º–µ—Ä–∞</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'camera_tele', '–¢–µ–ª–µ—Ñ–æ—Ç–æ –∫–∞–º–µ—Ä–∞')">–¢–µ–ª–µ—Ñ–æ—Ç–æ –∫–∞–º–µ—Ä–∞</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'camera_front', '–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞')">–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'memory_mobile', '–ú–æ–±–∏–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å')">–ú–æ–±–∏–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'modem', '–ú–æ–¥–µ–º')">–ú–æ–¥–µ–º</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('mobile', 'sensors', '–°–µ–Ω—Å–æ—Ä—ã —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞')">–°–µ–Ω—Å–æ—Ä—ã —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞</button>
                                        </div>
                                        <input type="hidden" id="mobileCompType" value="processor_mobile">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input id="mobileCompName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: HyperTech Mobile X1" class="w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                                    <input id="mobileCompQuality" type="number" min="10" value="10" oninput="updateFactoryCostPreviews()" class="w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                    <input id="mobileCompQty" type="number" min="1" value="200" oninput="updateFactoryCostPreviews()" class="w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div class="md:col-span-2 bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-400 space-y-1">
                                    <div class="flex justify-between"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å / –µ–¥.:</span><span id="mobileCompUnitCost">$0</span></div>
                                    <div class="flex justify-between"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞—Ä—Ç–∏–∏:</span><span id="mobileCompCost">$0</span></div>
                                    <div class="flex justify-between"><span>–õ–∏–º–∏—Ç –∫–∞—á–µ—Å—Ç–≤–∞:</span><span id="mobileCompMaxQ">0</span></div>
                                </div>
                            </div>
                            <button onclick="createCustomComponent('mobile')" class="btn-action mt-3 w-full bg-green-600 py-2 rounded-lg text-sm">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å –º–æ–±–∏–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                            </button>
                        </div>

                        <div class="pt-3 border-t border-gray-700/50">
                            <h4 class="font-bold mb-2">üñ•Ô∏è –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</h4>
                            <div class="grid md:grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–¢–∏–ø</label>
                                    <div class="factory-select-wrapper">
                                        <button type="button" class="factory-select-btn w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm text-left flex items-center justify-between gap-2" onclick="toggleFactoryDropdown('desktop')">
                                            <span id="desktopCompLabel" class="truncate">–î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä</span>
                                            <span class="text-gray-400">‚ñæ</span>
                                        </button>
                                        <div id="desktopCompMenu" class="factory-select-menu hidden absolute left-0 right-0 mt-1 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-30">
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'processor_desktop', '–î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä')">–î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'gpu', '–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞')">–í–∏–¥–µ–æ–∫–∞—Ä—Ç–∞</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'memory_desktop', '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å')">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'storage', '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å')">–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'motherboard', '–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞')">–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –ø–ª–∞—Ç–∞</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'psu', '–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è')">–ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'cooling', '–°–∏—Å—Ç–µ–º–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è')">–°–∏—Å—Ç–µ–º–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è</button>
                                            <button type="button" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-700" onclick="selectFactoryType('desktop', 'case', '–ö–æ—Ä–ø—É—Å –ü–ö')">–ö–æ—Ä–ø—É—Å –ü–ö</button>
                                        </div>
                                        <input type="hidden" id="desktopCompType" value="processor_desktop">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input id="desktopCompName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: HyperTech Core Z" class="w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                                    <input id="desktopCompQuality" type="number" min="10" value="10" oninput="updateFactoryCostPreviews()" class="w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-xs mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                    <input id="desktopCompQty" type="number" min="1" value="200" oninput="updateFactoryCostPreviews()" class="w-full bg-gray-900/60 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div class="md:col-span-2 bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-400 space-y-1">
                                    <div class="flex justify-between"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å / –µ–¥.:</span><span id="desktopCompUnitCost">$0</span></div>
                                    <div class="flex justify-between"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞—Ä—Ç–∏–∏:</span><span id="desktopCompCost">$0</span></div>
                                    <div class="flex justify-between"><span>–õ–∏–º–∏—Ç –∫–∞—á–µ—Å—Ç–≤–∞:</span><span id="desktopCompMaxQ">0</span></div>
                                </div>
                            </div>
                            <button onclick="createCustomComponent('desktop')" class="btn-action mt-3 w-full bg-blue-600 py-2 rounded-lg text-sm">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('tabContent').innerHTML = html;
            const mobileTypeSelect = document.getElementById('mobileCompType');
            const desktopTypeSelect = document.getElementById('desktopCompType');
            if (mobileTypeSelect) mobileTypeSelect.addEventListener('change', updateFactoryCostPreviews);
            if (desktopTypeSelect) desktopTypeSelect.addEventListener('change', updateFactoryCostPreviews);
            updateFactoryCostPreviews();
        }

        function upgradeComponentFactory() {
            const currentLevel = Number(gameState.factoryLevel) || 1;
            const cost = 600000 * currentLevel;
            if (gameState.money < cost) {
                notify(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ ${formatMoney(cost)}`, 'error');
                return;
            }
            gameState.money -= cost;
            gameState.factoryLevel = currentLevel + 1;
            updateUI();
            renderFactory();
            notify(`‚¨ÜÔ∏è –§–∞–±—Ä–∏–∫–∞ —É–ª—É—á—à–µ–Ω–∞ –¥–æ —É—Ä–æ–≤–Ω—è ${gameState.factoryLevel}!`, 'success');
        }

        function createCustomComponent(group) {
            const isMobile = group === 'mobile';
            const typeEl = document.getElementById(isMobile ? 'mobileCompType' : 'desktopCompType');
            const nameEl = document.getElementById(isMobile ? 'mobileCompName' : 'desktopCompName');
            const qualityEl = document.getElementById(isMobile ? 'mobileCompQuality' : 'desktopCompQuality');
            const qtyEl = document.getElementById(isMobile ? 'mobileCompQty' : 'desktopCompQty');

            const compType = typeEl?.value;
            const name = nameEl?.value.trim();
            const quality = parseInt(qualityEl?.value) || 0;
            const qty = Math.max(1, parseInt(qtyEl?.value) || 0);

            if (!compType || !name || quality <= 0) {
                notify('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!', 'error');
                return;
            }

            const maxQuality = getFactoryMaxQuality(compType);
            
            // –ë–õ–û–ö–ò–†–£–ï–ú —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã—à–µ –ª–∏–º–∏—Ç–∞
            if (quality > maxQuality) {
                notify(`–ö–∞—á–µ—Å—Ç–≤–æ ${quality} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ${maxQuality}! –£–ª—É—á—à–∏—Ç–µ —Ñ–∞–±—Ä–∏–∫—É.`, 'error');
                return;
            }
            
            const costPerUnit = calculateFactoryCost(quality, compType);
            const totalCost = costPerUnit * qty;

            if (gameState.money < totalCost) {
                notify(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞. –ù—É–∂–Ω–æ ${formatMoney(totalCost)}.`, 'error');
                return;
            }

            gameState.money -= totalCost;
            const tier = Math.max(1, Math.min(6, Math.ceil(quality / 20)));
            const customComponent = {
                id: Date.now(),
                compType,
                name,
                price: Math.round(costPerUnit * 0.9),
                quality,
                tier,
                custom: true,
                internal: true
            };

            if (!gameState.customComponents) gameState.customComponents = [];
            gameState.customComponents.push(customComponent);

            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
            addInventory(compType, name, qty);
            // Normalize just in case (old saves / entity issues)
            normalizeAllInventoryKeys();

            nameEl.value = '';
            updateUI();
            renderFactory();
            notify(`‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç "${name}" —Å–æ–∑–¥–∞–Ω (Q:${quality}, ${getTierName(tier)}) –∏ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥ x${qty}`, 'success');
        }

        // ==================== REPAIR ====================
        function renderRepair() {
            let html = `
                <h3 class="text-xl font-bold mb-4">üîß –†–µ–º–æ–Ω—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h3>
                <div class="bg-gray-800/50 rounded-xl p-3 mb-4">
                    <p class="text-gray-400 text-sm">‚ö†Ô∏è <span class="text-yellow-400">–í–Ω–∏–º–∞–Ω–∏–µ!</span> –ù–µ –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤—ã–≥–æ–¥–Ω—ã! –°—á–∏—Ç–∞–π—Ç–µ –ø—Ä–∏–±—ã–ª—å –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π.</p>
                    <div class="text-xs text-gray-500 mt-1">‚è±Ô∏è –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞: x${getRepairSpeedBoost().toFixed(1)} ‚Ä¢ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: ${Math.max(1, gameState.employees.repairmen)}</div>
                    <button onclick="refreshBrokenOffers()" class="btn-action mt-2 bg-purple-600 px-3 py-1.5 rounded-lg text-sm">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</button>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-3">üè™ –°–∫—É–ø–∫–∞ —Å–ª–æ–º–∞–Ω–Ω—ã—Ö</h4>
                        <div class="space-y-2 max-h-72 overflow-y-auto">
            `;
            
            currentBrokenOffers.forEach((d, i) => {
                const totalCost = d.buyPrice + d.repairCost;
                const profit = d.sellPrice - totalCost;
                const profitPct = Math.round((profit / totalCost) * 100);
                
                let profitColor = 'text-green-400';
                let profitIcon = 'üìà';
                let borderColor = 'border-transparent';
                
                if (profitPct < 0) {
                    profitColor = 'text-red-400';
                    profitIcon = 'üìâ';
                    borderColor = 'border-red-500/30';
                } else if (profitPct < 10) {
                    profitColor = 'text-yellow-400';
                    profitIcon = '‚ö†Ô∏è';
                    borderColor = 'border-yellow-500/30';
                } else if (profitPct > 20) {
                    borderColor = 'border-green-500/30';
                }
                
                html += `
                    <div class="bg-gray-700/50 rounded-lg p-2 border ${borderColor}">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-sm font-medium">${d.name}</div>
                            <button onclick="skipBrokenOffer(${i})" class="text-gray-500 hover:text-red-400 text-xs">‚úï</button>
                        </div>
                        <div class="text-xs text-gray-400 mb-1">
                            –ü–æ–∫—É–ø–∫–∞: ${formatMoney(d.buyPrice)} + –†–µ–º–æ–Ω—Ç: ${formatMoney(d.repairCost)} = <span class="text-white">${formatMoney(totalCost)}</span>
                        </div>
                        <div class="text-xs mb-2">
                            –ü—Ä–æ–¥–∞–∂–∞: ${formatMoney(d.sellPrice)} | ${profitIcon} <span class="${profitColor}">${profit >= 0 ? '+' : ''}${formatMoney(profit)} (${profitPct}%)</span> | ‚è±Ô∏è ${d.repairTime}—Å
                        </div>
                        <button onclick="buyBrokenNew(${i})" 
                            class="btn-action w-full ${profit >= 0 ? 'bg-blue-600' : 'bg-red-600/50'} px-3 py-1 rounded-lg text-sm">
                            üõí –ö—É–ø–∏—Ç—å –∑–∞ ${formatMoney(d.buyPrice)}
                        </button>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-3">üì¶ –û–∂–∏–¥–∞—é—Ç —Ä–µ–º–æ–Ω—Ç–∞ (${gameState.brokenDevices.length})</h4>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
            `;
            
            if (gameState.brokenDevices.length === 0) {
                html += `<p class="text-gray-500 text-center py-2">–ü—É—Å—Ç–æ</p>`;
            } else {
                gameState.brokenDevices.forEach((d, i) => {
                    const canRepair = gameState.money >= d.repairCost && gameState.employees.repairmen > 0;
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-2">
                            <div class="text-sm mb-1">${d.name}</div>
                            <div class="flex gap-2">
                                <button onclick="startRepair(${i})" class="btn-action flex-1 ${canRepair ? 'bg-green-600' : 'bg-gray-600 opacity-50'} py-1 rounded-lg text-sm">
                                    üîß ${formatMoney(d.repairCost)} (${d.repairTime}—Å)
                                </button>
                                <button onclick="sellBroken(${i})" class="btn-action bg-red-600 px-2 py-1 rounded-lg text-sm">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                        </div>
                        
                        <h4 class="font-bold mt-4 mb-3">‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–º–æ–Ω—Ç–∞ (${gameState.repairingDevices.length})</h4>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
            `;
            
            if (gameState.repairingDevices.length === 0) {
                html += `<p class="text-gray-500 text-center py-2">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤</p>`;
            } else {
                gameState.repairingDevices.forEach((d, i) => {
                    const pct = Math.min(100, (d.progress / d.totalTime) * 100);
                    const remaining = Math.max(0, Math.ceil((d.totalTime - d.progress) / 1000));
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-sm">${d.name}</div>
                                <button onclick="cancelRepair(${i})" class="text-xs text-red-400 hover:text-red-300">‚úï</button>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div id="repair-progress-${i}" class="repair-progress bg-green-500 h-2 rounded-full" style="width: ${pct}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>‚Üí ${formatMoney(d.sellPrice)}</span>
                                <span id="repair-time-${i}">${remaining}—Å</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div>
                        
                        <h4 class="font-bold mt-4 mb-3">‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∂–µ (${gameState.repairedDevices.length})</h4>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
            `;
            
            if (gameState.repairedDevices.length === 0) {
                html += `<p class="text-gray-500 text-center py-2">–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤</p>`;
            } else {
                gameState.repairedDevices.forEach((d, i) => {
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-2 flex items-center justify-between">
                            <div class="text-sm">${d.name}</div>
                            <button onclick="sellRepaired(${i})" class="btn-action bg-green-600 px-2 py-1 rounded-lg text-xs">–ü—Ä–æ–¥–∞—Ç—å ${formatMoney(d.sellPrice)}</button>
                        </div>
                    `;
                });
            }
            
            html += `</div></div></div>
                <div class="mt-4 bg-gray-800/50 rounded-xl p-4">
                    <p class="text-gray-400 text-sm">üë∑ –†–µ–º–æ–Ω—Ç–Ω–∏–∫–æ–≤: ${gameState.employees.repairmen} | –û—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${gameState.totalRepaired}</p>
                </div>
            `;
            
            document.getElementById('tabContent').innerHTML = html;
        }

        function buyBrokenNew(i) {
            const d = currentBrokenOffers[i];
            if (!d) return;
            if (gameState.money < d.buyPrice) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            
            gameState.money -= d.buyPrice;
            gameState.brokenDevices.push({ 
                name: d.name, 
                repairCost: d.repairCost, 
                sellPrice: d.sellPrice, 
                repairTime: d.repairTime 
            });
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
            currentBrokenOffers.splice(i, 1);
            
            updateUI();
            renderRepair();
            
            const profit = d.sellPrice - d.buyPrice - d.repairCost;
            if (profit < 0) {
                notify(`üì¶ –ö—É–ø–ª–µ–Ω–æ: ${d.name} (‚ö†Ô∏è —É–±—ã—Ç–æ—á–Ω–æ–µ!)`, 'warning');
            } else {
                notify(`üì¶ –ö—É–ø–ª–µ–Ω–æ: ${d.name}`, 'success');
            }
        }
        
        function skipBrokenOffer(i) {
            currentBrokenOffers.splice(i, 1);
            renderRepair();
            notify('‚ùå –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ', 'info');
        }
        
        function refreshBrokenOffers() {
            currentBrokenOffers = generateBrokenDevices();
            renderRepair();
            notify('üîÑ –ù–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'info');
        }
        
        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function buyBroken(i, name, buyPrice, repairCost, sellPrice, repairTime) {
            if (gameState.money < buyPrice) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            gameState.money -= buyPrice;
            gameState.brokenDevices.push({ name, repairCost, sellPrice, repairTime });
            updateUI();
            renderRepair();
            notify(`üì¶ –ö—É–ø–ª–µ–Ω–æ: ${name}`, 'success');
        }

        function startRepair(i) {
            const d = gameState.brokenDevices[i];
            if (!d) return;
            if (gameState.employees.repairmen === 0) { notify('–ù–∞–π–º–∏—Ç–µ —Ä–µ–º–æ–Ω—Ç–Ω–∏–∫–æ–≤!', 'error'); return; }
            const maxConcurrent = Math.max(1, gameState.employees.repairmen);
            if (gameState.repairingDevices.length >= maxConcurrent) {
                notify(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ä–µ–º–æ–Ω—Ç–æ–≤: ${maxConcurrent}`, 'warning');
                return;
            }
            if (gameState.money < d.repairCost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            
            gameState.money -= d.repairCost;
            gameState.repairingDevices.push({
                name: d.name,
                sellPrice: d.sellPrice,
                progress: 0,
                totalTime: d.repairTime * 1000 // convert to ms
            });
            gameState.brokenDevices.splice(i, 1);
            updateUI();
            renderRepair();
            notify(`üîß –†–µ–º–æ–Ω—Ç –Ω–∞—á–∞—Ç: ${d.name}`, 'info');
        }

        function sellBroken(i) {
            const d = gameState.brokenDevices[i];
            const scrap = Math.floor(d.sellPrice * 0.05);
            gameState.money += scrap;
            gameState.brokenDevices.splice(i, 1);
            updateUI();
            renderRepair();
            notify(`‚ôªÔ∏è –ü—Ä–æ–¥–∞–Ω–æ –Ω–∞ –∑–∞–ø—á–∞—Å—Ç–∏: ${formatMoney(scrap)}`, 'info');
        }

        function cancelRepair(i) {
            const d = gameState.repairingDevices[i];
            if (!d) return;
            const refund = Math.floor(d.sellPrice * 0.1);
            gameState.money += refund;
            gameState.repairingDevices.splice(i, 1);
            updateUI();
            renderRepair();
            notify(`üõë –†–µ–º–æ–Ω—Ç –æ—Ç–º–µ–Ω—ë–Ω. –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è ${formatMoney(refund)}`, 'warning');
        }

        function sellRepaired(i) {
            const d = gameState.repairedDevices[i];
            if (!d) return;
            gameState.money += d.sellPrice;
            gameState.repairedDevices.splice(i, 1);
            updateUI();
            renderRepair();
            notify(`üí∞ –ü—Ä–æ–¥–∞–Ω–æ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞: ${formatMoney(d.sellPrice)}`, 'success');
        }

        // ==================== CONTRACTS ====================
        function renderContracts() {
            let html = `
                <h3 class="text-xl font-bold mb-4">üìú –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-3">üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h4>
                        <div class="space-y-2 max-h-80 overflow-y-auto">
            `;
            
            if (gameState.availableContracts.length === 0) {
                html += `<p class="text-gray-500 text-center py-4">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</p>`;
            } else {
                gameState.availableContracts.forEach((c, i) => {
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-3">
                            <div class="flex justify-between items-start mb-1">
                                <div class="font-bold">${c.supplier}</div>
                                <span class="text-xs bg-purple-600/50 px-2 py-1 rounded">${c.specialty}</span>
                            </div>
                            <div class="text-sm text-gray-400 mb-2">${c.description}</div>
                            <div class="flex justify-between items-center text-sm">
                                <div>
                                    <span class="text-green-400">–°–∫–∏–¥–∫–∞: ${Math.round(c.discount * 100)}%</span>
                                    <span class="text-gray-500 mx-2">|</span>
                                    <span class="text-blue-400">${c.duration} –¥–Ω–µ–π</span>
                                </div>
                                <button onclick="signContract(${i})" class="btn-action bg-blue-600 px-3 py-1 rounded-lg text-sm">
                                    ‚úçÔ∏è ${formatMoney(c.signCost)}
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-3">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã (${gameState.activeContracts.length})</h4>
                        <div class="space-y-2 max-h-80 overflow-y-auto">
            `;
            
            if (gameState.activeContracts.length === 0) {
                html += `<p class="text-gray-500 text-center py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</p>`;
            } else {
                gameState.activeContracts.forEach(c => {
                    html += `
                        <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold">${c.supplier}</div>
                                    <div class="text-sm text-gray-400">${c.description}</div>
                                </div>
                                <span class="text-xs bg-green-600/50 px-2 py-1 rounded">${c.specialty}</span>
                            </div>
                            <div class="flex justify-between mt-2 text-sm">
                                <span class="text-green-400">–°–∫–∏–¥–∫–∞: ${Math.round(c.discount * 100)}%</span>
                                <span class="text-blue-400">–û—Å—Ç–∞–ª–æ—Å—å: ${c.daysLeft} –¥–Ω.</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div></div></div>`;
            document.getElementById('tabContent').innerHTML = html;
        }

        function generateContracts() {
            gameState.availableContracts = [];
            const shuffled = CONTRACT_SUPPLIERS.sort(() => Math.random() - 0.5).slice(0, 5);
            shuffled.forEach(s => {
                const duration = 10 + Math.floor(Math.random() * 25);
                gameState.availableContracts.push({
                    supplier: s.name,
                    specialty: s.specialty,
                    description: s.description,
                    discount: s.discount + (Math.random() * 0.05),
                    duration: duration,
                    signCost: 3000 + Math.floor(Math.random() * 12000)
                });
            });
        }

        function signContract(i) {
            const c = gameState.availableContracts[i];
            if (gameState.money < c.signCost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            gameState.money -= c.signCost;
            c.daysLeft = c.duration;
            gameState.activeContracts.push(c);
            gameState.availableContracts.splice(i, 1);
            updateUI();
            renderContracts();
            notify(`‚úÖ –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å ${c.supplier} –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ ${c.duration} –¥–Ω–µ–π!`, 'success');
        }

        // ==================== R&D ====================
        function renderRnD() {
            let html = `<h3 class="text-xl font-bold mb-4">üî¨ R&D</h3>`;
            
            if (gameState.activeResearch.length > 0) {
                html += `<div class="bg-blue-900/30 border border-blue-700/50 rounded-xl p-4 mb-4">
                    <h4 class="font-bold mb-3">‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (${gameState.activeResearch.length})</h4>
                    <div class="space-y-2">`;
                
                gameState.activeResearch.forEach((task, idx) => {
                    const r = RESEARCH_TREE.find(x => x.id === task.id);
                    const pct = Math.round((task.progress / task.totalTime) * 100);
                    const remaining = Math.max(0, Math.ceil((task.totalTime - task.progress) / 1000));
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span>${r.name}</span>
                                <span class="text-blue-300">${remaining}s</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="repair-progress bg-blue-500 h-2 rounded-full" style="width: ${pct}%"></div>
                            </div>
                            <div class="text-[10px] text-gray-500 mt-1">‚è±Ô∏è ${r.seconds || 10}—Å –±–∞–∑–æ–≤–æ ‚Ä¢ x${getResearchSpeedBoost().toFixed(1)} —Å–∫–æ—Ä–æ—Å—Ç—å</div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            html += `<div class="grid md:grid-cols-2 gap-3">`;
            
            const maxTier = getMaxTier();
            const maxConcurrent = Math.max(1, Math.floor(gameState.employees.researchers / 2) + 1);
            const availableSlots = maxConcurrent - gameState.activeResearch.length;
            
            RESEARCH_TREE.forEach(r => {
                const done = gameState.researchedTech.includes(r.id);
                const active = gameState.activeResearch.some(t => t.id === r.id);
                const locked = r.unlockTier > maxTier;
                const canStart = !done && !active && !locked && availableSlots > 0 && gameState.money >= r.cost && gameState.employees.researchers > 0;
                
                let cls = 'bg-gray-700/50';
                if (done) cls = 'bg-green-900/30 border border-green-700/50';
                if (active) cls = 'bg-blue-900/30 border border-blue-700/50';
                if (locked) cls = 'bg-gray-800/50 opacity-50';
                
                html += `
                    <div class="component-card ${cls} rounded-xl p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold">${r.name}</h4>
                            ${done ? '<span class="text-green-400 text-xs">‚úÖ</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${r.effect}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-400 text-sm">${formatMoney(r.cost)}</span>
                            ${!done && !active && !locked ? `
                                <button onclick="startResearch('${r.id}')" class="btn-action ${canStart ? 'bg-purple-600' : 'bg-gray-600 opacity-50'} px-3 py-1 rounded-lg text-sm">
                                    üî¨ –ù–∞—á–∞—Ç—å
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>
                <p class="text-gray-400 text-sm mt-4">üë®‚Äçüî¨ –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π: ${gameState.employees.researchers} | –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: ${maxConcurrent} | –°–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤: ${Math.max(0, availableSlots)}</p>
            `;
            
            document.getElementById('tabContent').innerHTML = html;
        }

        function startResearch(id) {
            const r = RESEARCH_TREE.find(x => x.id === id);
            if (!r) return;
            if (gameState.employees.researchers === 0) { notify('–ù–∞–π–º–∏—Ç–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π!', 'error'); return; }
            const maxConcurrent = Math.max(1, Math.floor(gameState.employees.researchers / 2) + 1);
            if (gameState.activeResearch.length >= maxConcurrent) { notify('–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è!', 'error'); return; }
            if (gameState.money < r.cost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            
            gameState.money -= r.cost;
            const researcherSpeed = getResearchSpeedBoost();
            const baseSeconds = r.seconds || 10;
            const totalTime = Math.max(3000, Math.round((baseSeconds * 1000) / researcherSpeed));
            gameState.activeResearch.push({ id: r.id, progress: 0, totalTime });
            updateUI();
            renderRnD();
            notify(`üî¨ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ "${r.name}" –Ω–∞—á–∞—Ç–æ!`, 'success');
        }

        // ==================== MARKETING ====================
        function renderMarketing() {
            const campaigns = [
                { name: '–¢–∞—Ä–≥–µ—Ç VK', cost: 2000, awareness: 5, duration: 3 },
                { name: 'YouTube —Ä–µ–∫–ª–∞–º–∞', cost: 8000, awareness: 15, duration: 5 },
                { name: '–¢–í —Ä–µ–∫–ª–∞–º–∞', cost: 25000, awareness: 30, duration: 7 },
                { name: '–ë–ª–æ–≥–µ—Ä—ã', cost: 12000, awareness: 20, duration: 4 },
                { name: 'Telegram Ads', cost: 5000, awareness: 10, duration: 4 },
                { name: '–ë–∏–ª–±–æ—Ä–¥—ã', cost: 15000, awareness: 18, duration: 10 }
            ];
            
            let html = `
                <h3 class="text-xl font-bold mb-4">üì¢ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</h3>
                <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between">
                        <span>–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å –±—Ä–µ–Ω–¥–∞:</span>
                        <span class="text-blue-400 font-bold">${gameState.brandAwareness}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(100, gameState.brandAwareness)}%"></div>
                    </div>
                    <p class="text-gray-500 text-xs mt-2">–ë–æ–Ω—É—Å –æ—Ç –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤: <span class="text-blue-400">x${getMarketingBoost().toFixed(2)}</span></p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-3 mb-4">
            `;
            
            campaigns.forEach(c => {
                const can = gameState.money >= c.cost && gameState.employees.marketers > 0;
                html += `
                    <div class="bg-gray-700/50 rounded-xl p-4">
                        <h4 class="font-bold">${c.name}</h4>
                        <p class="text-sm text-gray-400">+${c.awareness}% –∑–∞ ${c.duration} –¥–Ω–µ–π</p>
                        <button onclick="startCampaign('${c.name}', ${c.cost}, ${c.awareness}, ${c.duration})" 
                            class="btn-action mt-2 ${can ? 'bg-purple-600' : 'bg-gray-600 opacity-50'} px-4 py-2 rounded-lg text-sm w-full">
                            ${formatMoney(c.cost)}
                        </button>
                    </div>
                `;
            });
            
            html += `</div>
                <h4 class="font-bold mb-2">üìÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</h4>
                <div class="bg-gray-800/50 rounded-xl p-4">
            `;
            
            if (gameState.marketingCampaigns.length === 0) {
                html += `<p class="text-gray-500 text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π</p>`;
            } else {
                gameState.marketingCampaigns.forEach(c => {
                    html += `<div class="flex justify-between py-1"><span>${c.name}</span><span class="text-blue-400">${c.daysLeft} –¥–Ω.</span></div>`;
                });
            }
            
            html += `</div>
                <p class="text-gray-400 text-sm mt-4">üìä –ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤: ${gameState.employees.marketers}</p>
            `;
            
            document.getElementById('tabContent').innerHTML = html;
        }

        function startCampaign(name, cost, awareness, duration) {
            if (gameState.employees.marketers === 0) { notify('–ù–∞–π–º–∏—Ç–µ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤!', 'error'); return; }
            if (gameState.money < cost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            
            gameState.money -= cost;
            gameState.marketingCampaigns.push({ name, awareness, daysLeft: duration });
            updateUI();
            renderMarketing();
            notify(`üì¢ –ö–∞–º–ø–∞–Ω–∏—è "${name}" –∑–∞–ø—É—â–µ–Ω–∞!`, 'success');
        }

        function updateMarketingCampaigns() {
            const boost = getMarketingBoost();
            gameState.marketingCampaigns = gameState.marketingCampaigns.filter(c => {
                c.daysLeft -= boost;
                if (c.daysLeft <= 0) {
                    gameState.brandAwareness = Math.min(100, gameState.brandAwareness + c.awareness);
                    notify(`üì¢ "${c.name}" –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +${c.awareness}%`, 'success');
                    return false;
                }
                return true;
            });
        }

        // ==================== STAFF ====================
        function renderStaff() {
            const types = [
                { key: 'engineers', name: '–ò–Ω–∂–µ–Ω–µ—Ä—ã', salary: 800, desc: '–£—Å–∫–æ—Ä—è—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', limit: STAFF_LIMITS.engineers },
                { key: 'marketers', name: '–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∏', salary: 600, desc: '–£—Å–∫–æ—Ä—è—é—Ç —ç—Ñ—Ñ–µ–∫—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞', limit: STAFF_LIMITS.marketers },
                { key: 'repairmen', name: '–†–µ–º–æ–Ω—Ç–Ω–∏–∫–∏', salary: 500, desc: '–£—Å–∫–æ—Ä—è—é—Ç —Ä–µ–º–æ–Ω—Ç', limit: STAFF_LIMITS.repairmen },
                { key: 'researchers', name: '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏', salary: 1000, desc: '–£—Å–∫–æ—Ä—è—é—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è', limit: STAFF_LIMITS.researchers }
            ];
            
            let totalSalary = 0;
            types.forEach(t => totalSalary += gameState.employees[t.key] * t.salary);
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞
            const daysUntilPayday = 30 - (gameState.day % 30);
            
            let html = `
                <h3 class="text-xl font-bold mb-4">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h3>
                <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span>üí∞ –ó–∞—Ä–ø–ª–∞—Ç—ã –≤ –º–µ—Å—è—Ü: </span>
                            <span class="font-bold text-yellow-400">${formatMoney(totalSalary)}</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            –î–æ –≤—ã–ø–ª–∞—Ç—ã: <span class="text-blue-400">${daysUntilPayday} –¥–Ω–µ–π</span>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
            `;
            
            types.forEach(t => {
                const count = gameState.employees[t.key];
                const hireCost = t.salary * 2;
                const limitReached = count >= t.limit;
                html += `
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold">${t.name}</h4>
                            <span class="text-xs text-gray-500">–õ–∏–º–∏—Ç: ${count}/${t.limit}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${t.desc}</p>
                        <p class="mb-2">–ù–∞–Ω—è—Ç–æ: <span class="text-blue-400 font-bold">${count}</span> | ${formatMoney(t.salary)}/–º–µ—Å</p>
                        <div class="flex gap-2">
                            <button onclick="hireStaff('${t.key}', ${hireCost})" class="btn-action flex-1 ${limitReached ? 'bg-gray-600 opacity-50' : 'bg-green-600'} py-2 rounded-lg text-sm" ${limitReached ? 'disabled' : ''}>
                                ‚ûï ${formatMoney(hireCost)}
                            </button>
                            <button onclick="fireStaff('${t.key}')" class="btn-action bg-red-600 px-4 py-2 rounded-lg text-sm ${count === 0 ? 'opacity-50' : ''}">‚ûñ</button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            document.getElementById('tabContent').innerHTML = html;
        }

        function hireStaff(key, cost) {
            if (gameState.employees[key] >= STAFF_LIMITS[key]) {
                notify('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∞!', 'warning');
                return;
            }
            if (gameState.money < cost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            gameState.money -= cost;
            gameState.employees[key]++;
            updateUI();
            renderStaff();
            notify('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–∞–Ω—è—Ç!', 'success');
        }

        function fireStaff(key) {
            if (gameState.employees[key] <= 0) return;
            gameState.employees[key]--;
            updateUI();
            renderStaff();
            notify('üëã –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–≤–æ–ª–µ–Ω', 'info');
        }

        // ==================== MARKET ====================
        function renderMarket() {
            let html = `
                <h3 class="text-xl font-bold mb-4">üõí –ü—Ä–æ–¥–∞–∂–∏</h3>
                <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
                    <h4 class="font-bold mb-2">üìä –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–∞–∂ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h4>
                    <p class="text-gray-400 text-sm mb-2">–í—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç <span class="text-yellow-400">–º–∞—Ä–∂–∏</span>:</p>
                    <div class="grid grid-cols-4 gap-1 text-[10px]">
                        <div class="bg-green-900/30 rounded p-1 text-center">
                            <div class="text-green-400 font-bold">100%</div>
                            <div class="text-gray-400">~8—Å</div>
                        </div>
                        <div class="bg-yellow-900/30 rounded p-1 text-center">
                            <div class="text-yellow-400 font-bold">150%</div>
                            <div class="text-gray-400">~25—Å</div>
                        </div>
                        <div class="bg-orange-900/30 rounded p-1 text-center">
                            <div class="text-orange-400 font-bold">200%</div>
                            <div class="text-gray-400">~55—Å</div>
                        </div>
                        <div class="bg-red-900/30 rounded p-1 text-center">
                            <div class="text-red-400 font-bold">300%</div>
                            <div class="text-gray-400">~150—Å+</div>
                        </div>
                    </div>
                    <p class="text-gray-500 text-xs mt-2">–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å –±—Ä–µ–Ω–¥–∞: <span class="text-blue-400">${gameState.brandAwareness}%</span> ‚Äî —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–¥–∞–∂–∏</p>
                </div>
            `;
            
            // Active sales with progress bars
            if (gameState.sellingProducts && gameState.sellingProducts.length > 0) {
                html += `
                    <div class="bg-purple-900/30 border border-purple-700/50 rounded-xl p-4 mb-4">
                        <h4 class="font-bold mb-3">‚è≥ –ü—Ä–æ–¥–∞—ë—Ç—Å—è —Å–µ–π—á–∞—Å (${gameState.sellingProducts.length})</h4>
                        <div class="space-y-2">
                `;
                
                gameState.sellingProducts.forEach((sp, i) => {
                    const pct = Math.min(100, (sp.progress / sp.totalTime) * 100);
                    const remaining = Math.ceil((sp.totalTime - sp.progress) / 1000);
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span>${sp.name} x${sp.count.toLocaleString()}</span>
                                <span id="sales-time-${i}" class="text-purple-400">${remaining}—Å</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div id="sales-progress-${i}" class="repair-progress bg-purple-500 h-2 rounded-full" style="width: ${pct}%"></div>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">‚Üí ${formatMoney(sp.count * sp.price)}</div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            if (gameState.products.length === 0) {
                html += `
                    <div class="bg-gray-800/50 rounded-xl p-8 text-center">
                        <div class="text-4xl mb-3">üì≠</div>
                        <p class="text-gray-400">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</p>
                    </div>
                `;
            } else {
                html += `<div class="space-y-4">`;
                
                gameState.products.forEach((p, i) => {
                    const count = p.count || 1;
                    const recommendedPrice = p.quality * 5;
                    const margin = p.sellPrice / recommendedPrice;
                    const marginPct = Math.round(margin * 100);
                    
                    // Estimate time
                    const baseTime = 7000;
                    const marginMultiplier = Math.pow(margin, 3.1);
                    const awarenessMultiplier = Math.max(0.25, 1 - (gameState.brandAwareness / 150));
                    const estTime = Math.round(baseTime * marginMultiplier * awarenessMultiplier * (1 + Math.log10(count) * 0.55)) / 1000;
                    
                    let marginColor = 'text-green-400';
                    let marginStatus = '–ë—ã—Å—Ç—Ä–æ';
                    if (marginPct > 200) { marginColor = 'text-red-400'; marginStatus = '–û—á–µ–Ω—å –¥–æ–ª–≥–æ'; }
                    else if (marginPct > 150) { marginColor = 'text-orange-400'; marginStatus = '–î–æ–ª–≥–æ'; }
                    else if (marginPct > 100) { marginColor = 'text-yellow-400'; marginStatus = '–°—Ä–µ–¥–Ω–µ'; }
                    
                    html += `
                        <div class="bg-gray-800/50 rounded-xl p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold">${p.name}</h4>
                                    <p class="text-sm text-gray-400">–ö–∞—á–µ—Å—Ç–≤–æ: ‚≠ê${p.quality} | –†–µ–∫. —Ü–µ–Ω–∞: ${formatMoney(recommendedPrice)}</p>
                                </div>
                                <span class="bg-blue-600 px-3 py-1 rounded-lg">${count.toLocaleString()} —à—Ç</span>
                            </div>
                            <div class="mb-3 bg-gray-700/50 rounded-lg p-3">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏:</span>
                                    <span class="font-bold">${formatMoney(p.sellPrice)}</span>
                                </div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>–ú–∞—Ä–∂–∞:</span>
                                    <span class="${marginColor} font-bold">${marginPct}%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>–í—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏:</span>
                                    <span class="${marginColor}">${marginStatus} (~${estTime.toFixed(1)}—Å)</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="range" id="sellQty${i}" min="1" max="${count}" value="${count}" 
                                    class="flex-1" oninput="document.getElementById('sellQtyLabel${i}').textContent=this.value">
                                <span id="sellQtyLabel${i}" class="text-blue-400 font-bold w-16 text-right">${count}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="startSelling(${i}, parseInt(document.getElementById('sellQty${i}').value))" 
                                    class="btn-action flex-1 bg-green-600 py-2 rounded-lg text-sm font-bold">
                                    üí∞ –ü—Ä–æ–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                                </button>
                                <button onclick="startSelling(${i}, ${count})" 
                                    class="btn-action bg-purple-600 px-4 py-2 rounded-lg text-sm font-bold">
                                    –í—Å–µ
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `
                <div class="mt-4 bg-gray-800/50 rounded-xl p-4">
                    <p class="text-gray-400">üìà –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂: ${formatMoney(gameState.totalSales)}</p>
                </div>
            `;
            
            document.getElementById('tabContent').innerHTML = html;
        }

        // ==================== WAREHOUSE ====================
        function renderWarehouse() {
            let totalProducts = 0;
            gameState.products.forEach(p => totalProducts += (p.count || 1));
            
            let html = `
                <h3 class="text-xl font-bold mb-4">üì¶ –°–∫–ª–∞–¥</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-3">–ì–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è (${totalProducts.toLocaleString()})</h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
            `;
            
            if (gameState.products.length === 0) {
                html += `<p class="text-gray-500 text-center py-4">–ü—É—Å—Ç–æ</p>`;
            } else {
                gameState.products.forEach(p => {
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-2 flex justify-between">
                            <span class="truncate">${p.name}</span>
                            <span class="text-blue-400">${(p.count || 1).toLocaleString()}</span>
                        </div>
                    `;
                });
            }
            
            html += `
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-3">üì¶ –°–∫–ª–∞–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</h4>
                        <div class="flex flex-wrap gap-1 mb-3 overflow-x-auto">
            `;
            
            Object.entries(COMPONENT_CATEGORIES).forEach(([key, cat]) => {
                const isActive = currentWarehouseCategory === key;
                html += `
                    <button onclick="switchWarehouseCategory('${key}')" 
                        class="device-tab btn-action ${isActive ? 'active bg-blue-600' : 'bg-gray-700'} px-2 py-1.5 rounded-lg text-[10px] font-medium whitespace-nowrap flex-shrink-0">
                        ${cat.name}
                    </button>
                `;
            });

            html += `</div>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
            `;

            const inventoryItems = Object.entries(gameState.inventory).filter(([k, v]) => {
                if (v <= 0) return false;
                const [type] = k.split(':');
                return COMPONENTS[type]?.category === currentWarehouseCategory;
            });

            if (inventoryItems.length === 0) {
                html += `<p class="text-gray-500 text-center py-4">–ü—É—Å—Ç–æ</p>`;
            } else {
                inventoryItems.forEach(([key, qty], i) => {
                    const idx = i;
                    const [type, rawName] = key.split(':');
                    const name = rawName;
                    const compData = COMPONENTS[type];

                    const baseItem = compData?.items?.find(item => normalizeCompName(item.name) === normalizeCompName(name));
                    const customRef = (gameState.customComponents || []).find(c => c.compType === type && normalizeCompName(c.name) === normalizeCompName(name));

                    let basePrice = baseItem?.price;
                    if (basePrice == null) basePrice = customRef?.price ?? 0;

                    const tier = Number(baseItem?.tier ?? customRef?.tier ?? 1);
                    const sellPrice = Math.max(1, Math.round(Number(basePrice || 0) * 0.6));

                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-2 overflow-hidden">
                            <div class="flex items-start justify-between gap-2">
                                <div class="min-w-0 flex-1">
                                    <div class="text-xs whitespace-normal break-words leading-snug">${escapeHtml(name)}</div>
                                    <div class="text-[10px] text-gray-400">${escapeHtml(compData?.name || '')} ‚Ä¢ ${escapeHtml(getTierName(tier))} ‚Ä¢ ${formatMoney(sellPrice)} / —à—Ç</div>
                                </div>
                                <div class="text-blue-400 font-bold text-xs flex-shrink-0">${qty.toLocaleString()} —à—Ç</div>
                            </div>

                            <div class="mt-2 flex flex-wrap items-center gap-2">
                                <input 
                                    type="range" 
                                    id="sellCompQty_${idx}" 
                                    min="1" 
                                    max="${qty}" 
                                    value="${qty}"
                                    data-unit="${sellPrice}"
                                    class="flex-1 min-w-[160px]"
                                    oninput="updateSellCompLine(${idx})">

                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span id="sellCompQtyLabel_${idx}" class="text-blue-300 font-bold text-xs w-14 text-right">${qty.toLocaleString()}</span>
                                    <span class="text-gray-400 text-[10px]">=</span>
                                    <span id="sellCompTotal_${idx}" class="text-yellow-300 font-bold text-xs">${formatMoney(sellPrice * qty)}</span>
                                    <button 
                                        data-comp-type="${escapeAttr(type)}"
                                        data-name="${escapeAttr(name)}"
                                        data-idx="${idx}"
                                        onclick="sellCompFromEl(this)" 
                                        class="btn-action bg-red-600 px-2 py-1 rounded-lg text-[10px] whitespace-nowrap">
                                        –ü—Ä–æ–¥–∞—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tabContent').innerHTML = html;
            // Ensure totals are shown correctly right after render
            try {
                for (let i = 0; i < inventoryItems.length; i++) updateSellCompLine(i);
            } catch (e) {}
        }

        // ==================== SETTINGS ====================
        function renderSettings() {
            const isDark = !!gameState.darkTheme;
            let html = `
                <h3 class="text-xl font-bold mb-4">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-2">üé® –¢–µ–º–∞</h4>
                        <p class="text-sm text-gray-400 mb-3">–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</p>
                        <div class="flex items-center justify-between bg-gray-700/40 rounded-xl p-3">
                            <div class="text-sm">
                                <div class="font-bold">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
                                <div class="text-xs text-gray-400">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–∞</div>
                            </div>
                            <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" class="hidden" ${isDark ? 'checked' : ''} onchange="setDarkTheme(this.checked)">
                                <span class="w-12 h-7 rounded-full bg-gray-600 relative">
                                    <span class="absolute top-1 left-1 w-5 h-5 rounded-full bg-white transition-all" style="transform: translateX(${isDark ? '20px' : '0px'});"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <h4 class="font-bold mb-2">üóëÔ∏è –ü—Ä–æ–≥—Ä–µ—Å—Å</h4>
                        <p class="text-sm text-gray-400 mb-3">–°–±—Ä–æ—Å–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –Ω–∞—á–Ω—ë—Ç –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ.</p>
                        <button onclick="resetGame()" class="btn-action bg-red-600 px-4 py-2 rounded-lg w-full">
                            –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                        </button>
                    </div>
                </div>
                <div class="mt-3 text-center text-xs text-gray-500">
                    –ê–≤—Ç–æ—Ä –∏–≥—Ä—ã: <span class="font-bold">tr1xx</span>
                </div>
            `;

            document.getElementById('tabContent').innerHTML = html;
        }

        function setDarkTheme(isDark) {
            gameState.darkTheme = !!isDark;
            applyTheme();
            saveGame();
            // re-render settings if opened
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab?.dataset.tab === 'settings') renderSettings();
        }

        function applyTheme() {
            const body = document.body;
            if (!gameState.darkTheme) {
                body.classList.add('light-theme');
                body.classList.remove('telegram-bg');
            } else {
                body.classList.remove('light-theme');
                body.classList.add('telegram-bg');
            }
        }

        function upgradeFactory() {
            const cost = 15000 * Math.pow(2, gameState.factoryLevel - 1);
            if (gameState.money < cost) { notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!', 'error'); return; }
            gameState.money -= cost;
            gameState.factoryLevel++;
            gameState.productionCapacity += 5000;
            updateUI();
            renderWarehouse();
            notify(`üè≠ –ó–∞–≤–æ–¥ —É–ª—É—á—à–µ–Ω! –ú–æ—â–Ω–æ—Å—Ç—å: ${gameState.productionCapacity.toLocaleString()}`, 'success');
        }

        // ==================== FACTORY HELPERS ====================
        function getFactoryCostReduction() {
            const level = gameState.factoryLevel;
            const baseReduction = COMPONENTS.COMPONENT_FACTORY_COST_REDUCTION_PER_LEVEL;
            const diminishing = 1 / (1 + (level - 1) * 0.45);
            const reduction = baseReduction * level * diminishing;
            return Math.min(0.65, Math.max(0, reduction));
        }

        function getFactoryMaxQuality(compType = null) {
            const base = COMPONENTS.COMPONENT_FACTORY_MAX_QUALITY_BASE + (gameState.factoryLevel * COMPONENTS.COMPONENT_FACTORY_QUALITY_PER_LEVEL);
            const perTypeLimit = compType && COMPONENTS.COMPONENT_FACTORY_QUALITY_LIMITS[compType] ? COMPONENTS.COMPONENT_FACTORY_QUALITY_LIMITS[compType] : base;
            return Math.round(base + perTypeLimit);
        }

        function calculateFactoryCost(quality, compType = null) {
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–∏–Ω–µ–π–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ + –ø–ª–∞–≤–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ
            // –£—Ä–æ–≤–µ–Ω—å —Ñ–∞–±—Ä–∏–∫–∏ —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å
            
            const level = gameState.factoryLevel || 1;
            
            // –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç—å)
            const baseCost = 8;
            
            // –ü—Ä–∏—Ä–æ—Å—Ç –∑–∞ –∫–∞–∂–¥—É—é –µ–¥–∏–Ω–∏—Ü—É –∫–∞—á–µ—Å—Ç–≤–∞ (–æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π, –ª–∏–Ω–µ–π–Ω—ã–π)
            const costPerQuality = 0.4;
            
            // –°–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å —É—Ä–æ–≤–Ω–µ–º —Ñ–∞–±—Ä–∏–∫–∏ (–æ—Ç 0% –¥–æ 60%)
            const levelDiscount = Math.min(0.6, (level - 1) * 0.1);
            
            // –õ–∏–Ω–µ–π–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
            let cost = baseCost + (quality * costPerQuality);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –æ—Ç —É—Ä–æ–≤–Ω—è —Ñ–∞–±—Ä–∏–∫–∏
            cost = cost * (1 - levelDiscount);
            
            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º: –Ω–∞ –ø–µ—Ä–≤—ã—Ö —É—Ä–æ–≤–Ω—è—Ö –¥–æ—Ä–æ–∂–µ, –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö ‚Äî –¥–µ—à–µ–≤–ª–µ
            const marketReference = getMarketReferenceCost(compType, quality);
            if (marketReference > 0) {
                // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è: 1‚Üí1.5x, 2‚Üí1.3x, 3‚Üí1.1x, 4‚Üí0.9x, 5‚Üí0.7x, 6‚Üí0.5x, 7+‚Üí0.4x
                let marketMultiplier = 1.5 - (level - 1) * 0.2;
                marketMultiplier = Math.max(0.4, Math.min(1.5, marketMultiplier));
                
                const marketCost = marketReference * marketMultiplier;
                
                // –ë–µ—Ä—ë–º —Å—Ä–µ–¥–Ω–µ–µ –º–µ–∂–¥—É –ª–∏–Ω–µ–π–Ω–æ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é –∏ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–æ–π
                // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                cost = (cost + marketCost) / 2;
            }
            
            return Math.max(1, Math.round(cost));
        }

        function getMarketReferenceCost(compType, quality) {
            const items = COMPONENTS[compType]?.items || [];
            if (items.length === 0) return 0;
            const sorted = [...items].sort((a, b) => a.quality - b.quality);
            const closest = sorted.reduce((prev, curr) => {
                return Math.abs(curr.quality - quality) < Math.abs(prev.quality - quality) ? curr : prev;
            }, sorted[0]);
            return closest?.price || 0;
        }

        function updateFactoryCostPreviews() {
            const mobileQuality = parseInt(document.getElementById('mobileCompQuality')?.value || 0);
            const desktopQuality = parseInt(document.getElementById('desktopCompQuality')?.value || 0);
            const mobileQty = Math.max(1, parseInt(document.getElementById('mobileCompQty')?.value || 1));
            const desktopQty = Math.max(1, parseInt(document.getElementById('desktopCompQty')?.value || 1));
            const mobileType = document.getElementById('mobileCompType')?.value || null;
            const desktopType = document.getElementById('desktopCompType')?.value || null;

            const mobileMaxQ = getFactoryMaxQuality(mobileType);
            const desktopMaxQ = getFactoryMaxQuality(desktopType);

            const mobileUnitCost = mobileQuality > 0 ? calculateFactoryCost(mobileQuality, mobileType) : 0;
            const desktopUnitCost = desktopQuality > 0 ? calculateFactoryCost(desktopQuality, desktopType) : 0;
            const mobileCost = mobileUnitCost * mobileQty;
            const desktopCost = desktopUnitCost * desktopQty;

            const mobileCostEl = document.getElementById('mobileCompCost');
            const desktopCostEl = document.getElementById('desktopCompCost');
            const mobileUnitEl = document.getElementById('mobileCompUnitCost');
            const desktopUnitEl = document.getElementById('desktopCompUnitCost');
            const mobileMaxEl = document.getElementById('mobileCompMaxQ');
            const desktopMaxEl = document.getElementById('desktopCompMaxQ');

            if (mobileCostEl) mobileCostEl.textContent = formatMoney(mobileCost);
            if (desktopCostEl) desktopCostEl.textContent = formatMoney(desktopCost);
            if (mobileUnitEl) mobileUnitEl.textContent = formatMoney(mobileUnitCost);
            if (desktopUnitEl) desktopUnitEl.textContent = formatMoney(desktopUnitCost);
            if (mobileMaxEl) mobileMaxEl.textContent = mobileMaxQ;
            if (desktopMaxEl) desktopMaxEl.textContent = desktopMaxQ;
        }

        // ==================== GAME LOOP ====================
        function nextDay() {
            gameState.day++;
            
            // Monthly Salaries (every 30 days)
            if (gameState.day % 30 === 0) {
                let salary = 0;
                salary += gameState.employees.engineers * 800;
                salary += gameState.employees.marketers * 600;
                salary += gameState.employees.repairmen * 500;
                salary += gameState.employees.researchers * 1000;
                gameState.money -= salary;
                if (salary > 0) notify(`üí∏ –ú–µ—Å—è—á–Ω—ã–µ –∑–∞—Ä–ø–ª–∞—Ç—ã: ${formatMoney(salary)}`, 'info');
            }
            
            // Contracts
            gameState.activeContracts = gameState.activeContracts.filter(c => {
                c.daysLeft--;
                if (c.daysLeft <= 0) { notify(`üìú –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å ${c.supplier} –∏—Å—Ç—ë–∫`, 'warning'); return false; }
                return true;
            });
            if (Math.random() < 0.3) generateContracts();
            
            // R&D
            if (gameState.currentResearch) {
                const speed = 1 + gameState.employees.researchers * 0.2;
                gameState.researchProgress += speed;
                const r = RESEARCH_TREE.find(x => x.id === gameState.currentResearch);
                if (gameState.researchProgress >= r.days) {
                    gameState.researchedTech.push(gameState.currentResearch);
                    gameState.currentResearch = null;
                    gameState.researchProgress = 0;
                    notify(`üéâ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ "${r.name}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ!`, 'success');
                }
            }
            
            // Marketing
            if (gameState.marketingCampaigns.length > 0) {
                updateMarketingCampaigns();
            }
            
            // Auto-sales based on margin
            // –ß–µ–º –≤—ã—à–µ –º–∞—Ä–∂–∞ - —Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è
            let autoSold = 0, autoRev = 0;
            gameState.products.forEach(p => {
                const count = p.count || 1;
                const recommendedPrice = p.quality * 5;
                const margin = p.sellPrice / recommendedPrice;
                
                // –§–æ—Ä–º—É–ª–∞: –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å √ó —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å √ó (1/–º–∞—Ä–∂–∞¬≤)
                const baseRate = gameState.brandAwareness / 100;
                const marginMultiplier = Math.max(0.01, 1 / Math.pow(margin, 2));
                const dailySellRate = baseRate * marginMultiplier * 0.25;
                const toSell = Math.max(1, Math.floor(count * dailySellRate));
                
                if (toSell > 0 && count > 0) {
                    const sold = Math.min(toSell, count);
                    autoSold += sold;
                    autoRev += sold * p.sellPrice;
                    p.count = count - sold;
                }
            });
            
            gameState.products = gameState.products.filter(p => (p.count || 1) > 0);
            
            if (autoSold > 0) {
                gameState.money += autoRev;
                gameState.totalSales += autoRev;
                notify(`üõí –ê–≤—Ç–æ–ø—Ä–æ–¥–∞–∂–∏: ${autoSold.toLocaleString()} = ${formatMoney(autoRev)}`, 'success');
            }
            
            // Brand decay
            gameState.brandAwareness = Math.max(5, gameState.brandAwareness - 0.5);
            
            // Bankruptcy
            if (gameState.money < -50000) {
                notify('üíÄ –ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ!', 'error');
                if (confirm('–ö–æ–º–ø–∞–Ω–∏—è –æ–±–∞–Ω–∫—Ä–æ—Ç–∏–ª–∞—Å—å! –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) resetGame();
                return;
            }
            
            checkLevelUp();
            updateUI();
            
            const activeTab = document.querySelector('.tab-btn.bg-blue-600');
            if (activeTab) showTab(activeTab.dataset.tab);
        }

        function checkLevelUp() {
            const needed = gameState.level * 500;
            if (gameState.experience >= needed) {
                gameState.level++;
                gameState.experience -= needed;
                gameState.reputation += 5;
                notify(`üéâ –£—Ä–æ–≤–µ–Ω—å ${gameState.level}!`, 'success');
            }
        }

        init();
    </script>
</body>
</html>
